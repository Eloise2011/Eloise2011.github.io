<!DOCTYPE html>
<html lang="en">
<meta name="referrer" content="no-referrer"/>
<head>

<!-- 爆炸效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>


  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"52zhongneng.cn","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="More than 80% of all Fortune 100 companies trust, and use Kafka.Apache Kafka is an open-source distributed event streaming platform used by thousands of companies for high-performance data pipelines,">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka">
<meta property="og:url" content="https://52zhongneng.cn/2020/10/28/Kafka/index.html">
<meta property="og:site_name" content="Eloise&#39;s Paradise">
<meta property="og:description" content="More than 80% of all Fortune 100 companies trust, and use Kafka.Apache Kafka is an open-source distributed event streaming platform used by thousands of companies for high-performance data pipelines,">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/top10.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at15.44.37.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at15.49.39.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at16.05.15.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at16.27.51.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at16.38.40.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at16.50.48.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at17.00.43.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at17.21.49.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at17.36.56.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at17.42.48.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%89%E5%BA%8F%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E5%88%86%E5%8C%BA%E7%9A%84%E4%BA%8B%E4%BB%B6.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E5%89%AF%E6%9C%AC%E7%B2%92%E5%BA%A6%E5%88%B0%E4%B8%BB%E9%A2%98%E5%88%86%E5%8C%BA%E7%9A%84%E5%9B%BE%E5%BD%A2%E8%A7%A3%E9%87%8A.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E5%9F%9F%E5%90%8DIP%E6%98%A0%E5%B0%84.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/JDK%E9%85%8D%E7%BD%AE%E5%B9%B6%E6%A3%80%E6%9F%A5.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/myid.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/zookeeper%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/kafka%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/kafka%E8%84%9A%E6%9C%AC%E6%9F%A5%E7%9C%8B.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/kafka%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B%E6%88%90%E5%8A%9F%E4%B8%8E%E5%90%A6.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.03.03.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.34.05.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.05.12.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.08.19.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.11.34.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.27.52.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.40.04.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.44.24.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.52.54.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at22.48.23.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.26.00.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.31.37.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.32.24.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.35.56.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.36.27.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.36.52.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.41.46.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.41.59.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.43.59.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at21.44.36.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BDMySQL%E5%AE%89%E8%A3%85tar%E5%8C%85.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/MySQL%E5%AE%89%E8%A3%85%E5%8C%85%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E8%BF%87MySQL.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/kafkaeagle%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/kafkaeagle%E7%99%BB%E5%BD%95%E9%A1%B5.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at12.36.06.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at23.54.51.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at12.52.02.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.17.58.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.19.25.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.13.59.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.14.07.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.27.22.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at13.34.36.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at14.25.27.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at14.36.34.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at14.34.43.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at14.42.12.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at15.37.18.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at15.37.26.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at15.37.35.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at15.52.03.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at15.52.33.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at19.14.14.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at19.14.24.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E6%96%B0%E5%BB%BAtopicA.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/consumer1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/consumer2%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/consumer1%E5%92%8C2%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-11at15.33.04.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%90%8E.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_1.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_2.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_3.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E9%87%8D%E8%AF%953%E6%AC%A1.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%AD%94%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at23.24.11.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at23.32.56.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at23.33.12.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/28/Kafka/Screenshot2022-05-12at23.40.15.png">
<meta property="article:published_time" content="2020-10-28T00:56:31.000Z">
<meta property="article:modified_time" content="2022-06-24T13:08:47.648Z">
<meta property="article:author" content="Brooks.H.Joshua">
<meta property="article:tag" content="Kafka">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://52zhongneng.cn/2020/10/28/Kafka/top10.png">

<link rel="canonical" href="https://52zhongneng.cn/2020/10/28/Kafka/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Kafka | Eloise's Paradise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div id="id-header-inner"  class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eloise's Paradise</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">35</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">16</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">106</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>
	<!-- 改变css样式 -->
<script type="text/javascript">
var url = document.location.pathname;
var folderName = url.substr(1, url.length - 2)
console.log(folderName);

var listPostUrl = [
    "/" + folderName + "/" + "post-banner.png",
    "/" + folderName + "/" + "post-banner.jpg",
];

var nSuccessCount = 0;
var nResponceCount = 0;
function OnHttpResponse(bSuccess, strUrl) {
    console.log("OnHttpResponse: " + bSuccess + ", " + strUrl);
    nResponceCount++;
    if(nSuccessCount > 0){
        return;
    }
    if(bSuccess) {
        nSuccessCount++;
        document.getElementById("id-header-inner").style.backgroundImage = "url(" + strUrl + ")";
    }
    if(nResponceCount >= listPostUrl.length && nSuccessCount <= 0){
        // 使用默认图
        document.getElementById("id-header-inner").style.backgroundImage = "url(/images/background.jpg)";
    }
}

function changeBanner(strPostUrl, nIndex){
    console.log("try to load" + strPostUrl);
    var xmlhttp;
    if (window.XMLHttpRequest)
    {
        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
        xmlhttp=new XMLHttpRequest();
    }
    else
    {
        // IE6, IE5 浏览器执行代码
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
            OnHttpResponse(true, strPostUrl);
        } else {
            OnHttpResponse(false, strPostUrl);
        }
    }
    xmlhttp.open("HEAD",strPostUrl,true);
    xmlhttp.send();
}

listPostUrl.forEach(changeBanner);
</script>



    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://52zhongneng.cn/2020/10/28/Kafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kafka
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-28 08:56:31" itemprop="dateCreated datePublished" datetime="2020-10-28T08:56:31+08:00">2020-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-24 21:08:47" itemprop="dateModified" datetime="2022-06-24T21:08:47+08:00">2022-06-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MQ/" itemprop="url" rel="index">
                    <span itemprop="name">MQ</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>73k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1:07</span>
            </span>


           
          
          <div class="out-img-topic">
          <img src=/image/Kafka_top10.png class="img-topic">
          </div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>More than 80% of all Fortune 100 companies trust, and use <strong>Kafka</strong>.Apache Kafka is an <strong>open-source distributed event streaming platform</strong> used by thousands of companies for <strong>high-performance</strong> data pipelines, streaming analytics, data integration, and mission-critical applications. 相关代码GIT地址()</p>
<a id="more"></a>

<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p><img src="/2020/10/28/Kafka/top10.png" alt="Top10"></p>
<h3 id="业务场景介绍"><a href="#业务场景介绍" class="headerlink" title="业务场景介绍"></a>业务场景介绍</h3><h4 id="解藕"><a href="#解藕" class="headerlink" title="解藕"></a>解藕</h4><p>下图中上下分别为两种解决方案(姑且称上面的A， 下面的为B，B引入了MQ)，  如果用户注册成功后，往DB写入注册成功信息的过程出现故障，那么B可以隔一段时间后重新消费消息即可， 而A却不行。 所以解藕了</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at15.44.37.png" alt="业务1"></p>
<h4 id="异步通信"><a href="#异步通信" class="headerlink" title="异步通信"></a>异步通信</h4><p>同样是上面的例子， 从用户发起注册到收到注册成功的反馈信息， A用了60ms ， 而B只用了35ms。</p>
<h4 id="削峰填谷"><a href="#削峰填谷" class="headerlink" title="削峰填谷"></a>削峰填谷</h4><p>因为MQ的存在， 为流计算和DB提供了很好的缓冲， 降低了DB和计算压力。 <img src="/2020/10/28/Kafka/Screenshot2022-05-11at15.49.39.png" alt="削峰填谷"></p>
<p><strong>总结：</strong><span style="color:red"><strong>kafka作为一款出色的MQ中间件， 其最主要的应用场景就是解藕，异步通信，和削峰填谷</strong></span></p>
<h3 id="MQ工作模式"><a href="#MQ工作模式" class="headerlink" title="MQ工作模式"></a>MQ工作模式</h3><p>至多一次：（一般只被一个消费者消费，<strong>ActiveMQ</strong>）</p>
<pre><code>1. 生产者写入消息到服务器
1. 消费者去拉取消息消费
1. 一旦消费成功， 并收到确认信息Ack。 消息服务器会主动删除该条消息。</code></pre><p>没有限制：（可以有多个消费者， <strong>Kafka</strong>）</p>
<p>​    消息被消费后不会被删除， 而是当前消费者消费记录的offset。消息服务器可以长时间存储海量消息。</p>
<p>图解：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at16.05.15.png" alt="MQ工作模式"></p>
<h3 id="分发策略"><a href="#分发策略" class="headerlink" title="分发策略"></a>分发策略</h3><p>生产者按照消息key的hash模上分区数来决定向哪个分区写入。</p>
<p>broker-0 是 partition0的主节点Leader， broker-1和broker-2是partition0的副本节点 Follower。</p>
<p>当broker-0宕机时， zookeeper发现并通知其对应的副本节点重新选举出新的主节点。</p>
<p>![分发策略](Kafka/Screenshot 2022-05-11 at 16.13.23.png)</p>
<h3 id="分区-amp-日志"><a href="#分区-amp-日志" class="headerlink" title="分区&amp;日志"></a>分区&amp;日志</h3><p>只能保证分区内部的有序， 分区间无序。该特性也称之为<strong>局部FIFO</strong>。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at16.27.51.png" alt="分区和日志"></p>
<h3 id="offset"><a href="#offset" class="headerlink" title="offset"></a>offset</h3><p>在消费者消费topic中的数据的时候 每个消费者会维护本次消费对应分区的偏移量，消费者会在消费完一个批次的数据周， 会将本次消费的偏移量提交给Kafka集群，因为此对于每个消费者而言可以随意的控制该消费者的偏移量。 因此在Kafka中，消费者可以从一个topic分区中的任意位置读取队列数据，由于每个消费者控制了自己的消费偏移量。 因此多个消费者之间彼此相互独立。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at16.38.40.png" alt="offset多消费者相互独立"></p>
<h3 id="消费者和消费者组"><a href="#消费者和消费者组" class="headerlink" title="消费者和消费者组"></a>消费者和消费者组</h3><ol>
<li>每一个消费者Consumer必须隶属于一个消费者组ConsumerGroup。</li>
<li>同一消息分区里的消息， 会均分给同一消费者组下的不同消费者， 但是同时可以广播给多个消费者组。(例如P0分区不能同时被消费组A里的c1和c2消费， 但是可以被消费组A里的c1和消费组B里的c1消费)</li>
<li>假设消费者组2 有5个消费者， 当其中某一个消费者断链时， 则会重新进行均发。</li>
<li>从某种程度上讲， 分区数越大，Kafka并行度越高。</li>
</ol>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at16.50.48.png" alt="消费者和消费者组"> </p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at17.00.43.png" alt="消费者组2"></p>
<h3 id="高性能之道"><a href="#高性能之道" class="headerlink" title="高性能之道"></a>高性能之道</h3><p>Kafka的特性之一是高吞吐率(high throughput), 但是Kafka的消息是保存或缓存在磁盘上的。一般认为磁盘的读写数据是会降低性能的， 但是Kafka即使是普通的服务器，也可以轻松支持每秒百万级M/s的写入请求。超过了大部分的MQ中间件。 这也是Kafka被广泛应用的原因之一。写入磁盘是为了防止数据丢失。 而起性能高主要是因为采用了： 顺序写入和MMFile。</p>
<h4 id="顺序写入"><a href="#顺序写入" class="headerlink" title="顺序写入"></a>顺序写入</h4><p>因为硬盘是机械结构， 每次读写都会寻址–&gt;写入， 其中寻址是最耗时的操作， 所以硬盘最讨厌随机I/O， 喜欢顺序I/O。 为了提高读写硬盘的速度， Kafka就采用了顺序I/O。这样省去了大量的内存开销和寻址时间。但是丹村的顺序写入也不可能做到内存级别的I/O速度， 因此Kafka的数据并不是实时写到硬盘的。</p>
<h4 id="MMFile"><a href="#MMFile" class="headerlink" title="MMFile"></a>MMFile</h4><p>Kafka充分利用了现代操作系统分页存储来利用内存提高I/O效率。 Memory Mapped File(MMFile，内存映射文件) 在64位操作系统中一般表示20G的数据文件， 他的工作原理是直接利用操作系统Page实现文件到物理内存的直接映射， 完成MMP映射后， 用户对内存的所有操作会被操作系统自动刷新到磁盘上。极大降低了I/O 使用率。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at17.21.49.png" alt="Kafka高性能原理"></p>
<h4 id="零拷贝（ZeroCopy）"><a href="#零拷贝（ZeroCopy）" class="headerlink" title="零拷贝（ZeroCopy）"></a>零拷贝（ZeroCopy）</h4><p>Kafka服务器在响应客户端读取的时候， 底层使用了ZeroCopy技术。直接讲磁盘无需拷贝到用户空间， 而是直接讲数据通过内核空间传递输出， 数据并没有抵达用户空间。</p>
<p><strong>传统I/O：</strong></p>
<ol>
<li><p>用户进程调用read等系统调用向操作系统发起IO请求，请求读取数据到自己的内存缓冲区中。自己进入阻塞状态</p>
</li>
<li><p>操作系统收到请求后， 进一步将IO请求发送到磁盘。</p>
</li>
<li><p>磁盘驱动器收到内核的IO请求， 把数据从磁盘读取到驱动器的缓冲中，此时不占用CPU， 当驱动器的缓冲区被读满后向内核发起中段信号告知自己的缓冲区已满。</p>
</li>
<li><p>内核收到磁盘的中断信号， 使用CPU时间将磁盘驱动器的缓冲中的数据拷贝到内核缓冲区中。</p>
</li>
<li><p>如果内核缓冲区的数据少于用户请求读的数据， 重复3-4， 知道内核缓冲区中的数据足够多为止。</p>
</li>
<li><p>将数据从内核缓冲区拷贝到用户缓冲区， 同时从系统调用中返回， 完成任务。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at17.36.56.png" alt="传统IO流程"></p>
</li>
</ol>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at17.42.48.png" alt="DMA协处理器"></p>
<p>协处理器的引入降低了CPU的压力。</p>
<p>![零拷贝图解](Kafka/Screenshot 2022-05-11 at 17.40.50.png)</p>
<h3 id="What–-gt-何为事件流"><a href="#What–-gt-何为事件流" class="headerlink" title="What–&gt;何为事件流?"></a><font color="red">What</font>–&gt;何为事件流?</h3><p>事件流(<strong>Event Streming</strong>)是”数字化”的人体中枢神经系统. 是商业业务日益软件化和自动化的切持续不断运作的现实世界技术基础.<br>从技术上来说,事件流是以流式事件的方式从事件源(如数据库, 传感器, 移动设备, 云服务,软件应用等)即时获取,存储,操作数据,然后处理并且即时响应给其他事件流的最佳实践. 因此, 事件流是数据流得以持续翻译和信息能够在对的时间出现在对的位置的保障.</p>
<h3 id="Where–-gt-事件流用在何处"><a href="#Where–-gt-事件流用在何处" class="headerlink" title="Where–&gt;事件流用在何处?"></a><font color="red">Where</font>–&gt;事件流用在何处?</h3><p>事件流在各行各业都有则广泛的应用, 如下:</p>
<ul>
<li>在股票, 银行,保险等行业即时处理转账和交易数据</li>
<li>在物流和自动化产业跟踪监控车辆,船舰等的实时数据</li>
<li>在工厂持续从IoT设备获取并分析数据</li>
<li>在零售,酒店,旅游业以及移动应用场景中, 采集并立即响应顾客的数据请求</li>
<li>在医疗领域, 持续监控病人的健康数据并做出高效准确的预测以尽早寻求追加治疗方案</li>
<li>连接并存储同一公司不同业务分支的数据并确保其可用性</li>
<li>充当数据平台, 事件驱动架构, 微服务 等应用场景的基石.</li>
</ul>

<h3 id="Why–-gt-Kafka如何支撑业务数据"><a href="#Why–-gt-Kafka如何支撑业务数据" class="headerlink" title="Why–&gt;Kafka如何支撑业务数据?"></a><font color="red">Why</font>–&gt;Kafka如何支撑业务数据?</h3><p> kafka具有如下三种能力以确保任何想要在业务场景中实现端对端的事件流处理的用户能够应用一种经过实战检验的方式实现自己的业务:</p>
<ol>
<li>发布和订阅事件流, 即: 持续写入数据到外部系统/读取外部系统该数据</li>
<li>按业务需求和用户意愿持久,可靠地存储事件流</li>
<li>在事件流到达的即刻处理事件流数据(也可以是回溯的方式)</li>
</ol>

<p>所有以上功能在分布式, 高扩展, 弹性, 容错的环境中都是得以保障的. Kafka能部署在物理机, 虚拟机, 容器,本地应用和云应用中. 用户可以根据自身需要和业务场景选择自行管理或者是托管服务(由供应商提供)来管理自己的Kafka环境.</p>
<h3 id="How–-gt-Kafka是如何运作的"><a href="#How–-gt-Kafka是如何运作的" class="headerlink" title="How–&gt;Kafka是如何运作的?"></a>How–&gt;Kafka是如何运作的?</h3><p> Kafka是一个由客户端和服务端组成的分布式系统. 这些服务端和客户端之间通过高效的TCP网络协议进行通信. 他能被能部署在物理机, 虚拟机, 容器,本地应用和云应用中.<br></p>
<p><strong>服务端:</strong>  Kafka集群能运行在由多个数据中心或云基站的环境中. 这些被称之为(<strong>broker</strong>)服务器组成了数据存储层. 另外一部分服务器负责运行Kafka连接器持续从事件流导入/导出数据以与其他系统(数据库或其他Kafka集群)进行整合. 同时, 为了方便用户实现关键用例, Kafka<br> 还提供了易扩展和高容错的性能特点. 如果急群众某一个节点宕机, 集群中其他节点会接管该节点的工作以持续保证数据不会丢失.</p>
<p><strong>客户端:</strong>  客户端保证用户能往那些读/写以及并行处理事件流的分布式应用或微服务中写入数据, 即使是在网络瘫痪或硬件故障的情况下.Kafka提供了大量的客户端API库, 其中对Java和Scala语言支持的最好.  </p>
<h3 id="Terminologies"><a href="#Terminologies" class="headerlink" title="Terminologies"></a>Terminologies</h3><p><font color="red"><strong>1. Event</strong></font>: Event(事件,也被称之为:消息或记录) 记录了现实世界的业务数据信息.  当你往Kafka写入数据时, 其实是在往Kafka提交事件记录. 理论上, 事件有一个key, 一个value值和一个时间戳以及一些(非必须的)元数据头(metadata headers). 如:</p>
<pre><code><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">     </span></span><br><span class="line">Event key: "Alice"</span><br><span class="line">Event value: "Made a payment of $200 to Bob"</span><br><span class="line">Event timestamp: "Jun. 25, 2020 at 2:06 p.m."</span><br></pre></td></tr></table></figure></code></pre><p><font color="red"><strong>2. 生产者</strong></font>: 发布事件到Kafka集群的客户端应用.</p>
<p><font color="red"><strong>3. 消费者</strong></font>: 从Kafka集群订阅事件消费的客户端应用.</p>
<p><font color="red"><strong>4. 主题</strong></font>: 事件被组织并存储在主题中. 可以形象的将主题理解为PC的文件夹, 而事件则是文件夹中的具体的文件.</p>
<p><font color="red"><strong>5. 分区</strong></font>: 一个主题被分布在一系列不同broker中. 这种分布式的分区的设计使得客户端同时从多台broker读取/写入数据成为可能.当一个新的事件被发布到某个主题时, 该事件实际上是被追加到该主题的某一个分区上的. 拥有相同key的事件会被写到相同的分区. 同时,kafka<br>也保证了指定主题分区的消费者会按照事件被写入改分区的顺序取读取该分区的事件.<br><img src="/2020/10/28/Kafka/%E6%B6%88%E8%B4%B9%E8%80%85%E6%9C%89%E5%BA%8F%E8%AF%BB%E5%8F%96%E6%8C%87%E5%AE%9A%E5%88%86%E5%8C%BA%E7%9A%84%E4%BA%8B%E4%BB%B6.png" alt="消费者有序读取指定分区的事件"></p>
<p>如上图, 一种颜色代表了一个分区, 消费者A: 手机 和消费者B: 小车 分别向主题: T的分区(P1,P3)和(P3,P4)发布消息.<br>注意: a). 相同key(颜色表示)的事件会被写入同一个分区.<br>     b). 不同的生产者可以往同一个主题的同一个分区写数据.   </p>
<p><font color="red"><strong>6. 副本</strong></font>:  同一份数据会被存储到不同的机器(broker),每一份被称为一个副本, 副本是容错和高可用性的基础. This replication is performed at the level of topic-partitions. 即: 副本的粒度到主题-分区.</p>
<p><img src="/2020/10/28/Kafka/%E5%89%AF%E6%9C%AC%E7%B2%92%E5%BA%A6%E5%88%B0%E4%B8%BB%E9%A2%98%E5%88%86%E5%8C%BA%E7%9A%84%E5%9B%BE%E5%BD%A2%E8%A7%A3%E9%87%8A.png" alt="副本粒度到主题分区的图形解释.png"></p>
<p> Kafka中生产者和消费者是完全解耦的, 该设计保证了高扩展性. 例如, 生产者永远不必等待消费者, 事件会被处理有且一次(exactly-once).</p>
<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><h3 id="消息代理"><a href="#消息代理" class="headerlink" title="消息代理"></a>消息代理</h3><p>Kafka作为传统消息代理的替代品有着出色的表现. 拥有更高的吞吐量的同时也兼具内置分区, 副本机制,容错以及易扩展,低延时等高级特性. 因此, kafka丝毫不逊色于ActiveMQ和RabbitMQ. </p>
<h3 id="网页动态跟踪"><a href="#网页动态跟踪" class="headerlink" title="网页动态跟踪"></a>网页动态跟踪</h3><p>Kafka最早被应用于网页活动的跟踪监控. 这也就意味着诸如页面浏览, 搜索等网页活动被按照特定规律发布到特定主题. 后续会被HDFS或者离线数据仓库订阅消费.</p>
<h3 id="日志整合"><a href="#日志整合" class="headerlink" title="日志整合"></a>日志整合</h3><p>很多人会将Kafka用作日志整合的解决方案. 典型的日志整合流程是从物理服务器采集日志文件然后放到文件服务器或者HDFS中以供后续处理. Kafka抽取出日志文件的细节并将其抽象成一个更简洁的消息流. 这也就保障了低延时和分布式数据消费.  </p>
<p> <strong>Kafka还可以用于流处理, 事件溯源, 提交日志记录等场景, 此处不做详细讨论, 可参考<a href="http://kafka.apache.org/documentation/#introduction" target="_blank" rel="noopener">官网</a>.</strong></p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>Kafka是java语言开发的, 运行需要JDK支持. 而作为服务监控,同时也需要zookeeper的支持.<br>下面对集群搭建流程做详细解释.</p>
<h3 id="Step-1-关闭防火墙"><a href="#Step-1-关闭防火墙" class="headerlink" title="Step 1 关闭防火墙"></a>Step 1 关闭防火墙</h3><p>   关闭Linux防火墙. 然后检查确认是否已关闭成功.<br>​<code>shell script
service iptables stop   # 关闭防火墙
service iptables status # 查看服务状态
chkconfig iptables off  #停用开机自启动防火墙服务
chkconfig --list        # 检查
​</code><br><strong>注意: CentOS系统版本不同, 关闭防火墙的命令也不一样.</strong><br><img src="/2020/10/28/Kafka/%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99.png" alt="关闭防火墙"></p>
<h3 id="Step-2-配置域名解析"><a href="#Step-2-配置域名解析" class="headerlink" title="Step 2 配置域名解析"></a>Step 2 配置域名解析</h3><p>执行:<br>​<code>shell script
vim /etc/hosts    
​</code><br>修改hosts文件, 为所有集群节点添加IP和HOSTNAME<br><br>192.168.210.140 Node01 <br><br>192.168.210.141 Node02 <br><br>192.168.210.143 Node03 <br></p>
<p>执行:<br>​<code>shell script
vim /etc/sysconfig/network
​</code><br>分别为各个节点添加<br><br>NETWORKING=yes  <br><br>HOSTNAME=Node01<br><br>最终结果如下图:<br></p>
<p><img src="/2020/10/28/Kafka/%E5%9F%9F%E5%90%8DIP%E6%98%A0%E5%B0%84.png" alt="域名IP映射"></p>
<p>然后执行<br>​<code>shell script
reboot
​</code><br>重启系统, 让上述配置文件重新生效.</p>
<h3 id="Step-3-JDK配置"><a href="#Step-3-JDK配置" class="headerlink" title="Step 3 JDK配置"></a>Step 3 JDK配置</h3><p>解压JDK rpm文件到指定目录<br>​<code>shell script
rpm -ivh jdk-8u261-linux-x64.rpm /usr/ -C 
​</code><br>编辑配置文件<br>​<code>shell script
vim ~/.bashrc
​</code><br>在最后追加<br>​<code>shell script
JAVA_HOME=/usr/java/latest
PATH=$PATH:$JAVA_HOME/bin
CLASSPATH=.
export JAVA_HOME
export PATH
export CLASSPATH
​</code><br>然后执行如下代码让配置文件生效<br>​<code>shell script
source ~/.bashrc
​</code><br>然后执行下面代码检查JDK环境是否已配置成功<br>​<code>shell script
java -version
echo $JAVA_HOME
​</code><br>检查结果如下图:<br><img src="/2020/10/28/Kafka/JDK%E9%85%8D%E7%BD%AE%E5%B9%B6%E6%A3%80%E6%9F%A5.png" alt="JDK配置并检查"></p>
<h3 id="Step-4-zookeeper配置"><a href="#Step-4-zookeeper配置" class="headerlink" title="Step 4 zookeeper配置"></a>Step 4 zookeeper配置</h3><p>下载zookeeper 压缩包tar包, 上传到Linux,并执行如下代码解压到指定目录/usr/下:<br>​<code>shell script
tar -zxf  zookeeper-3.4.6.tar.gz -C  /usr/ 
​</code><br>复制官方提供的配置文件,<br>​<code>shell script
cd /usr/zookeeper-3.4.6/conf/
cp zoo_sample.cfg  zk.cfg
​</code><br>然后编辑配置文件<br>​<code>shell script
vim zk.cfg
​</code><br>按下图方式对配置文件做修改(zookeeper快照数据存储路径设置和集群服务器节点信息配置):<br><img src="/2020/10/28/Kafka/zookeeper%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="zookeeper配置文件"></p>
<p>然后按刚才的修改创建zookeeper快照数据的存储目录:<br>​<code>shell script
mkdir /root/zkdata
​</code><br>然后创建编辑myid文件<br>​<code>shell script
vim /root/zkdata/myid
​</code><br>作如下修改: (id要与zk.cfg中配置的server.1=Node01:2888:3888中的server后面的序号一致)</p>
<p><img src="/2020/10/28/Kafka/myid.png" alt="myid"></p>
<p>然后将zookeeper安装目录及其所有子目录,子文件拷贝到集群其他节点.<br>​<code>shell script
scp -r /usr/zookeeper-3.4.6/  root@Node02:/usr
​</code><br>如果没做过<strong>免密配置</strong>, 则输入指定目标节点的root密码即可拷贝. 如果做过免密配置, 则会直接拷贝.<br><br>免密配置的具体配置流程及其原理解释可以参见如下博客.<br><a href="https://www.cnblogs.com/wenxingxu/p/9597307.html" target="_blank" rel="noopener">免密配置</a><br><img src="/2020/10/28/Kafka/%E8%BF%9C%E7%A8%8B%E6%8B%B7%E8%B4%9D.png" alt="远程拷贝"><br>此时在Node02节点的对应目录已经能看到拷贝过来的<code>zookeeper-3.4.6</code>目录. 同样的方法, 将目录也拷贝到Node03节点指定目录.<br><br>然后在Node02和Node03节点中执行如下命令,创建zookeeper的快照数据存储目录, 并添加myid文件<br>​<code>shell script
cd /root
mkdir zkdata
vim zkdata/myid
​</code><br>至此. zookeeper集群配置也就完成. 继续启动所有集群节点的zookeeper服务<br>​<code>shell script
cd /usr/zookeeper-3.4.6/bin/
./zkServer.sh start ../conf/zk.cfg  # 启动服务, ../conf/zk.cfg表示启动当前zookeeper服务要使用的配置文件
​</code><br>然后检测服务启动成功与否<br>​<code>shell script
./zkServer.sh status ../conf/zk.cfg 
​</code><br>见到如下反馈信息说明已经启动成功.<br><img src="/2020/10/28/Kafka/zookeeper%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81.png" alt="zookeeper启动状态"></p>
<p>如果要关闭zookeeper服务可以执行:<br>​<code>shell script
./zkServer.sh stop ../conf/zk.cfg 
​</code></p>
<h3 id="step-5-kafka集群搭建"><a href="#step-5-kafka集群搭建" class="headerlink" title="step 5 kafka集群搭建"></a>step 5 kafka集群搭建</h3><p>解压<br>​<code>shell script
tar -zxf kafka_2.11-2.2.0.tgz -C /usr/ 
​</code><br>修改配置文件<br>​<code>shell script
vim /usr/kafka_2.11-2.2.0/config/server.properties
​</code><br>具体修改如下图中三个配置项:<br><img src="/2020/10/28/Kafka/kafka%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="kafka"><br>按照<code>server.properties</code>里配置的log.dirs配置项的值创建kafka日志目录<br>​<code>shell script
cd /usr/
mkdir kafka-logs
​</code><br>然后就可以进入kafka的bin目录下查看脚本<br>​<code>shell script
cd /usr/kafka_2.11-2.2.0/bin/
​</code><br><img src="/2020/10/28/Kafka/kafka%E8%84%9A%E6%9C%AC%E6%9F%A5%E7%9C%8B.png" alt="kafka脚本查看"><br>想查看具体脚本的使用方法可以执行–help, 如下:<br>​<code>shell script
./kafka-console-consumer.sh --help
​</code><br>启动kafka服务端:<br>​<code>shell script
./kafka-server-start.sh -daemon  ../config/server.properties # -daemon表示以守护/后台进程启动kafka服务, 敞口关闭进程也会继续. 后面则是指明具体的启动配置文件
​</code><br>检测是否启动成功:<br>​<code>shell script
jps
​</code><br><img src="/2020/10/28/Kafka/kafka%E5%90%AF%E5%8A%A8%E8%BF%9B%E7%A8%8B%E6%88%90%E5%8A%9F%E4%B8%8E%E5%90%A6.png" alt="kafka启动进程成功与否"><br>注意:<br><code>/usr/kafka_2.11-2.2.0/config/server.properties</code>里的broker.id的值要和当前节点的<code>/usr/kafka-logs/meta.properties</code>里的’broker.id’要保持一致. 否则kafka会在启动后秒退.</p>
<p>按照同样的方法配置集群中其他节点的kafka.</p>
<h3 id="server-properties配置文件详解"><a href="#server-properties配置文件详解" class="headerlink" title="server.properties配置文件详解"></a>server.properties配置文件详解</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># see kafka.server.KafkaConfig for additional details and defaults</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Server Basics #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个broker的唯一ID。 The id of the broker. This must be set to a unique integer for each broker.</span></span><br><span class="line"><span class="meta">broker.id</span>=<span class="string">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Socket Server Settings #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address the socket server listens on. It will get the value returned from </span></span><br><span class="line"><span class="comment"># java.net.InetAddress.getCanonicalHostName() if not configured.</span></span><br><span class="line"><span class="comment">#   FORMAT:</span></span><br><span class="line"><span class="comment">#     listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="comment">#   EXAMPLE:</span></span><br><span class="line"><span class="comment">#     listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="comment"># socket要监听的IP端口地址</span></span><br><span class="line"><span class="comment">#listeners=PLAINTEXT://:9092</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname and port the broker will advertise to producers and consumers. If not set, </span></span><br><span class="line"><span class="comment"># it uses the value for "listeners" if configured.  Otherwise, it will use the value</span></span><br><span class="line"><span class="comment"># returned from java.net.InetAddress.getCanonicalHostName(). </span></span><br><span class="line"><span class="comment"># 广播IP端口</span></span><br><span class="line"><span class="comment">#advertised.listeners=PLAINTEXT://your.host.name:9092</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Maps listener names to security protocols, the default is for them to be the same. See the config documentation for more details</span></span><br><span class="line"><span class="comment">#listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收和响应网络请求的线程数。 The number of threads that the server uses for receiving requests from the network and sending responses </span></span><br><span class="line"><span class="comment"># to the network</span></span><br><span class="line"><span class="meta">num.network.threads</span>=<span class="string">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of threads that the server uses for processing requests, which may include disk I/O</span></span><br><span class="line"><span class="meta">num.io.threads</span>=<span class="string">8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The send buffer (SO_SNDBUF) used by the socket server</span></span><br><span class="line"><span class="meta">socket.send.buffer.bytes</span>=<span class="string">102400</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The receive buffer (SO_RCVBUF) used by the socket server</span></span><br><span class="line"><span class="meta">socket.receive.buffer.bytes</span>=<span class="string">102400</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum size of a request that the socket server will accept (protection against OOM)</span></span><br><span class="line"><span class="meta">socket.request.max.bytes</span>=<span class="string">104857600</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Basics #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A comma separated list of directories under which to store log files</span></span><br><span class="line"><span class="meta">log.dirs</span>=<span class="string">/tmp/kafka-logs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The default number of log partitions per topic. More partitions allow greater</span></span><br><span class="line"><span class="comment"># parallelism for consumption, but this will also result in more files across</span></span><br><span class="line"><span class="comment"># the brokers.</span></span><br><span class="line"><span class="meta">num.partitions</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of threads per data directory to be used for log recovery at startup and flushing at shutdown.</span></span><br><span class="line"><span class="comment"># This value is recommended to be increased for installations with data dirs located in RAID array.</span></span><br><span class="line"><span class="meta">num.recovery.threads.per.data.dir</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Internal Topic Settings  #############################</span></span><br><span class="line"><span class="comment"># The replication factor for the group metadata internal topics "__consumer_offsets" and "__transaction_state"</span></span><br><span class="line"><span class="comment"># For anything other than development testing, a value greater than 1 is recommended to ensure availability such as 3.</span></span><br><span class="line"><span class="meta">offsets.topic.replication.factor</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">transaction.state.log.replication.factor</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">transaction.state.log.min.isr</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Flush Policy #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Messages are immediately written to the filesystem but by default we only fsync() to sync</span></span><br><span class="line"><span class="comment"># the OS cache lazily. The following configurations control the flush of data to disk.</span></span><br><span class="line"><span class="comment"># There are a few important trade-offs here:</span></span><br><span class="line"><span class="comment">#    1. Durability: Unflushed data may be lost if you are not using replication.</span></span><br><span class="line"><span class="comment">#    2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span></span><br><span class="line"><span class="comment">#    3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span></span><br><span class="line"><span class="comment"># The settings below allow one to configure the flush policy to flush data after a period of time or</span></span><br><span class="line"><span class="comment"># every N messages (or both). This can be done globally and overridden on a per-topic basis.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum amount of time a message can sit in a log before we force a flush</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Retention Policy #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following configurations control the disposal of log segments. The policy can</span></span><br><span class="line"><span class="comment"># be set to delete segments after a period of time, or after a given size has accumulated.</span></span><br><span class="line"><span class="comment"># A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span></span><br><span class="line"><span class="comment"># from the end of the log.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The minimum age of a log file to be eligible for deletion due to age</span></span><br><span class="line"><span class="meta">log.retention.hours</span>=<span class="string">168</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A size-based retention policy for logs. Segments are pruned from the log unless the remaining</span></span><br><span class="line"><span class="comment"># segments drop below log.retention.bytes. Functions independently of log.retention.hours.</span></span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The maximum size of a log segment file. When this size is reached a new log segment will be created.</span></span><br><span class="line"><span class="meta">log.segment.bytes</span>=<span class="string">1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The interval at which log segments are checked to see if they can be deleted according</span></span><br><span class="line"><span class="comment"># to the retention policies</span></span><br><span class="line"><span class="meta">log.retention.check.interval.ms</span>=<span class="string">300000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Zookeeper connection string (see zookeeper docs for details).</span></span><br><span class="line"><span class="comment"># This is a comma separated host:port pairs, each corresponding to a zk</span></span><br><span class="line"><span class="comment"># server. e.g. "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002".</span></span><br><span class="line"><span class="comment"># You can also append an optional chroot string to the urls to specify the</span></span><br><span class="line"><span class="comment"># root directory for all kafka znodes.</span></span><br><span class="line"><span class="meta">zookeeper.connect</span>=<span class="string">localhost:2181</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Timeout in ms for connecting to zookeeper</span></span><br><span class="line"><span class="meta">zookeeper.connection.timeout.ms</span>=<span class="string">6000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Group Coordinator Settings #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following configuration specifies the time, in milliseconds, that the GroupCoordinator will delay the initial consumer rebalance.</span></span><br><span class="line"><span class="comment"># The rebalance will be further delayed by the value of group.initial.rebalance.delay.ms as new members join the group, up to a maximum of max.poll.interval.ms.</span></span><br><span class="line"><span class="comment"># The default value for this is 3 seconds.</span></span><br><span class="line"><span class="comment"># We override this to 0 here as it makes for a better out-of-the-box experience for development and testing.</span></span><br><span class="line"><span class="comment"># However, in production environments the default value of 3 seconds is more suitable as this will help to avoid unnecessary, and potentially expensive, rebalances during application startup.</span></span><br><span class="line"><span class="meta">group.initial.rebalance.delay.ms</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>



<p>关闭Kafka就直接执行, 不用带参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-server-stop.sh</span><br></pre></td></tr></table></figure>

<p>不管是单机模式， 还是集群模式都会<strong>优雅</strong>关闭。优雅是有一定的延时， 数据存储。如果是集群每一个节点都会关闭。</p>
<h2 id="topic-操作"><a href="#topic-操作" class="headerlink" title="topic 操作"></a>topic 操作</h2><h3 id="查看手册"><a href="#查看手册" class="headerlink" title="查看手册"></a>查看手册</h3><p>通过执行可以查看topic管理相关的操作方法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --help</span><br></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">This tool helps to create, delete, describe, or change a topic.</span><br><span class="line">Option                                   Description                            </span><br><span class="line">------                                   -----------                            </span><br><span class="line">--alter                                  Alter the number of partitions,        </span><br><span class="line">                                           replica assignment, and/or           </span><br><span class="line">                                           configuration <span class="keyword">for</span> the topic.         </span><br><span class="line">--at-min-isr-partitions                  <span class="keyword">if</span> <span class="built_in">set</span> when describing topics, only    </span><br><span class="line">                                           show partitions whose isr count is   </span><br><span class="line">                                           equal to the configured minimum. Not </span><br><span class="line">                                           supported with the --zookeeper       </span><br><span class="line">                                           option.                              </span><br><span class="line">--bootstrap-server &lt;String: server to    REQUIRED: The Kafka server to connect  </span><br><span class="line">  connect to&gt;                              to. In <span class="keyword">case</span> of providing this, a     </span><br><span class="line">                                           direct Zookeeper connection won<span class="string">'t be </span></span><br><span class="line"><span class="string">                                           required.                            </span></span><br><span class="line"><span class="string">--command-config &lt;String: command        Property file containing configs to be </span></span><br><span class="line"><span class="string">  config property file&gt;                    passed to Admin Client. This is used </span></span><br><span class="line"><span class="string">                                           only with --bootstrap-server option  </span></span><br><span class="line"><span class="string">                                           for describing and altering broker   </span></span><br><span class="line"><span class="string">                                           configs.                             </span></span><br><span class="line"><span class="string">--config &lt;String: name=value&gt;            A topic configuration override for the </span></span><br><span class="line"><span class="string">                                           topic being created or altered.The   </span></span><br><span class="line"><span class="string">                                           following is a list of valid         </span></span><br><span class="line"><span class="string">                                           configurations:                      </span></span><br><span class="line"><span class="string">                                                cleanup.policy                        </span></span><br><span class="line"><span class="string">                                                compression.type                      </span></span><br><span class="line"><span class="string">                                                delete.retention.ms                   </span></span><br><span class="line"><span class="string">                                                file.delete.delay.ms                  </span></span><br><span class="line"><span class="string">                                                flush.messages                        </span></span><br><span class="line"><span class="string">                                                flush.ms                              </span></span><br><span class="line"><span class="string">                                                follower.replication.throttled.       </span></span><br><span class="line"><span class="string">                                           replicas                             </span></span><br><span class="line"><span class="string">                                                index.interval.bytes                  </span></span><br><span class="line"><span class="string">                                                leader.replication.throttled.replicas </span></span><br><span class="line"><span class="string">                                                max.compaction.lag.ms                 </span></span><br><span class="line"><span class="string">                                                max.message.bytes                     </span></span><br><span class="line"><span class="string">                                                message.downconversion.enable         </span></span><br><span class="line"><span class="string">                                                message.format.version                </span></span><br><span class="line"><span class="string">                                                message.timestamp.difference.max.ms   </span></span><br><span class="line"><span class="string">                                                message.timestamp.type                </span></span><br><span class="line"><span class="string">                                                min.cleanable.dirty.ratio             </span></span><br><span class="line"><span class="string">                                                min.compaction.lag.ms                 </span></span><br><span class="line"><span class="string">                                                min.insync.replicas                   </span></span><br><span class="line"><span class="string">                                                preallocate                           </span></span><br><span class="line"><span class="string">                                                retention.bytes                       </span></span><br><span class="line"><span class="string">                                                retention.ms                          </span></span><br><span class="line"><span class="string">                                                segment.bytes                         </span></span><br><span class="line"><span class="string">                                                segment.index.bytes                   </span></span><br><span class="line"><span class="string">                                                segment.jitter.ms                     </span></span><br><span class="line"><span class="string">                                                segment.ms                            </span></span><br><span class="line"><span class="string">                                                unclean.leader.election.enable        </span></span><br><span class="line"><span class="string">                                         See the Kafka documentation for full   </span></span><br><span class="line"><span class="string">                                           details on the topic configs.It is   </span></span><br><span class="line"><span class="string">                                           supported only in combination with --</span></span><br><span class="line"><span class="string">                                           create if --bootstrap-server option  </span></span><br><span class="line"><span class="string">                                           is used.                             </span></span><br><span class="line"><span class="string">--create                                 Create a new topic.                    </span></span><br><span class="line"><span class="string">--delete                                 Delete a topic                         </span></span><br><span class="line"><span class="string">--delete-config &lt;String: name&gt;           A topic configuration override to be   </span></span><br><span class="line"><span class="string">                                           removed for an existing topic (see   </span></span><br><span class="line"><span class="string">                                           the list of configurations under the </span></span><br><span class="line"><span class="string">                                           --config option). Not supported with </span></span><br><span class="line"><span class="string">                                           the --bootstrap-server option.       </span></span><br><span class="line"><span class="string">--describe                               List details for the given topics.     </span></span><br><span class="line"><span class="string">--disable-rack-aware                     Disable rack aware replica assignment  </span></span><br><span class="line"><span class="string">--exclude-internal                       exclude internal topics when running   </span></span><br><span class="line"><span class="string">                                           list or describe command. The        </span></span><br><span class="line"><span class="string">                                           internal topics will be listed by    </span></span><br><span class="line"><span class="string">                                           default                              </span></span><br><span class="line"><span class="string">--force                                  Suppress console prompts               </span></span><br><span class="line"><span class="string">--help                                   Print usage information.               </span></span><br><span class="line"><span class="string">--if-exists                              if set when altering or deleting or    </span></span><br><span class="line"><span class="string">                                           describing topics, the action will   </span></span><br><span class="line"><span class="string">                                           only execute if the topic exists.    </span></span><br><span class="line"><span class="string">                                           Not supported with the --bootstrap-  </span></span><br><span class="line"><span class="string">                                           server option.                       </span></span><br><span class="line"><span class="string">--if-not-exists                          if set when creating topics, the       </span></span><br><span class="line"><span class="string">                                           action will only execute if the      </span></span><br><span class="line"><span class="string">                                           topic does not already exist. Not    </span></span><br><span class="line"><span class="string">                                           supported with the --bootstrap-      </span></span><br><span class="line"><span class="string">                                           server option.                       </span></span><br><span class="line"><span class="string">--list                                   List all available topics.             </span></span><br><span class="line"><span class="string">--partitions &lt;Integer: # of partitions&gt;  The number of partitions for the topic </span></span><br><span class="line"><span class="string">                                           being created or altered (WARNING:   </span></span><br><span class="line"><span class="string">                                           If partitions are increased for a    </span></span><br><span class="line"><span class="string">                                           topic that has a key, the partition  </span></span><br><span class="line"><span class="string">                                           logic or ordering of the messages    </span></span><br><span class="line"><span class="string">                                           will be affected). If not supplied   </span></span><br><span class="line"><span class="string">                                           for create, defaults to the cluster  </span></span><br><span class="line"><span class="string">                                           default.                             </span></span><br><span class="line"><span class="string">--replica-assignment &lt;String:            A list of manual partition-to-broker   </span></span><br><span class="line"><span class="string">  broker_id_for_part1_replica1 :           assignments for the topic being      </span></span><br><span class="line"><span class="string">  broker_id_for_part1_replica2 ,           created or altered.                  </span></span><br><span class="line"><span class="string">  broker_id_for_part2_replica1 :                                                </span></span><br><span class="line"><span class="string">  broker_id_for_part2_replica2 , ...&gt;                                           </span></span><br><span class="line"><span class="string">--replication-factor &lt;Integer:           The replication factor for each        </span></span><br><span class="line"><span class="string">  replication factor&gt;                      partition in the topic being         </span></span><br><span class="line"><span class="string">                                           created. If not supplied, defaults   </span></span><br><span class="line"><span class="string">                                           to the cluster default.              </span></span><br><span class="line"><span class="string">--topic &lt;String: topic&gt;                  The topic to create, alter, describe   </span></span><br><span class="line"><span class="string">                                           or delete. It also accepts a regular </span></span><br><span class="line"><span class="string">                                           expression, except for --create      </span></span><br><span class="line"><span class="string">                                           option. Put topic name in double     </span></span><br><span class="line"><span class="string">                                           quotes and use the '</span>\<span class="string">' prefix to     </span></span><br><span class="line"><span class="string">                                           escape regular expression symbols; e.</span></span><br><span class="line"><span class="string">                                           g. "test\.topic".                    </span></span><br><span class="line"><span class="string">--topics-with-overrides                  if set when describing topics, only    </span></span><br><span class="line"><span class="string">                                           show topics that have overridden     </span></span><br><span class="line"><span class="string">                                           configs                              </span></span><br><span class="line"><span class="string">--unavailable-partitions                 if set when describing topics, only    </span></span><br><span class="line"><span class="string">                                           show partitions whose leader is not  </span></span><br><span class="line"><span class="string">                                           available                            </span></span><br><span class="line"><span class="string">--under-min-isr-partitions               if set when describing topics, only    </span></span><br><span class="line"><span class="string">                                           show partitions whose isr count is   </span></span><br><span class="line"><span class="string">                                           less than the configured minimum.    </span></span><br><span class="line"><span class="string">                                           Not supported with the --zookeeper   </span></span><br><span class="line"><span class="string">                                           option.                              </span></span><br><span class="line"><span class="string">--under-replicated-partitions            if set when describing topics, only    </span></span><br><span class="line"><span class="string">                                           show under replicated partitions     </span></span><br><span class="line"><span class="string">--version                                Display Kafka version.                 </span></span><br><span class="line"><span class="string">--zookeeper &lt;String: hosts&gt;              DEPRECATED, The connection string for  </span></span><br><span class="line"><span class="string">                                           the zookeeper connection in the form </span></span><br><span class="line"><span class="string">                                           host:port. Multiple hosts can be     </span></span><br><span class="line"><span class="string">                                           given to allow fail-over.</span></span><br></pre></td></tr></table></figure>

<h3 id="查看topic列表"><a href="#查看topic列表" class="headerlink" title="查看topic列表"></a>查看topic列表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --list --bootstrap-server localhost:9092,localhost:9093,localhost:9094</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.03.03.png" alt="查看topic列表"></p>
<h3 id="查看topic存储分区信息"><a href="#查看topic存储分区信息" class="headerlink" title="查看topic存储分区信息"></a>查看topic存储分区信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --describe --topic clusterTopic01</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.34.05.png" alt="查看topic存储分区信息"></p>
<p><span style="color:red"><strong>分析上图： clusterTopic01  分区数也是3， 副本因子也是3. 其中Partition0 的主节点Leader是2。</strong></span>  </p>
<h3 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --create --topic clusterTopic01 --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --partitions 3 --replication-factor 4</span><br></pre></td></tr></table></figure>

<p><span style="color:red"><strong>创建的topic名称已经存在时会报错IllegalArguementException：Topic Already Exist</strong></span></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.05.12.png" alt="Topic Already Exist"></p>
<p>修改topic名称后执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;kafka-topics.sh --create --topic clusterTopic01NEW --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --partitions 3 --replication-factor 4</span><br></pre></td></tr></table></figure>

<p><span style="color:red"><strong>副本因子数不能大于brokers数量， 否则 InvalidReplicationFactorException: Replication factor: 4 larger than available brokers: 3.</strong></span></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.08.19.png" alt="Replication factor larger than available brokers"></p>
<p>再修改副本因子数后再执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --create --topic clusterTopic01NEW --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --partitions 4 --replication-factor 3</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.11.34.png" alt="创建成功后的结果多了clusterTopic01NEW"></p>
<h3 id="查看topic副本存储信息"><a href="#查看topic副本存储信息" class="headerlink" title="查看topic副本存储信息"></a>查看topic副本存储信息</h3><p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.27.52.png" alt="查看topic副本存储信息"></p>
<h3 id="修改topic分区数-只增不减"><a href="#修改topic分区数-只增不减" class="headerlink" title="修改topic分区数(只增不减)"></a>修改topic分区数(只增不减)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --alter --topic clusterTopic01 --partitions 1</span><br></pre></td></tr></table></figure>

<p>发现报错 <span style="color:red"><strong>InvalidPartitionsException: Topic currently has 3 partitions, which is higher than the requested 1.</strong></span></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.40.04.png" alt="降低topic分区数报错"></p>
<p>然后修改partitions 为4 则执行成功。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.44.24.png" alt="增大topic分区数"></p>
<h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --bootstrap-server localhost:9092,localhost:9093,localhost:9094 --delete --topic clusterTopic01</span><br></pre></td></tr></table></figure>

<p>执行完， 删除成功， 再去看topic列表已经没有clusterTopic01 这个topic了。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.52.54.png" alt="已无clusterTopic01"></p>
<p>另外再去看分区详情也不会有返回。 而且日志里面clusterTopic01的副本目录名称都加了一个<code>-delete</code>后缀。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at22.48.23.png" alt="删除后查看日志目录名称变化"></p>
<h2 id="producer-操作"><a href="#producer-操作" class="headerlink" title="producer 操作"></a>producer 操作</h2><h3 id="往指定topic发布消息"><a href="#往指定topic发布消息" class="headerlink" title="往指定topic发布消息"></a>往指定topic发布消息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-producer.sh --broker-list localhost:9092, localhost:9093, localhost:9094 --topic clusterTopic01NEW</span><br></pre></td></tr></table></figure>

<p><span style="color:red"><strong>注意⚠️consumer里叫: –bootstrap-server ， producer里叫:  –broker-list</strong></span></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.26.00.png" alt="连续向topic写入三条消息"></p>
<ol>
<li><p>如果只启动了一个消费者， 那么全部都被这一个消费者消费 。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.31.37.png" alt="生产者写入"></p>
</li>
</ol>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.32.24.png" alt="只有一个消费者消费时"></p>
<ol start="2">
<li><p>如果一个消费者组有多个消费者订阅了该topic，则多个消费者均分消费该topic中的消息</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.35.56.png" alt="生产者写入"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.36.27.png" alt="group1的消费者1"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.36.52.png" alt="group1的消费者2"></p>
</li>
<li><p>如果多个消费者组有多个消费者订阅了该topic， 则组内均分， 组间广播。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.41.46.png" alt="消费者写入"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.41.59.png" alt="组间广播之消费者g1c1"></p>
<p>![组间广播之消费者g1c2](/Users/JoshuaBrooks/Documents/screenshots/originalscreenshots/Screenshot 2022-05-11 at 21.42.52.png)</p>
</li>
</ol>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.43.59.png" alt="组间广播之消费者g2c1"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at21.44.36.png" alt="组间广播之消费者g2c2"></p>
<h2 id="consumer-操作"><a href="#consumer-操作" class="headerlink" title="consumer 操作"></a>consumer 操作</h2><h3 id="订阅指定topic的消息"><a href="#订阅指定topic的消息" class="headerlink" title="订阅指定topic的消息"></a>订阅指定topic的消息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server localhost:9092, localhost:9093, localhost:9094 --topic clusterTopic01NEW --group group1</span><br></pre></td></tr></table></figure>





<h2 id="Kafka-Eagle安装"><a href="#Kafka-Eagle安装" class="headerlink" title="Kafka-Eagle安装"></a>Kafka-Eagle安装</h2><p>确保ke.sh有可执行权限<br>​<code>shell script
chmod u+x /usr/kafka-eagle-web-2.0.2/bin/ke.sh 
​</code></p>
<p>Linux系统安装MySQL步骤:<br>step1 :<br><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">MySQL官网</a>下载MySQL安装包:<br><img src="/2020/10/28/Kafka/%E5%AE%98%E7%BD%91%E4%B8%8B%E8%BD%BDMySQL%E5%AE%89%E8%A3%85tar%E5%8C%85.png" alt></p>
<p>step2: 上传包<br>winscp(或其他) 软件上传到Linux指定目录下. (此处传到: /mysoftware/)  </p>
<p>step3: 解压<br>​<code>shell script
cd /mysoftware
tar -xvf mysql-8.0.22-1.el8.x86_64.rpm-bundle.tar -C /usr/
​</code><br>step4: 查看解压文件<br>​<code>shell script
ls -l /usr/
​</code><br>如图:<br><img src="/2020/10/28/Kafka/MySQL%E5%AE%89%E8%A3%85%E5%8C%85%E8%A7%A3%E5%8E%8B%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E6%B8%85%E5%8D%95.png" alt="MySQL安装包解压后的文件清单"></p>
<p>step5: 确认系统之前是否装过MySQL<br>​<code>shell script
rpm -qa | grep mysql 
​</code><br>结果:<br><img src="/2020/10/28/Kafka/%E6%9F%A5%E8%AF%A2%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E8%BF%87MySQL.png" alt="查询系统是否已经安装过MySQL"><br>如果已经安装过mysql, 先卸载:<br>​<code>shell script
rpm -e --nodeps mysql-libs-5.1.71-1.el6.x86_64
​</code><br>然后再次执行:<br>​<code>shell script
rpm -qa | grep mysql 
​</code><br>如果没有任何输出, 说明卸载成功</p>
<p>step5 : 依次安装<br>​<code>shell script
rpm -ivh 
​</code><br><strong>注：ivh中， i-install安装；v-verbose进度条；h-hash哈希校验</strong></p>
<p>安装成功提示:<br><img src="/2020/10/28/Kafka/kafkaeagle%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png" alt="kafkaeagle安装成功提示.png"><br>监控首页<br><img src="/2020/10/28/Kafka/kafkaeagle%E7%99%BB%E5%BD%95%E9%A1%B5.png" alt="kafkaeagle登录页.png"></p>
<h2 id="KafkaEagle-使用"><a href="#KafkaEagle-使用" class="headerlink" title="KafkaEagle 使用"></a>KafkaEagle 使用</h2><h3 id="新建topic"><a href="#新建topic" class="headerlink" title="新建topic"></a>新建topic</h3><p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at12.36.06.png" alt="新建topic"></p>
<h2 id="生态"><a href="#生态" class="headerlink" title="生态"></a>生态</h2><h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><h1 id="APIs"><a href="#APIs" class="headerlink" title="APIs"></a>APIs</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>创建maven项目引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafkaconsumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--commons-lang3 工具包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志相关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Kafka依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kafka_2.13<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建日志配置文件<code>log4j.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### ÉèÖÃ###</span></span><br><span class="line"><span class="meta">log4j.rootLogger</span> = <span class="string">info,console</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Êä³öÐÅÏ¢µ½¿ØÖÆÌ§ ###</span></span><br><span class="line"><span class="meta">log4j.appender.console</span> = <span class="string">org.apache.log4j.ConsoleAppender</span></span><br><span class="line"><span class="meta">log4j.appender.console.Target</span> = <span class="string">System.out</span></span><br><span class="line"><span class="meta">log4j.appender.console.layout</span> = <span class="string">org.apache.log4j.PatternLayout</span></span><br><span class="line"><span class="meta">log4j.appender.concole.layout.ConversionPattern</span> = <span class="string">[%-5p] %d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; method:%l%n%m%n</span></span><br></pre></td></tr></table></figure>

<h2 id="topic-管理API"><a href="#topic-管理API" class="headerlink" title="topic 管理API"></a>topic 管理API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.admin.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.10.23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicManagement</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AdminClient adminClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 获取Kafka环境配置信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Properties properties = prepareEnvironment();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建管理对象adminClient，这一行代码会打印处AdminClientConfig的信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        adminClient = KafkaAdminClient.create(properties);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建topic</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        createTopicByMe(adminClient, <span class="string">"Joshua"</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 删除topic</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        deleteTopicByMe(adminClient,<span class="string">"Joshua"</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 列出所有topic详细信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        listAllMyTopics(adminClient, properties);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        adminClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> adminClient 管理客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic2Bdeleted 要删除的topic的名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ExecutionException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteTopicByMe</span><span class="params">(AdminClient adminClient, String topic2Bdeleted)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        DeleteTopicsResult deleTopicsResult = adminClient.deleteTopics(Arrays.asList(topic2Bdeleted));</span><br><span class="line">        deleTopicsResult.all().get(); <span class="comment">//触发同步删除</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> adminClient 管理客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic2BCreated 要新增的topic的名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ExecutionException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTopicByMe</span><span class="params">(AdminClient adminClient, String topic2BCreated)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        CreateTopicsResult createTopicsResult =</span><br><span class="line">                adminClient.createTopics(Arrays.asList(<span class="keyword">new</span> NewTopic(topic2BCreated, <span class="number">3</span>, (<span class="keyword">short</span>) <span class="number">3</span>)));</span><br><span class="line">        createTopicsResult.all().get(); <span class="comment">// 触发同步创建</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listAllMyTopics</span><span class="params">(AdminClient adminClient, Properties properties)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ListTopicsResult listTopicsResult = adminClient.listTopics();</span><br><span class="line">        Set&lt;String&gt; topicNames = listTopicsResult.names().get();</span><br><span class="line">        <span class="keyword">if</span> (topicNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(properties.getProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG) + <span class="string">"is empty now, you can publish topic-partitions to it l8r."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topicNames) &#123;</span><br><span class="line">            stringBuilder.append(topic + <span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 查看topic的详细信息</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        String s = stringBuilder.toString();</span><br><span class="line">        String substring = s.substring(<span class="number">0</span>, s.length());</span><br><span class="line">        String[] split = substring.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        DescribeTopicsResult describeTopics = adminClient.describeTopics(Arrays.asList(split));</span><br><span class="line">        Map&lt;String, TopicDescription&gt; descMap = describeTopics.all().get();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, TopicDescription&gt; entry : descMap.entrySet()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"key:\t"</span> + entry.getKey());</span><br><span class="line">            System.out.println(<span class="string">"value:\t"</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Kafka集群地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Properties <span class="title">prepareEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先看Kafka集群的AdminClientConfig信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AdminClientConfig</span> <span class="string">values: </span></span><br><span class="line">	<span class="meta">bootstrap.servers</span> = <span class="string">[localhost:9092, localhost:9093, localhost:9094]</span></span><br><span class="line">	<span class="meta">client.dns.lookup</span> = <span class="string">use_all_dns_ips</span></span><br><span class="line">	<span class="meta">client.id</span> = <span class="string"></span></span><br><span class="line">	<span class="meta">connections.max.idle.ms</span> = <span class="string">300000</span></span><br><span class="line">	<span class="meta">default.api.timeout.ms</span> = <span class="string">60000</span></span><br><span class="line">	<span class="meta">metadata.max.age.ms</span> = <span class="string">300000</span></span><br><span class="line">	<span class="meta">metric.reporters</span> = <span class="string">[]</span></span><br><span class="line">	<span class="meta">metrics.num.samples</span> = <span class="string">2</span></span><br><span class="line">	<span class="meta">metrics.recording.level</span> = <span class="string">INFO</span></span><br><span class="line">	<span class="meta">metrics.sample.window.ms</span> = <span class="string">30000</span></span><br><span class="line">	<span class="meta">receive.buffer.bytes</span> = <span class="string">65536</span></span><br><span class="line">	<span class="meta">reconnect.backoff.max.ms</span> = <span class="string">1000</span></span><br><span class="line">	<span class="meta">reconnect.backoff.ms</span> = <span class="string">50</span></span><br><span class="line">	<span class="meta">request.timeout.ms</span> = <span class="string">30000</span></span><br><span class="line">	<span class="attr">retries</span> = <span class="string">2147483647</span></span><br><span class="line">	<span class="meta">retry.backoff.ms</span> = <span class="string">100</span></span><br><span class="line">	<span class="meta">sasl.client.callback.handler.class</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">sasl.jaas.config</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">sasl.kerberos.kinit.cmd</span> = <span class="string">/usr/bin/kinit</span></span><br><span class="line">	<span class="meta">sasl.kerberos.min.time.before.relogin</span> = <span class="string">60000</span></span><br><span class="line">	<span class="meta">sasl.kerberos.service.name</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">sasl.kerberos.ticket.renew.jitter</span> = <span class="string">0.05</span></span><br><span class="line">	<span class="meta">sasl.kerberos.ticket.renew.window.factor</span> = <span class="string">0.8</span></span><br><span class="line">	<span class="meta">sasl.login.callback.handler.class</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">sasl.login.class</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">sasl.login.refresh.buffer.seconds</span> = <span class="string">300</span></span><br><span class="line">	<span class="meta">sasl.login.refresh.min.period.seconds</span> = <span class="string">60</span></span><br><span class="line">	<span class="meta">sasl.login.refresh.window.factor</span> = <span class="string">0.8</span></span><br><span class="line">	<span class="meta">sasl.login.refresh.window.jitter</span> = <span class="string">0.05</span></span><br><span class="line">	<span class="meta">sasl.mechanism</span> = <span class="string">GSSAPI</span></span><br><span class="line">	<span class="meta">security.protocol</span> = <span class="string">PLAINTEXT</span></span><br><span class="line">	<span class="meta">security.providers</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">send.buffer.bytes</span> = <span class="string">131072</span></span><br><span class="line">	<span class="meta">ssl.cipher.suites</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.enabled.protocols</span> = <span class="string">[TLSv1.2]</span></span><br><span class="line">	<span class="meta">ssl.endpoint.identification.algorithm</span> = <span class="string">https</span></span><br><span class="line">	<span class="meta">ssl.engine.factory.class</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.key.password</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.keymanager.algorithm</span> = <span class="string">SunX509</span></span><br><span class="line">	<span class="meta">ssl.keystore.location</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.keystore.password</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.keystore.type</span> = <span class="string">JKS</span></span><br><span class="line">	<span class="meta">ssl.protocol</span> = <span class="string">TLSv1.2</span></span><br><span class="line">	<span class="meta">ssl.provider</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.secure.random.implementation</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.trustmanager.algorithm</span> = <span class="string">PKIX</span></span><br><span class="line">	<span class="meta">ssl.truststore.location</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.truststore.password</span> = <span class="string">null</span></span><br><span class="line">	<span class="meta">ssl.truststore.type</span> = <span class="string">JKS</span></span><br></pre></td></tr></table></figure>



<p>在看打印结果：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at23.54.51.png" alt="api查看topic列表"></p>
<p>看上面的结果发现，没找到新建的topic  Joshua。 <span style="color:red"><strong>这是因为Kafka的topic操作是异步的， 下次注释掉create操作， 直接列出来发现就有了。 当然也有方式就是显示触发同步操作。</strong></span></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">createTopicsResult.all().get(); <span class="comment">// 触发同步机制</span></span><br></pre></td></tr></table></figure>



<h2 id="生产者-amp-消费者API"><a href="#生产者-amp-消费者API" class="headerlink" title="生产者 &amp; 消费者API"></a>生产者 &amp; 消费者API</h2><h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        produce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 和topic API一样, 生产者消费者的API首先也是要指明配置参数, 即kafka的基本配置信息</span></span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息在进行网络传输的过程中要进行序列化， 需要对K-V指定序列化器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 2. 生产者创建</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">1000</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 创建消息记录， 有多个重载方法， 可以指定 topic, key, value, 分区partition, 时间戳timestamp ，消息头 headers</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord =</span><br><span class="line">                    <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"ABC"</span>, <span class="number">0</span>, i + <span class="string">""</span>, i + <span class="string">"Par0 ONLY"</span>);</span><br><span class="line">            <span class="comment">// 发送record</span></span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 关闭资源</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行上述生产者代码结果（注意要在offset explorer客户端修改topic的key- value的序列化器）：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at12.52.02.png" alt="生产者代码结果"></p>
<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">//消息接收到后要进行反序列化解析</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//消费者要指明属于哪一个消费者组</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"g1"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 消费者创建</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. 订阅/消费 Message 其中参数既可以是String 指定 topic名称 也可以是 正则表达式 模式匹配到符合的topic</span></span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"ABC"</span>));</span><br><span class="line">        <span class="comment">// 遍历消息队列</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 隔1S去队列拿一次数据</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="comment">//如果从队列中拿到了数据</span></span><br><span class="line">            <span class="keyword">if</span> (!consumerRecords.isEmpty()) &#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="comment">//遍历拿到的数据</span></span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="comment">//获取下一条消息</span></span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    <span class="comment">//获取消息key</span></span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    <span class="comment">//获取消息的value</span></span><br><span class="line">                    String value = next.value();</span><br><span class="line">                    <span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span> + topic + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"key:\t"</span> + key + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"value:\t"</span> + value + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"offset:\t"</span> + offset + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"partition:\t"</span> + partition + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span> + timestamp + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"timestampType:\t"</span> + timestampType + <span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码实现功能： 订阅消费 topic名称为 “ABC”的消息， 并打印<span style="color:red"><strong>消息六要素(TP,KV,OT)。<br> T: Topic. P: Partition K: key V: Value O: Offset T: Timestamp</strong></span></p>
<p>开启Consumer的并行模式，然后启动两次。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.17.58.png" alt="开启并行"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.19.25.png" alt="Consumer并行启动两个instance"></p>
<p>为了演示验证消费者消费的顺序特点， 将上述生产者代码中的消费者记录行改为下面这行再运行一遍：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"ABC"</span>,  i + <span class="string">""</span>,  <span class="string">"V-"</span>+i);</span><br></pre></td></tr></table></figure>

<p>然后观察Consumer消费的结果：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.13.59.png" alt="分区0的消费情况"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.14.07.png" alt="分区1和2的消费情况"></p>
<p>可见  分区0: 1， 5，7， 8      分区1: 4， 6， 10       分区2: 2，3， 9.</p>
<p>所以验证了前面说的：<span style="color:red">只能保证分区内部的有序， 分区间无序。该特性也称之为<strong>局部FIFO</strong>。</span> </p>
<p>另外consumer的启动窗口会有一些日志信息显示：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Subscribed to pattern: 'ABC'</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Cluster ID: I4sCoIdMSFiHAj6CoODpkw</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Discovered group coordinator localhost:9093 (id: 2147483646 rack: null)</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] (Re-)joining group</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Join group failed with org.apache.kafka.common.errors.MemberIdRequiredException: The group member needs to have a valid member id before actually entering a consumer group.</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] (Re-)joining group</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Successfully joined group with generation 7</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Notifying assignor about the new Assignment(partitions=[ABC-0, ABC-1])</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Adding newly assigned partitions: ABC-0, ABC-1</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Setting offset for partition ABC-0 to the committed offset FetchPosition&#123;offset=2004, offsetEpoch=Optional[0], currentLeader=LeaderAndEpoch&#123;leader=Optional[localhost:9092 (id: 0 rack: null)], epoch=0&#125;&#125;</span></span><br><span class="line"><span class="meta">[Consumer</span> <span class="string">clientId=consumer-g1-1, groupId=g1] Setting offset for partition ABC-1 to the committed offset FetchPosition&#123;offset=13, offsetEpoch=Optional[0], currentLeader=LeaderAndEpoch&#123;leader=Optional[localhost:9094 (id: 2 rack: null)], epoch=0&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.27.22.png" alt="Screenshot 2022-05-12 at 13.27.22"></p>
<p>如果其中一个消费者宕机， 那么会引发分区间的重新分配：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at13.34.36.png" alt="Screenshot 2022-05-12 at 13.34.36"></p>
<h2 id="自定义分区"><a href="#自定义分区" class="headerlink" title="自定义分区"></a>自定义分区</h2><h3 id="自定义消费者消费分区"><a href="#自定义消费者消费分区" class="headerlink" title="自定义消费者消费分区"></a>自定义消费者消费分区</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.TopicPartition;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">//消息接收到后要进行反序列化解析</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//消费者要指明属于哪一个消费者组</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="string">"g1"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 消费者创建</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. 订阅/消费 Message 其中参数既可以是String 指定 topic名称 也可以是 正则表达式 模式匹配到符合的topic</span></span><br><span class="line">        <span class="comment">//consumer.subscribe(Pattern.compile("ABC"));</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 也可以指定消费分区，但是这种方式会失去组管理特性</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//先指定topic分区信息</span></span><br><span class="line">        List&lt;TopicPartition&gt; p0 = Arrays.asList(<span class="keyword">new</span> TopicPartition(<span class="string">"Joshua"</span>,<span class="number">0</span>));</span><br><span class="line">        <span class="comment">//指定消费者要消费该分区</span></span><br><span class="line">        consumer.assign(p0);</span><br><span class="line">        <span class="comment">//从头开始消费</span></span><br><span class="line">        <span class="comment">//consumer.seekToBeginning(p0);</span></span><br><span class="line">        <span class="comment">//从指定位置开始消费。注意第一个参数是partition，而不是List&lt;TopicPartition&gt;</span></span><br><span class="line">        consumer.seek(p0.get(<span class="number">0</span>),(<span class="keyword">long</span>)<span class="number">4660</span>);</span><br><span class="line">        <span class="comment">// 遍历消息队列</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 隔1S去队列拿一次数据</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="comment">//如果从队列中拿到了数据</span></span><br><span class="line">            <span class="keyword">if</span> (!consumerRecords.isEmpty()) &#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="comment">//遍历拿到的数据</span></span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    <span class="comment">//获取下一条消息</span></span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    <span class="comment">//获取消息key</span></span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    <span class="comment">//获取消息的value</span></span><br><span class="line">                    String value = next.value();</span><br><span class="line">                    <span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span> + topic + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"key:\t"</span> + key + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"value:\t"</span> + value + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"offset:\t"</span> + offset + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"partition:\t"</span> + partition + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span> + timestamp + <span class="string">"\t"</span> +</span><br><span class="line">                                    <span class="string">"timestampType:\t"</span> + timestampType + <span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at14.25.27.png" alt="Joshua partition-0 offset 4660开始消费"></p>
<h3 id="生产者默认分区策略查看"><a href="#生产者默认分区策略查看" class="headerlink" title="生产者默认分区策略查看"></a>生产者默认分区策略查看</h3><p>从<a href="https://kafka.apache.org/documentation/#producerconfigs_partitioner.class" target="_blank" rel="noopener">官网文档</a>或者API源码都能看出 生产者生产的消息决定分给某个分区是采取的默认的分区策略<code>org.apache.kafka.clients.producer.internals.DefaultPartitioner</code>里指定的逻辑。 </p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at14.36.34.png" alt="官网文档Partition配置"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at14.34.43.png" alt="API文档partition配置"></p>
<p>而从DefaultPartitioner类注释可以看出其逻辑是：</p>
<ol>
<li>有指定Partition策略， 就用它</li>
<li>1不成立， 但是有key， 则按key的hash值决定</li>
<li>1，2都不成立就按“sticky partitioning”策略。（老版本此处是轮询 round robin策略）</li>
</ol>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at14.42.12.png" alt="DefaultPartitioner类注释"></p>
<h3 id="生产者使用自定义分区策略"><a href="#生产者使用自定义分区策略" class="headerlink" title="生产者使用自定义分区策略"></a>生产者使用自定义分区策略</h3><h4 id="step1-自定义分区策略"><a href="#step1-自定义分区策略" class="headerlink" title="step1: 自定义分区策略"></a>step1: 自定义分区策略</h4><p> 新建类<code>UserDefinedPartitioner</code> 实现接口： <code>Partitioner</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.partition2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.SerializationUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Partitioner;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.Cluster;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.PartitionInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.utils.Utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.17.23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDefinedPartitioner</span> <span class="keyword">implements</span> <span class="title">Partitioner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger counter=<span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(String topic, Object key, <span class="keyword">byte</span>[] keyBytes, Object value, <span class="keyword">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取所有分区</span></span><br><span class="line">        List&lt;PartitionInfo&gt; partitionInfos = cluster.partitionsForTopic(topic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取分区数</span></span><br><span class="line">        <span class="keyword">int</span> partitionSize = partitionInfos.size();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span>(keyBytes==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> andIncrement = counter.getAndIncrement();</span><br><span class="line">            <span class="keyword">return</span> Utils.toPositive(andIncrement) % partitionSize;  <span class="comment">//(andIncrement &amp; Integer.MAX_VALUE) 和 Utils.toPositive(andIncrement) 的效果和 一样, 使andIncrement变为正数</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer.parseInt((String) key) % partitionSize) ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"self partition closing"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"configure"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="step2-producer中指定配置："><a href="#step2-producer中指定配置：" class="headerlink" title="step2: producer中指定配置："></a>step2: producer中指定配置：</h4><p><code>properties.setProperty(ProducerConfig.PARTITIONER_CLASS_CONFIG, UserDefinedPartitioner.class.getName());</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main.partition.UserDefinedPartitioner;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> leewilliam</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        produce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 和topic API一样, 生产者消费者的API首先也是要指明配置参数, 即kafka的基本配置信息</span></span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息在进行网络传输的过程中要进行序列化， 需要对K-V指定序列化器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 指定分区策略</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        properties.setProperty(ProducerConfig.PARTITIONER_CLASS_CONFIG, UserDefinedPartitioner<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 生产者创建</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">31</span>; i &lt;= <span class="number">40</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 创建消息记录， 有多个重载方法， 可以指定 topic, key, value, 分区partition, 时间戳timestamp ，消息头 headers</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord =</span><br><span class="line">                    <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"ABC"</span>,  i + <span class="string">""</span>,  <span class="string">"VV-"</span>+i);</span><br><span class="line">            <span class="comment">// 发送record</span></span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 关闭资源</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行上述代码将消息写到“ABC” topic。 </p>
<h2 id="自定义-反-序列化器"><a href="#自定义-反-序列化器" class="headerlink" title="自定义(反)序列化器"></a>自定义(反)序列化器</h2><h3 id="step1-新建序列化器"><a href="#step1-新建序列化器" class="headerlink" title="step1: 新建序列化器"></a>step1: 新建序列化器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.serialize3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.SerializationUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.08.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> leewilliam</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDefinedSerializer</span> <span class="keyword">implements</span> <span class="title">Serializer</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs, <span class="keyword">boolean</span> isKey)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"configured"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"closed"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] serialize(String topic, Object data) &#123;</span><br><span class="line">        <span class="keyword">return</span> SerializationUtils.serialize((Serializable) data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="step2-新建反序列化器"><a href="#step2-新建反序列化器" class="headerlink" title="step2: 新建反序列化器"></a>step2: 新建反序列化器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.serialize3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.SerializationUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Deserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.08.23</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> leewilliam</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDefinedDeSerializer</span> <span class="keyword">implements</span> <span class="title">Deserializer</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs, <span class="keyword">boolean</span> isKey)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"configuring De"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"closing De"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">deserialize</span><span class="params">(String topic, <span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SerializationUtils.deserialize(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="step3-新建测试实体类"><a href="#step3-新建测试实体类" class="headerlink" title="step3: 新建测试实体类"></a>step3: 新建测试实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.serialize3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.08.28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> leewilliam</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> Integer id;</span><br><span class="line">   <span class="keyword">private</span> String name;</span><br><span class="line">   <span class="keyword">private</span> Date bod;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"id="</span> + id +</span><br><span class="line">                <span class="string">", name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", bod="</span> + bod +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Integer id, String name, Date bod)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.bod = bod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBod</span><span class="params">(Date bod)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bod = bod;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="step4-新建测试类"><a href="#step4-新建测试类" class="headerlink" title="step4: 新建测试类"></a>step4: 新建测试类</h3><p>先生产者消息发送Sender：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.serialize3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main.partition2.UserDefinedPartitioner;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.08.31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123; <span class="comment">// data needs serialization before sent</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,UserDefinedSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>; <span class="comment">//指定value序列化使用的类</span></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.PARTITIONER_CLASS_CONFIG, UserDefinedPartitioner<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line"></span><br><span class="line">        KafkaProducer&lt;String, User&gt; sender = <span class="keyword">new</span> KafkaProducer&lt;String, User&gt;(properties);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) &#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User(i, <span class="string">"大黄"</span> + i, <span class="keyword">new</span> Date());</span><br><span class="line">            System.out.println(user);</span><br><span class="line">            ProducerRecord&lt;String, User&gt; msg = <span class="keyword">new</span> ProducerRecord&lt;String, User&gt;(<span class="string">"AAA"</span>,String.valueOf(i),user);</span><br><span class="line">            System.out.println(<span class="string">"User"</span>+i+<span class="string">"\t was just sent...."</span>);</span><br><span class="line">            sender.send(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        sender.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看是否写进去：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at15.37.18.png" alt="AAA-P0"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at15.37.26.png" alt="AAA-P1"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at15.37.35.png" alt="AAA-P2"></p>
<p>再新建消费者并启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.serialize3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.08.39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,UserDefinedDeSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>; <span class="comment">//指定value序列化使用的类</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g1"</span>);</span><br><span class="line">        KafkaConsumer&lt;String, User&gt; receiver = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class="line">        receiver.subscribe(Arrays.asList(<span class="string">"AAA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, User&gt; records = receiver.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!records.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, User&gt;&gt; iterator = records.iterator();</span><br><span class="line">                <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, User&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                    User value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将sender里name前缀从“大黄”改成“二狗”，重新启动producer。</p>
<p>看测试结果：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at15.52.03.png" alt="生产者序列化"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at15.52.33.png" alt="消费者反序列化"></p>
<h2 id="自定义interceptor拦截器"><a href="#自定义interceptor拦截器" class="headerlink" title="自定义interceptor拦截器"></a>自定义interceptor拦截器</h2><p>新建拦截器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.interceptor4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.RecordMetadata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.10.21</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDeinedInterceptor</span> <span class="keyword">implements</span> <span class="title">ProducerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerRecord <span class="title">onSend</span><span class="params">(ProducerRecord record)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//拦截器操作, 对消息做一些追加操作</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProducerRecord(record.topic(), record.key(), record.value() + <span class="string">"追加_"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAcknowledgement</span><span class="params">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"metadata:\t"</span> + <span class="string">"&#123;topic:"</span> + metadata.topic() + <span class="string">",partition:"</span> + metadata.partition() + <span class="string">",offset:"</span> + metadata.offset() + <span class="string">",时间戳:"</span> + metadata.timestamp() + <span class="string">",异常:"</span> + exception + <span class="string">"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"closing..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先 启动一个Consumer订阅“AAA” topic的消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.interceptor4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> main.serialize3.UserDefinedDeSerializer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntercepteredConsumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">//消息接收到后要进行反序列化解析</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//消费者要指明属于哪一个消费者组</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 消费者创建</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. 订阅/消费 Message</span></span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"AAA"</span>));</span><br><span class="line">        <span class="comment">// 遍历消息队列</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                    String value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后新建生产者往“AAA” topic发布消息， 在生产者的配置中指定自定义的interceptor类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.interceptor4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> leewilliam</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IntercepteredProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        produce();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 和topic API一样, 生产者消费者的API首先也是要指明配置参数, 即kafka的基本配置信息</span></span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">//消息在进行网络传输的过程中要进行序列化</span></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 指定自定义的拦截器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG, UserDeinedInterceptor<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 2. 生产者创建</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">6</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// 创建producerrecord</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord =</span><br><span class="line">                    <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"AAA"</span>, String.valueOf(i));</span><br><span class="line">            <span class="comment">// 发送record</span></span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动生产者后查看生产者和消费者terminal的输出：</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at19.14.14.png" alt="生产者发送消息成功后调用输出的metadata"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at19.14.24.png" alt="消费者拦截后做了追加处理的结果"></p>
<h2 id="Offset控制"><a href="#Offset控制" class="headerlink" title="Offset控制"></a>Offset控制</h2><h3 id="ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置"><a href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置" class="headerlink" title="ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置"></a>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置</h3><p>在消费者consumerA首次订阅某主题消息topicB的时候, topicB是没有维护consumerA的offset信息的. 那么首次订阅该从什么offset位置开始消费呢? 该offset是有三种策略可选的:</p>
<ol>
<li>latest: [默认]配置, 表示consumerA会从topicB的最新offset位置开始消费, 即从consumerA订阅topicB开始后, 新进入topicB的消息才会被consumerA消费. </li>
<li>earlist: 表示consumerA会从topicB的最开始的offset位置开始消费, 即包括consumerA订阅topicB之前的所有消息都会被消费</li>
<li>none: 如果没找到当前消费者组之前提交的offset值, 会向调用者(消费者)抛异常. </li>
</ol> 
<span style="color:red">**值得注意的是: **offset**配置只会在消费者首次订阅消息的时候生效, 因为一旦开始订阅并消费消息后, 主题topicB 就会维护当前消费者consumerA 的消费的offsset信息, 下次再消费时会从维护的日志中获取consumerA的消费offset位置比如: O1,然后再继续从O1开始消费. **</span>
该配置在JAVA API中由 `ConsumerConfig.AUTO_OFFSET_RESET_CONFIG` 配置项配置.



<h3 id="ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试"><a href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试" class="headerlink" title="ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试"></a>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试</h3><p>为了检测上面的结论, 我们按照如下步骤进行测试:</p>
<h4 id="step1-首先新建一个主题topicA"><a href="#step1-首先新建一个主题topicA" class="headerlink" title="step1: 首先新建一个主题topicA"></a>step1: 首先新建一个主题topicA</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.admin.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.23.10.23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">topicManagement</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  AdminClient adminClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = prepareEnvironment();</span><br><span class="line">        adminClient = KafkaAdminClient.create(properties);</span><br><span class="line">        createTopicByMe(adminClient,<span class="string">"topicA"</span>);</span><br><span class="line">        listAllMyTopics(adminClient);</span><br><span class="line">        adminClient.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createTopicByMe</span><span class="params">(AdminClient adminClient,String topic2BCreated)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        CreateTopicsResult createTopicsResult =</span><br><span class="line">                adminClient.createTopics(Arrays.asList(<span class="keyword">new</span> NewTopic(topic2BCreated, <span class="number">3</span>, (<span class="keyword">short</span>) <span class="number">3</span>)));</span><br><span class="line">        createTopicsResult.all().get(); <span class="comment">// 触发同步创建</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listAllMyTopics</span><span class="params">(AdminClient adminClient)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        ListTopicsResult listTopicsResult = adminClient.listTopics();</span><br><span class="line">        Set&lt;String&gt; topicNames = listTopicsResult.names().get();</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (String topic : topicNames) &#123;</span><br><span class="line">            stringBuilder.append(topic+<span class="string">","</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查看topic的详细信息</span></span><br><span class="line">        String s = stringBuilder.toString();</span><br><span class="line">        String substring = s.substring(<span class="number">0</span>, s.length());</span><br><span class="line">        String[] split = substring.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        DescribeTopicsResult describeTopics = adminClient.describeTopics(Arrays.asList(split));</span><br><span class="line">        Map&lt;String, TopicDescription&gt; descMap = describeTopics.all().get();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, TopicDescription&gt; entry : descMap.entrySet()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"key:\t"</span> + entry.getKey());</span><br><span class="line">            System.out.println(<span class="string">"value:\t"</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Properties <span class="title">prepareEnvironment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(AdminClientConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从控制台输出可以看到topicA创建成功:<br><img src="/2020/10/28/Kafka/%E6%96%B0%E5%BB%BAtopicA.png" alt="新建topicA"></p>
<h4 id="step2-然后启动一个producer往往topicA里写入5条数据"><a href="#step2-然后启动一个producer往往topicA里写入5条数据" class="headerlink" title="step2: 然后启动一个producer往往topicA里写入5条数据;"></a>step2: 然后启动一个producer往往topicA里写入5条数据;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">         produce();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 2. 生产者创建</span></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord = </span><br><span class="line">                    <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"topicA"</span> ,  String.valueOf(i));</span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="step3-启动两个consumer"><a href="#step3-启动两个consumer" class="headerlink" title="step3: 启动两个consumer"></a>step3: 启动两个consumer</h4><p>然后分别启动consumer1(offset配置为latest)和consumer2(offset配置为earliest)订阅topicA. <br><strong>注意此时是两个消费者首次消费topicA</strong><br>conmuser1(offset设置latest):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlleredOffset1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g1"</span>);</span><br><span class="line">        <span class="comment">//offset设置latest</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    String value = next.value(); </span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line">    </span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>conmuser2 (offset设置earliest):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControlleredOffset2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g2"</span>);</span><br><span class="line">        <span class="comment">//offset设置earliest</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"topicA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    String value = next.value(); </span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                    <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line">    </span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="step4-观察首次消费日志"><a href="#step4-观察首次消费日志" class="headerlink" title="step4: 观察首次消费日志"></a>step4: 观察首次消费日志</h4><p>检查consumer1和consumer2的控制台输出.<br><br>consumer1消费结果:<br><img src="/2020/10/28/Kafka/consumer1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer1消费结果"><br>consumer2消费结果:<br><img src="/2020/10/28/Kafka/consumer2%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer2消费结果"></p>
<h4 id="step5-再次写消息"><a href="#step5-再次写消息" class="headerlink" title="step5: 再次写消息"></a>step5: 再次写消息</h4><p>停掉consumer1和consumer2,后执行step2的代码继续往topicA里写5条数据. (注意为了方便观察, for循环里value的值改成6~10)<br></p>
<h4 id="step6-观察再次消费日志"><a href="#step6-观察再次消费日志" class="headerlink" title="step6: 观察再次消费日志"></a>step6: 观察再次消费日志</h4><p>然后执行step3中的代码再次启动consumer1和consumer2. 观察consumer1和consumer2的控制台输出.<br><br><img src="/2020/10/28/Kafka/consumer1%E5%92%8C2%E7%AC%AC%E4%BA%8C%E6%AC%A1%E6%B6%88%E8%B4%B9%E7%BB%93%E6%9E%9C.png" alt="consumer1和2第二次消费结果"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line">规律: 用户提交的offset偏移量永远都要比本次消费的偏移量+1,代表着下一次消费要开始的offset便宜位置. 而offset值又是从0开始的, 所以consumer1和consumer2第一次消费过后都向kafka提交了的offset值是: 5.  </span><br><span class="line"><span class="code">`ConsumerConfig.AUTO_OFFSET_RESET_CONFIG`</span> 的配置又只在第一次消费时生效, 所以本次不管consumer1还是consumer2 第二次订阅topicA都是从offset: 5的位置开始消费.</span><br><span class="line"></span><br><span class="line">**</span><br></pre></td></tr></table></figure>



<p>step1 ~ step4 说明 <span style="color:red"><strong>offset的配置在消费者首次订阅某主题消息时后按照指定的<code>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</code>值(latest,earliest,none)生效.</strong></span><br><br> step5 ~ step6 说明<span style="color:red"><strong><code>ConsumerConfig.AUTO_OFFSET_RESET_CONFIG</code>值只在首次消费时生效</strong>. <br></span></p>
<h3 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启</h3><p>另外可以通过下面两行(也是官网的默认配置)设置自动提交的策略, 第一行开启, 第二行设置自动提交的时间间隔.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">true</span>);</span><br><span class="line">properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">5000</span>);</span><br></pre></td></tr></table></figure>














<h3 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试</h3><p>自动提交的具体测试步骤;</p>
<h4 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h4><p>新建AAA,开启生产者往AAA写5条数据 (具体可以参见ConsumerConfig.AUTO_OFFSET_RESET_CONFIG的step2和step3, 将topic名称改为AAA即可)</p>
<h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><p>编写消费者consumer3, 并开启消费者上面两行自动提交的配置<br><strong>注意: 自动提交配置, 使用的是put方法, 不是setProperty方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.offset1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAutoCommitConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"Node01:9092,Node02:9092,Node03:9092"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//指定消费者组g3</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"gc1"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">        <span class="comment">//自动提交配置, 注意是put方法, 不是setProperty方法. 只有配置项值的类型是String的时候两者一样, 否则只能用put</span></span><br><span class="line">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">true</span>);</span><br><span class="line">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG,<span class="number">20000</span>);</span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        consumer.subscribe(Pattern.compile(<span class="string">"AAA"</span>));</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    String topic = next.topic();<span class="comment">//获取下一条消息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();<span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    String key = next.key();<span class="comment">//获取消息key</span></span><br><span class="line">                    String value = next.value(); <span class="comment">//获取消息的value</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();<span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();<span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType(); <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h4><p>启动consumer3进行消费, 观察控制台结果如下. 然后尽快停掉应用(不要超过step2中设置的自动提交offset的时间间隔: 20秒)</p>
<h4 id="step4"><a href="#step4" class="headerlink" title="step4"></a><img src="/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%89%8D.png" alt="自动提交offset测试">step4</h4><p>再次启动consumer3进行消费, 发现还是从最开始offset:0的位置开始消费, 这次让进城多运行一会, 超过20秒后停掉应用.</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-11at15.33.04.png" alt="自动提交offset测试_提交前"></p>
<h4 id="step5"><a href="#step5" class="headerlink" title="step5"></a>step5</h4><p>第三次启动consumer3进行消费, 因为step4中gc1消费时间超过20秒, auto_commit自动提交过offset了, 所以此次启动时不会看到从0开始消费.<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4offset%E6%B5%8B%E8%AF%95_%E6%8F%90%E4%BA%A4%E5%90%8E.png" alt="自动提交offset测试"></p>
<h3 id="ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略"><a href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略" class="headerlink" title="ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略"></a>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略</h3><h4 id="step1-1"><a href="#step1-1" class="headerlink" title="step1"></a>step1</h4><p>新建BBB,开启生产者往BBB写10条数据 (具体可以参见ConsumerConfig.AUTO_OFFSET_RESET_CONFIG的step2和step3, 将topic名称改为BBB即可)</p>
<h4 id="step2-1"><a href="#step2-1" class="headerlink" title="step2"></a>step2</h4><p>编写消费者consumer4, 并将自动提交的配置 <code>ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG</code>置为false.</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> advanced.offset1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.TopicPartition;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfDefinedCommitStrategy</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            consume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">            Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">            properties.setProperty(</span><br><span class="line">                    ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">            properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">            properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g4"</span>);</span><br><span class="line">            properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"earliest"</span>);</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 关闭offset的自动提交</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG,<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 2. 消费者创建</span></span><br><span class="line">            KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">            <span class="comment">// 3. 订阅/消费 Message</span></span><br><span class="line">            consumer.subscribe(Pattern.compile(<span class="string">"BBB"</span>));</span><br><span class="line">            <span class="comment">// 遍历消息队列</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">                <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                    Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                    <span class="comment">//新建一个map集合来存储分区的offset信息, key是TopicPartition, 值是offset和元数据信息</span></span><br><span class="line">                    Map&lt;TopicPartition, OffsetAndMetadata&gt; offsetMap=<span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                        ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                        <span class="comment">//获取下一条消息</span></span><br><span class="line">                        String topic = next.topic();</span><br><span class="line">                        <span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                        <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                        <span class="comment">//获取消息key</span></span><br><span class="line">                        String key = next.key();</span><br><span class="line">                        <span class="comment">//获取消息的value</span></span><br><span class="line">                        String value = next.value();</span><br><span class="line">                        <span class="comment">//获取消息的偏移量</span></span><br><span class="line">                        <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                        <span class="comment">//获取消息的时间戳</span></span><br><span class="line">                        <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                        <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                        TimestampType timestampType = next.timestampType();</span><br><span class="line">                        Headers headers = next.headers();</span><br><span class="line">                        Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                        <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                        <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                        System.out.println(</span><br><span class="line">                                <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                                        <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                        );</span><br><span class="line">                        <span class="comment">//每次消费完之后都要提交offset和元数据信息, 也可以根据自己的业务需求去在合适的时机提交.</span></span><br><span class="line">                        offsetMap.put(<span class="keyword">new</span> TopicPartition(topic,partition),<span class="keyword">new</span> OffsetAndMetadata(offset+<span class="number">1</span>));</span><br><span class="line">                        consumer.commitAsync(offsetMap, <span class="keyword">new</span> OffsetCommitCallback() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, Exception exception)</span> </span>&#123;</span><br><span class="line">                                System.out.println(<span class="string">"提交了如下offset&amp;metadata信息: \t"</span>+<span class="string">"offset:\t"</span>+offsets+<span class="string">"\texception:\t"</span>+exception);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>发现确实有提交</p>
<p><img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_1.png" alt="自定义提交策略_1"></p>
<p> step3: 停掉消费进城后再次重启, 还是消费者组g4,此时再观察发现又消费到了: offset:4 (如下图:)<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_2.png" alt="自定义提交策略_2"><br> 这是为什么呢?<br> 因为消费者最后一次提交的offset的数值是下一次再次消费时开始订阅的起始位置, 也就是说第一次consumer4消费完之后提交的offset值是4, 所以下一次consumer4是从offset:4开始消费的.<br> 所以, 回到前面提到的规律:用户提交的offset偏移量永远都要比本次消费的偏移量+1, 所以修改step3的代码(offset–&gt;offset+1)后启动一次consumer4让他最后一次提交的offset为5:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">offsetMap.put(<span class="keyword">new</span> TopicPartition(topic,partition),<span class="keyword">new</span> OffsetAndMetadata(offset+<span class="number">1</span>));</span><br></pre></td></tr></table></figure><br> step4: 再次启动consumer4消费TopicC发现此次就消费不到了.<br> <img src="/2020/10/28/Kafka/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E7%AD%96%E7%95%A5_3.png" alt="自定义提交策略_3"></p>
<h2 id="确认应答与重试机制"><a href="#确认应答与重试机制" class="headerlink" title="确认应答与重试机制"></a>确认应答与重试机制</h2><h3 id="机制解释"><a href="#机制解释" class="headerlink" title="机制解释"></a>机制解释</h3><p> Kafka生产这在发送完一个消息后, 要求broker在规定的时间内进行Ack应答, 如果没有在规定的时间内进行应答, Kafka生产者会重试N次重新发送信息.<br> 而broker的确认应答机制可以有如下几种设置<br> <ol><br> <li>acks=1: 此时Leader会将record写到本地日志中, 但会在不等待所有follower都确认的情况下就做出响应. 这种情况下,如果Leader在确认应答后宕机, 那么记录会丢失. 因为follower还没有进行复制记录到副本.</li><br> <li>acks=0: 此时, 生产者根本不会等待broker做出任何确认, 该记录将立即添加到网络套接字缓冲区并视为已发送.这种情况下不能保证服务端broker已接收到信息.</li><br> <li>acks=all / acks=-1: 两种写法效果一样, 都是: Leader在接收到信息后需要等待全部ISR(in-sync replicas)同步副本确认.这就保证了, 只要至少一个同步副本处于活动状态, 记录就不会丢失. 这是最有力的保证</li><br> </ol><br> 如果生产者在规定时间内没有得到Leader的yingda , 可以开启retries重试机制.<br> request.timeout.ms=30000 (默认30秒)<br> retries=2147483647 (默认)</p>
<p> 具体可以参见官网文档3.3节的<a href="http://kafka.apache.org/documentation/#acks" target="_blank" rel="noopener">acks</a> 部分和4.8节的 <a href="http://kafka.apache.org/documentation/#design_ha" target="_blank" rel="noopener">Availability and Durability Guarantees</a> 部分</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p> step1: 启动消费者订阅CCC的消息:<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> advanced.Ack2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.header.Headers;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.record.TimestampType;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.09.41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcksConsumer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        consume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Step 1: kafka参数配置</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line">        <span class="comment">//消息接收到后要进行反序列化解析</span></span><br><span class="line">        properties.setProperty(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//消费者要指明属于哪一个消费者组</span></span><br><span class="line">        properties.put(ConsumerConfig.GROUP_ID_CONFIG,<span class="string">"g4"</span>);</span><br><span class="line">        properties.setProperty(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class="string">"latest"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 消费者创建</span></span><br><span class="line">        KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class="line">        <span class="comment">// 3. 订阅/消费 Message</span></span><br><span class="line">        consumer.subscribe(Collections.singletonList(<span class="string">"CCC"</span>));</span><br><span class="line">        <span class="comment">// 遍历消息队列</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">            ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">            <span class="keyword">if</span>(!consumerRecords.isEmpty())&#123;</span><br><span class="line">                Iterator&lt;ConsumerRecord&lt;String, String&gt;&gt; iterator = consumerRecords.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    ConsumerRecord&lt;String, String&gt; next = iterator.next();</span><br><span class="line">                    <span class="comment">//获取下一条消息</span></span><br><span class="line">                    String topic = next.topic();</span><br><span class="line">                    <span class="comment">//获取该消息所属分区信息</span></span><br><span class="line">                    <span class="keyword">int</span> partition = next.partition();</span><br><span class="line">                    <span class="comment">//获取消息key</span></span><br><span class="line">                    String key = next.key();</span><br><span class="line">                    <span class="comment">//获取消息的value</span></span><br><span class="line">                    String value = next.value();</span><br><span class="line">                    <span class="comment">//获取消息的偏移量</span></span><br><span class="line">                    <span class="keyword">long</span> offset = next.offset();</span><br><span class="line">                    <span class="comment">//获取消息的时间戳</span></span><br><span class="line">                    <span class="keyword">long</span> timestamp = next.timestamp();</span><br><span class="line">                    <span class="comment">// 获取消息的时间戳类型</span></span><br><span class="line">                    TimestampType timestampType = next.timestampType();</span><br><span class="line">                    Headers headers = next.headers();</span><br><span class="line">                    Optional&lt;Integer&gt; leaderEpoch = next.leaderEpoch();</span><br><span class="line">                    <span class="keyword">int</span> serializedKeySize = next.serializedKeySize();</span><br><span class="line">                    <span class="keyword">int</span> serializedValueSize = next.serializedValueSize();</span><br><span class="line">                    System.out.println(</span><br><span class="line">                            <span class="string">"topic:\t"</span>+topic+ <span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"key:\t"</span>+key+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"value:\t"</span>+value+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"offset:\t"</span>+offset+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"partition:\t"</span>+partition+<span class="string">"\t"</span>+</span><br><span class="line">                             <span class="string">"timestampType:\t"</span>+timestampType+<span class="string">"\t"</span>+</span><br><span class="line">                            <span class="string">"timestamp:\t"</span>+timestamp+<span class="string">"\t"</span></span><br><span class="line"></span><br><span class="line">                    );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br> step2: 启动生产者往topicC发布消息 (<strong>注意三行确认应答和重试机制的配置</strong>)<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.Ack2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * created by Joshua.H.Brooks on 2020.10月.22.12.48</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Joshua.H.Brooks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcksProducer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">         produce();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line"></span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 设置请求超时时间为1毫秒.</span></span><br><span class="line">        properties.put(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">// 设置确认应答机制为all, 即需要等待所有ISR副本确认</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"all"</span>);</span><br><span class="line">        <span class="comment">//设置重试3次, (不包含第一次)</span></span><br><span class="line">        properties.put(ProducerConfig.RETRIES_CONFIG,<span class="number">3</span>);</span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建producerrecord</span></span><br><span class="line">            ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"CCC"</span> , <span class="string">"acks"</span>,<span class="string">"ack test"</span>);</span><br><span class="line">            <span class="comment">// 发送record</span></span><br><span class="line">            producer.send(producerRecord);</span><br><span class="line">            <span class="comment">//Kafka发送数据默认会做缓冲(可配置)， 此处发送信息后刷新一下， 不缓冲</span></span><br><span class="line">            producer.flush();</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到producer的控制台的3次重试记录:<br> <img src="/2020/10/28/Kafka/%E9%87%8D%E8%AF%953%E6%AC%A1.png" alt="重试3次"><br> 也可以看到消费者控制台的消费记录(从生产者的代码和此处同一创建时间的消息记录有4个(初始发送和3次重试以供4次)不同offset的记录可以看出重复消费了.):<br> <img src="/2020/10/28/Kafka/%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9.png" alt="重复消费"></p>
<p> 确认应答与重试机制原理流程图参见如下:<br> <img src="/2020/10/28/Kafka/%E7%A1%AE%E8%AE%A4%E5%BA%94%E7%AD%94%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="确认应答与重试机制原理流程图"></p>
<h2 id="幂等写"><a href="#幂等写" class="headerlink" title="幂等写"></a>幂等写</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h3 id="流程描述"><a href="#流程描述" class="headerlink" title="流程描述"></a>流程描述</h3><p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at23.24.11.png" alt="幂等写流程"></p>
<p>在Ack-Retry 重试应答 的例子里， 如果生产者在发送消息之后， 服务器已经将数据写到对应分区， 但是应答的过程失败， 那么生产者重试之后， broker是不需要再将同样的消息记录写到分区的。</p>
<p>那么如何避免重复写呢？ 就引入了幂等写的概念。 幂等写又叫Exactly once。 是指同样的消息有且只有消费一次。即使重试写入多次， 也不会被消费者重新消费。</p>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><h4 id="step1-先启动消费者订阅消息："><a href="#step1-先启动消费者订阅消息：" class="headerlink" title="step1: 先启动消费者订阅消息："></a>step1: 先启动消费者订阅消息：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//与 类advanced.Ack2.AcksConsumer代码一致， 只是要先讲topic的消息清空。</span></span><br></pre></td></tr></table></figure>

<h4 id="step2-然后启动producer"><a href="#step2-然后启动producer" class="headerlink" title="step2: 然后启动producer"></a>step2: 然后启动producer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> advanced.idempotence;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在Ack-Retry 重试应答 的例子里， 如果生产者在发送消息之后， 服务器已经讲数据写到对应分区， 但是应答的过程失败， 那么生产者重试之后， broker是不需要再将同样的消息记录写到分区的。</span></span><br><span class="line"><span class="comment"> * 那么如何避免重复写呢？ 就引入了幂等写的概念。 幂等写又叫Exactly once。 是指同样的消息有且只有消费一次。即使重试写入多次， 也不会被消费者重新消费。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdempotentWrite</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 开启幂等写 (必须满足其他三个配置， 可以不配， 系统会自动设合适的， 但是乱配不符合要求会抛异常。)</span></span><br><span class="line"><span class="comment">         * When set to 'true', the producer will ensure that exactly one copy of each message is written in the stream. If 'false', producer retries due to broker failures, etc., may write duplicates of the retried message in the stream.</span></span><br><span class="line"><span class="comment">         * Note that enabling idempotence requires:</span></span><br><span class="line"><span class="comment">         * max.in.flight.requests.per.connection to be less than or equal to 5 (with message ordering preserved for any allowable value),</span></span><br><span class="line"><span class="comment">         * retries to be greater than 0,</span></span><br><span class="line"><span class="comment">         * and acks must be 'all'.</span></span><br><span class="line"><span class="comment">         * If these values are not explicitly set by the user, suitable values will be chosen. If incompatible values are set, a ConfigException will be thrown.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//单个连接有1个请求应答失败， 就陷入阻塞。该值不大于5。</span></span><br><span class="line">        properties.put(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION,<span class="number">1</span>);</span><br><span class="line">        properties.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        properties.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">// 设置请求超时时间为1毫秒.</span></span><br><span class="line">        properties.put(ProducerConfig.REQUEST_TIMEOUT_MS_CONFIG,<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">// 设置确认应答机制为all, 即需要等待所有ISR副本确认，</span></span><br><span class="line">        properties.put(ProducerConfig.ACKS_CONFIG,<span class="string">"all"</span>);</span><br><span class="line">        <span class="comment">//设置重试3次, (不包含第一次)</span></span><br><span class="line">        properties.put(ProducerConfig.RETRIES_CONFIG,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        KafkaProducer&lt;String, String&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建producerrecord</span></span><br><span class="line">        ProducerRecord&lt;String, String&gt; producerRecord = <span class="keyword">new</span> ProducerRecord&lt;&gt;(<span class="string">"CCC"</span> , <span class="string">"IDEMPOTENCE"</span>,<span class="string">"turned off"</span>);</span><br><span class="line">        <span class="comment">// 发送record</span></span><br><span class="line">        producer.send(producerRecord);</span><br><span class="line">        <span class="comment">//Kafka发送数据默认会做缓冲(可配置)， 此处发送信息后刷新一下， 不缓冲</span></span><br><span class="line">        producer.flush();</span><br><span class="line">        producer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="step3-观察现象（幂等写关闭的情况）"><a href="#step3-观察现象（幂等写关闭的情况）" class="headerlink" title="step3: 观察现象（幂等写关闭的情况）"></a>step3: 观察现象（幂等写<span style="color:red">关闭</span>的情况）</h4><p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at23.32.56.png" alt="producer重试三次"></p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at23.33.12.png" alt="消费四次"></p>
<h4 id="step4-开启幂等写重新生产"><a href="#step4-开启幂等写重新生产" class="headerlink" title="step4: 开启幂等写重新生产"></a>step4: 开启幂等写重新生产</h4><p>对上述生产者代码做如下修改</p>
<ol>
<li><p>28行改成<code>properties.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG,true);</code> 开启幂等写。</p>
</li>
<li><p>43行改成<code>ProducerRecord&lt;String, String&gt; producerRecord = new ProducerRecord&lt;&gt;(&quot;CCC&quot; , &quot;IDEMPOTENCE&quot;,&quot;ON&quot;);</code> 只是为了日志清晰。</p>
</li>
</ol>
<p>修改完再运行一次producer。</p>
<h4 id="step5-观察现象（幂等写开启的情况）"><a href="#step5-观察现象（幂等写开启的情况）" class="headerlink" title="step5: 观察现象（幂等写开启的情况）"></a>step5: 观察现象（幂等写<span style="color:red">开启</span>的情况）</h4><p>只比上一次消费者多了一行消费记录， 虽然生产者还是重试， 但是因为开启了幂等写， 重试的记录没有写到分区，所以消费者只消费了一次。</p>
<p><img src="/2020/10/28/Kafka/Screenshot2022-05-12at23.40.15.png" alt="开启幂等写同样消息仅且消费一次"></p>
<h2 id="生产者事务"><a href="#生产者事务" class="headerlink" title="生产者事务"></a>生产者事务</h2><h1 id="To-Be-Continued"><a href="#To-Be-Continued" class="headerlink" title="To Be Continued~"></a><span style="color:red">To Be Continued<del>~</del></span></h1>
    </div>



<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


  
</div>




    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Brooks.H.Joshua
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://52zhongneng.cn/2020/10/28/Kafka/" title="Kafka">https://52zhongneng.cn/2020/10/28/Kafka/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kafka/" rel="tag"><i class="fa fa-tag"></i>Kafka</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/05/designpatterns/" rel="prev" title="Designpatterns">
      <i class="fa fa-chevron-left"></i> Designpatterns
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/" rel="next" title="MySQL_Advanced_Optimization_01_性能监控篇">
      MySQL_Advanced_Optimization_01_性能监控篇 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
 


 <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#开始"><span class="nav-number">1.</span> <span class="nav-text">开始</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#引言"><span class="nav-number">1.1.1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#业务场景介绍"><span class="nav-number">1.1.2.</span> <span class="nav-text">业务场景介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解藕"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">解藕</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步通信"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">异步通信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#削峰填谷"><span class="nav-number">1.1.2.3.</span> <span class="nav-text">削峰填谷</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ工作模式"><span class="nav-number">1.1.3.</span> <span class="nav-text">MQ工作模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分发策略"><span class="nav-number">1.1.4.</span> <span class="nav-text">分发策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分区-amp-日志"><span class="nav-number">1.1.5.</span> <span class="nav-text">分区&amp;日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#offset"><span class="nav-number">1.1.6.</span> <span class="nav-text">offset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费者和消费者组"><span class="nav-number">1.1.7.</span> <span class="nav-text">消费者和消费者组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高性能之道"><span class="nav-number">1.1.8.</span> <span class="nav-text">高性能之道</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#顺序写入"><span class="nav-number">1.1.8.1.</span> <span class="nav-text">顺序写入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MMFile"><span class="nav-number">1.1.8.2.</span> <span class="nav-text">MMFile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#零拷贝（ZeroCopy）"><span class="nav-number">1.1.8.3.</span> <span class="nav-text">零拷贝（ZeroCopy）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#What–-gt-何为事件流"><span class="nav-number">1.1.9.</span> <span class="nav-text">What–&gt;何为事件流?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Where–-gt-事件流用在何处"><span class="nav-number">1.1.10.</span> <span class="nav-text">Where–&gt;事件流用在何处?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Why–-gt-Kafka如何支撑业务数据"><span class="nav-number">1.1.11.</span> <span class="nav-text">Why–&gt;Kafka如何支撑业务数据?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How–-gt-Kafka是如何运作的"><span class="nav-number">1.1.12.</span> <span class="nav-text">How–&gt;Kafka是如何运作的?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Terminologies"><span class="nav-number">1.1.13.</span> <span class="nav-text">Terminologies</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用例"><span class="nav-number">1.2.</span> <span class="nav-text">用例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息代理"><span class="nav-number">1.2.1.</span> <span class="nav-text">消息代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网页动态跟踪"><span class="nav-number">1.2.2.</span> <span class="nav-text">网页动态跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志整合"><span class="nav-number">1.2.3.</span> <span class="nav-text">日志整合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速入门"><span class="nav-number">1.3.</span> <span class="nav-text">快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-1-关闭防火墙"><span class="nav-number">1.3.1.</span> <span class="nav-text">Step 1 关闭防火墙</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-2-配置域名解析"><span class="nav-number">1.3.2.</span> <span class="nav-text">Step 2 配置域名解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-3-JDK配置"><span class="nav-number">1.3.3.</span> <span class="nav-text">Step 3 JDK配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Step-4-zookeeper配置"><span class="nav-number">1.3.4.</span> <span class="nav-text">Step 4 zookeeper配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step-5-kafka集群搭建"><span class="nav-number">1.3.5.</span> <span class="nav-text">step 5 kafka集群搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-properties配置文件详解"><span class="nav-number">1.3.6.</span> <span class="nav-text">server.properties配置文件详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#topic-操作"><span class="nav-number">1.4.</span> <span class="nav-text">topic 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看手册"><span class="nav-number">1.4.1.</span> <span class="nav-text">查看手册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看topic列表"><span class="nav-number">1.4.2.</span> <span class="nav-text">查看topic列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看topic存储分区信息"><span class="nav-number">1.4.3.</span> <span class="nav-text">查看topic存储分区信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建topic"><span class="nav-number">1.4.4.</span> <span class="nav-text">创建topic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看topic副本存储信息"><span class="nav-number">1.4.5.</span> <span class="nav-text">查看topic副本存储信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改topic分区数-只增不减"><span class="nav-number">1.4.6.</span> <span class="nav-text">修改topic分区数(只增不减)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除topic"><span class="nav-number">1.4.7.</span> <span class="nav-text">删除topic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#producer-操作"><span class="nav-number">1.5.</span> <span class="nav-text">producer 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#往指定topic发布消息"><span class="nav-number">1.5.1.</span> <span class="nav-text">往指定topic发布消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#consumer-操作"><span class="nav-number">1.6.</span> <span class="nav-text">consumer 操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#订阅指定topic的消息"><span class="nav-number">1.6.1.</span> <span class="nav-text">订阅指定topic的消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kafka-Eagle安装"><span class="nav-number">1.7.</span> <span class="nav-text">Kafka-Eagle安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KafkaEagle-使用"><span class="nav-number">1.8.</span> <span class="nav-text">KafkaEagle 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#新建topic"><span class="nav-number">1.8.1.</span> <span class="nav-text">新建topic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生态"><span class="nav-number">1.9.</span> <span class="nav-text">生态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#升级"><span class="nav-number">1.10.</span> <span class="nav-text">升级</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#APIs"><span class="nav-number">2.</span> <span class="nav-text">APIs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境准备"><span class="nav-number">2.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#topic-管理API"><span class="nav-number">2.2.</span> <span class="nav-text">topic 管理API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者-amp-消费者API"><span class="nav-number">2.3.</span> <span class="nav-text">生产者 &amp; 消费者API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Producer"><span class="nav-number">2.3.1.</span> <span class="nav-text">Producer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consumer"><span class="nav-number">2.3.2.</span> <span class="nav-text">Consumer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义分区"><span class="nav-number">2.4.</span> <span class="nav-text">自定义分区</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义消费者消费分区"><span class="nav-number">2.4.1.</span> <span class="nav-text">自定义消费者消费分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产者默认分区策略查看"><span class="nav-number">2.4.2.</span> <span class="nav-text">生产者默认分区策略查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产者使用自定义分区策略"><span class="nav-number">2.4.3.</span> <span class="nav-text">生产者使用自定义分区策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1-自定义分区策略"><span class="nav-number">2.4.3.1.</span> <span class="nav-text">step1: 自定义分区策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2-producer中指定配置："><span class="nav-number">2.4.3.2.</span> <span class="nav-text">step2: producer中指定配置：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义-反-序列化器"><span class="nav-number">2.5.</span> <span class="nav-text">自定义(反)序列化器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#step1-新建序列化器"><span class="nav-number">2.5.1.</span> <span class="nav-text">step1: 新建序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step2-新建反序列化器"><span class="nav-number">2.5.2.</span> <span class="nav-text">step2: 新建反序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step3-新建测试实体类"><span class="nav-number">2.5.3.</span> <span class="nav-text">step3: 新建测试实体类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#step4-新建测试类"><span class="nav-number">2.5.4.</span> <span class="nav-text">step4: 新建测试类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义interceptor拦截器"><span class="nav-number">2.6.</span> <span class="nav-text">自定义interceptor拦截器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Offset控制"><span class="nav-number">2.7.</span> <span class="nav-text">Offset控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG配置"><span class="nav-number">2.7.1.</span> <span class="nav-text">ConsumerConfig.AUTO_OFFSET_RESET_CONFIG配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsumerConfig-AUTO-OFFSET-RESET-CONFIG-测试"><span class="nav-number">2.7.2.</span> <span class="nav-text">ConsumerConfig.AUTO_OFFSET_RESET_CONFIG 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1-首先新建一个主题topicA"><span class="nav-number">2.7.2.1.</span> <span class="nav-text">step1: 首先新建一个主题topicA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2-然后启动一个producer往往topicA里写入5条数据"><span class="nav-number">2.7.2.2.</span> <span class="nav-text">step2: 然后启动一个producer往往topicA里写入5条数据;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step3-启动两个consumer"><span class="nav-number">2.7.2.3.</span> <span class="nav-text">step3: 启动两个consumer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step4-观察首次消费日志"><span class="nav-number">2.7.2.4.</span> <span class="nav-text">step4: 观察首次消费日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step5-再次写消息"><span class="nav-number">2.7.2.5.</span> <span class="nav-text">step5: 再次写消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step6-观察再次消费日志"><span class="nav-number">2.7.2.6.</span> <span class="nav-text">step6: 观察再次消费日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自动提交开启"><span class="nav-number">2.7.3.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自动提交开启</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-测试"><span class="nav-number">2.7.4.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1"><span class="nav-number">2.7.4.1.</span> <span class="nav-text">step1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2"><span class="nav-number">2.7.4.2.</span> <span class="nav-text">step2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step3"><span class="nav-number">2.7.4.3.</span> <span class="nav-text">step3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step4"><span class="nav-number">2.7.4.4.</span> <span class="nav-text">step4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step5"><span class="nav-number">2.7.4.5.</span> <span class="nav-text">step5</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsumerConfig-ENABLE-AUTO-COMMIT-CONFIG-自定义提交策略"><span class="nav-number">2.7.5.</span> <span class="nav-text">ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG 自定义提交策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1-1"><span class="nav-number">2.7.5.1.</span> <span class="nav-text">step1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2-1"><span class="nav-number">2.7.5.2.</span> <span class="nav-text">step2</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#确认应答与重试机制"><span class="nav-number">2.8.</span> <span class="nav-text">确认应答与重试机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#机制解释"><span class="nav-number">2.8.1.</span> <span class="nav-text">机制解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">2.8.2.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#幂等写"><span class="nav-number">2.9.</span> <span class="nav-text">幂等写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念"><span class="nav-number">2.9.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程描述"><span class="nav-number">2.9.2.</span> <span class="nav-text">流程描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-1"><span class="nav-number">2.9.3.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step1-先启动消费者订阅消息："><span class="nav-number">2.9.3.1.</span> <span class="nav-text">step1: 先启动消费者订阅消息：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step2-然后启动producer"><span class="nav-number">2.9.3.2.</span> <span class="nav-text">step2: 然后启动producer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step3-观察现象（幂等写关闭的情况）"><span class="nav-number">2.9.3.3.</span> <span class="nav-text">step3: 观察现象（幂等写关闭的情况）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step4-开启幂等写重新生产"><span class="nav-number">2.9.3.4.</span> <span class="nav-text">step4: 开启幂等写重新生产</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step5-观察现象（幂等写开启的情况）"><span class="nav-number">2.9.3.5.</span> <span class="nav-text">step5: 观察现象（幂等写开启的情况）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#生产者事务"><span class="nav-number">2.10.</span> <span class="nav-text">生产者事务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#To-Be-Continued"><span class="nav-number">3.</span> <span class="nav-text">To Be Continued~</span></a></li></ol></div>
      </div>
      <!--/noindex-->



      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Brooks.H.Joshua"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Brooks.H.Joshua</p>
  <div class="site-description" itemprop="description">Less Is More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/blog" title="https:&#x2F;&#x2F;spring.io&#x2F;blog" rel="noopener" target="_blank">Spring官博</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.itboyhub.com/" title="http:&#x2F;&#x2F;www.itboyhub.com&#x2F;" rel="noopener" target="_blank">JavaBoy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" title="https:&#x2F;&#x2F;www.cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html" rel="noopener" target="_blank">DSV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://visualgo.net/zh" title="https:&#x2F;&#x2F;visualgo.net&#x2F;zh" rel="noopener" target="_blank">DV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apache.org/index.html#projects-list" title="http:&#x2F;&#x2F;www.apache.org&#x2F;index.html#projects-list" rel="noopener" target="_blank">Apache</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">StackOverflow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://metacademy.org/" title="https:&#x2F;&#x2F;metacademy.org&#x2F;" rel="noopener" target="_blank">Metacademy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">WebNav</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.36zhen.com/t?id=3448" title="http:&#x2F;&#x2F;www.36zhen.com&#x2F;t?id&#x3D;3448" rel="noopener" target="_blank">前端书籍资料</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">G前端开发基础</a>
        </li>
    </ul>
  </div>

     
	<!--网易云音乐-->
	  <div id="music163player">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1002994&auto=1&height=66"></iframe>
	  </div>
      </div>

    </div>
  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Brooks.H.Joshua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">16:37</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

</html>
