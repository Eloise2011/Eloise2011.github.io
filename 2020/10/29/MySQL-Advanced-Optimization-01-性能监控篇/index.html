<!DOCTYPE html>
<html lang="en">
<meta name="referrer" content="no-referrer"/>
<head>

<!-- 爆炸效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>


  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"52zhongneng.cn","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本章将介绍show profile, performance_schema show processlist 等命令的常见用法">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL_Advanced_Optimization_01_性能监控篇">
<meta property="og:url" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="Eloise&#39;s Paradise">
<meta property="og:description" content="本章将介绍show profile, performance_schema show processlist 等命令的常见用法">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AFprofiling.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performace_schema%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AF%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%B9%B6%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8Dserver%E6%89%A7%E8%A1%8C%E4%BF%A1%E6%81%AF.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/events_waits_history%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0%E6%9C%80%E5%A4%9A%E7%9A%84instruments.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E7%AD%89%E5%BE%85%E6%97%B6%E9%95%BF%E6%9C%80%E9%95%BF%E7%9A%84instruments.png">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%9F%A5%E7%9C%8B%E5%8F%AF%E7%94%A8%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%8A%E5%85%B6%E5%BC%80%E5%90%AF%E6%83%85%E5%86%B5.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performance_timers%E8%A1%A8.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_consumer.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_instruments.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_actors.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_objects.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/threads.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%80%A7%E8%83%BD%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F.jpg">
<meta property="og:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/show_processlist.png">
<meta property="article:published_time" content="2020-10-29T05:44:08.000Z">
<meta property="article:modified_time" content="2022-07-06T03:36:34.973Z">
<meta property="article:author" content="Brooks.H.Joshua">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AFprofiling.png">

<link rel="canonical" href="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>MySQL_Advanced_Optimization_01_性能监控篇 | Eloise's Paradise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div id="id-header-inner"  class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eloise's Paradise</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">35</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">16</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">106</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>
	<!-- 改变css样式 -->
<script type="text/javascript">
var url = document.location.pathname;
var folderName = url.substr(1, url.length - 2)
console.log(folderName);

var listPostUrl = [
    "/" + folderName + "/" + "post-banner.png",
    "/" + folderName + "/" + "post-banner.jpg",
];

var nSuccessCount = 0;
var nResponceCount = 0;
function OnHttpResponse(bSuccess, strUrl) {
    console.log("OnHttpResponse: " + bSuccess + ", " + strUrl);
    nResponceCount++;
    if(nSuccessCount > 0){
        return;
    }
    if(bSuccess) {
        nSuccessCount++;
        document.getElementById("id-header-inner").style.backgroundImage = "url(" + strUrl + ")";
    }
    if(nResponceCount >= listPostUrl.length && nSuccessCount <= 0){
        // 使用默认图
        document.getElementById("id-header-inner").style.backgroundImage = "url(/images/background.jpg)";
    }
}

function changeBanner(strPostUrl, nIndex){
    console.log("try to load" + strPostUrl);
    var xmlhttp;
    if (window.XMLHttpRequest)
    {
        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
        xmlhttp=new XMLHttpRequest();
    }
    else
    {
        // IE6, IE5 浏览器执行代码
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
            OnHttpResponse(true, strPostUrl);
        } else {
            OnHttpResponse(false, strPostUrl);
        }
    }
    xmlhttp.open("HEAD",strPostUrl,true);
    xmlhttp.send();
}

listPostUrl.forEach(changeBanner);
</script>



    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL_Advanced_Optimization_01_性能监控篇
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-29 13:44:08" itemprop="dateCreated datePublished" datetime="2020-10-29T13:44:08+08:00">2020-10-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-06 11:36:34" itemprop="dateModified" datetime="2022-07-06T11:36:34+08:00">2022-07-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/RDBMs/" itemprop="url" rel="index">
                    <span itemprop="name">RDBMs</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>25 mins.</span>
            </span>


           
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本章将介绍<code>show profile</code>, <code>performance_schema</code> <code>show processlist</code> 等命令的常见用法 </p>
<a id="more"></a>



<h1 id="show-profile-查询剖析"><a href="#show-profile-查询剖析" class="headerlink" title="show profile (查询剖析)"></a>show profile (查询剖析)</h1><p>要使用<code>profiling</code>功能, 首先确保其已开启会话变量:profiling. 默认是关闭OFF(0), 可以通过set指令进行开启.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%profil%&#39;</span><br></pre></td></tr></table></figure>
<p>开启</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set profiling &#x3D;&#39;ON&#39;; -- 等号右边也可以是1, (0代表关闭, 1代表开启)</span><br></pre></td></tr></table></figure>
<p>profiling设置是会话级别的, 关闭会话则profiling信息会消失.</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AFprofiling.png" alt="开启profiling"></p>
<p>官网给出的<code>show profile</code> 指令格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILE [type [, type] ... ]</span><br><span class="line">    [FOR QUERY n]</span><br><span class="line">    [LIMIT row_count [OFFSET offset]]</span><br><span class="line"></span><br><span class="line">type: &#123;</span><br><span class="line">    ALL</span><br><span class="line">  | BLOCK IO</span><br><span class="line">  | CONTEXT SWITCHES</span><br><span class="line">  | CPU</span><br><span class="line">  | IPC</span><br><span class="line">  | MEMORY</span><br><span class="line">  | PAGE FAULTS</span><br><span class="line">  | SOURCE</span><br><span class="line">  | SWAPS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>show profiles</code>: 注意带s, 该指令会返回最近一批发送到服务端的查询语句的信息(包含query_id, duration, statements),具体返回多少条由<code>profiling_history_size</code>变量决定. 其默认值是15, 上限100. 如果设置为0, 等效于: <code>set profiling =&#39;OFF&#39;;</code>  </p>
<p>MySQL5.7版本官网提示, show profile有可能不会在未来版本中出现,  取而代之的将会是 <code>performance schema</code> 性能模式.</p>
<p><strong>The SHOW PROFILE and SHOW PROFILES statements are deprecated and will be removed in a future MySQL release. Use the Performance Schema instead; see <a href="https://dev.mysql.com/doc/refman/5.7/en/performance-schema-query-profiling.html" target="_blank" rel="noopener">Section 25.19.1, “Query<br> Profiling Using Performance Schema”</a>.</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show profile all for query 1; -- 查询性能详细信息</span><br></pre></td></tr></table></figure>
<p><strong>如果不指明for query n, 则返回最近一条查询语句的性能分析.</strong></p>
<p>![show_profile_all](MySQL-Advanced-Optimization-01-性能监控篇/show profiles_1_all.png)</p>
<p><strong>总结: show profile可以查看的信息有: 功能较少新版本即将被性能模式(Performance Schema)取代.</strong></p>
<h1 id="performance-schema-高级查询剖析"><a href="#performance-schema-高级查询剖析" class="headerlink" title="performance schema (高级查询剖析)"></a><a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-quick-start.html" target="_blank" rel="noopener">performance schema (高级查询剖析)</a></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>MySQL的performance schema 用于监控MySQL server在一个较低级别的运行过程中的资源消耗、资源等待等情况</strong>。<br>特点如下：<br>​1、提供了一种在数据库运行时实时检查server的内部执行情况的方法。performance_schema 数据库中的表使用performance_schema存储引擎。该数据库主要关注数据库运行过程中的性能相关的数据，与information_schema不同，information_schema主要关注server运行过程中的元数据信息<br>​2、performance_schema通过监视server的事件来实现监视server内部运行情况， “事件”就是server内部活动中所做的任何事情以及对应的时间消耗，利用这些信息来判断server中的相关资源消耗在了哪里？一般来说，事件可以是函数调用、操作系统的等待、SQL语句执行的阶段（如sql语句执行过程中的parsing 或 sorting阶段）或者整个SQL语句与SQL语句集合。事件的采集可以方便的提供server中的相关存储引擎对磁盘文件、表I/O、表锁等资源的同步调用信息。<br>​3、performance_schema中的事件与写入二进制日志中的事件（描述数据修改的events）、事件计划调度程序（这是一种存储程序）的事件不同。performance_schema中的事件记录的是server执行某些活动对某些资源的消耗、耗时、这些活动执行的次数等情况。<br>​4、performance_schema中的事件只记录在本地server的performance_schema中，其下的这些表中数据发生变化时不会被写入binlog中，也不会通过复制机制被复制到其他server中。<br>​5、 当前活跃事件、历史事件和事件摘要相关的表中记录的信息。能提供某个事件的执行次数、使用时长。进而可用于分析某个特定线程、特定对象（如mutex或file）相关联的活动。<br>​6、PERFORMANCE_SCHEMA存储引擎使用server源代码中的“检测点”来实现事件数据的收集。对于performance_schema实现机制本身的代码没有相关的单独线程来检测，这与其他功能（如复制或事件计划程序）不同<br>​7、收集的事件数据存储在performance_schema数据库的表中。这些表可以使用SELECT语句查询，也可以使用SQL语句更新performance_schema数据库中的表记录（如动态修改performance_schema的setup_*开头的几个配置表，但要注意：配置表的更改会立即生效，这会影响数据收集）<br>​8、performance_schema的表中的数据不会持久化存储在磁盘中，而是保存在内存中，一旦服务器重启，这些数据会丢失（包括配置表在内的整个performance_schema下的所有数据）<br>​9、MySQL支持的所有平台中事件监控功能都可用，但不同平台中用于统计事件时间开销的计时器类型可能会有所差异。</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performace_schema%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7%E5%88%97%E8%A1%A8.png" alt="performace_schema相关属性列表"><br>在mysql的5.7版本中Performance Schemap配置是默认开启的. 如果想要显式的关闭的话需要修改配置文件，不能直接进行修改，会报错Variable ‘performance_schema’ is a read only variable。可以通过修改MySQL服务端配置文件<code>my.cnf</code>,在其中添加如下配置行显示地开启或者关闭该配置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">--查看performance_schema的属性</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema&#39;;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| performance_schema | ON    |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">--在配置文件中修改performance_schema的属性值，on表示开启，off表示关闭</span><br><span class="line">[mysqld]</span><br><span class="line">performance_schema&#x3D;ON</span><br><span class="line"></span><br><span class="line">--切换数据库</span><br><span class="line">use performance_schema;</span><br><span class="line"></span><br><span class="line">--查看当前数据库下的所有表,会看到有很多表存储着相关的信息</span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">--可以通过show create table tablename来查看创建表的时候的表结构</span><br><span class="line">mysql&gt; show create table setup_consumers;</span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">| Table           | Create Table                    </span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">| setup_consumers | CREATE TABLE &#96;setup_consumers&#96; (</span><br><span class="line">  &#96;NAME&#96; varchar(64) NOT NULL,                      </span><br><span class="line">  &#96;ENABLED&#96; enum(&#39;YES&#39;,&#39;NO&#39;) NOT NULL               </span><br><span class="line">) ENGINE&#x3D;PERFORMANCE_SCHEMA DEFAULT CHARSET&#x3D;utf8 |  </span><br><span class="line">+-----------------+---------------------------------</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>


<p>想要搞明白后续的内容，需要理解两个基本概念：<br>instruments: 生产者，用于采集mysql中各种各样的操作产生的事件信息，对应配置表中的配置项我们可以称为监控采集配置项。<br>consumers:   消费者，对应的消费者表用于存储来自instruments采集的数据，对应配置表中的配置项我们可以称为消费存储配置项。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--语句事件记录表，这些表记录了语句事件信息，当前语句事件表events_statements_current、历史语句事件表events_statements_history和长语句历史事件表events_statements_history_long、以及聚合后的摘要表summary，其中，summary表还可以根据帐号(account)，主机(host)，程序(program)，线程(thread)，用户(user)和全局(global)再进行细分)</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%statement%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--等待事件记录表，与语句事件类型的相关记录表类似：</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%wait%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--阶段事件记录表，记录语句执行的阶段事件的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%stage%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--事务事件记录表，记录事务相关的事件的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%transaction%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监控文件系统层调用的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%file%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--监视内存使用的表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%memory%'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--动态对performance_schema进行配置的配置表</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'%setup%'</span>;</span><br></pre></td></tr></table></figure>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">performance_schema&#x3D;ON</span><br></pre></td></tr></table></figure>
<p>通过如下命令可以验证<code>performance schema</code>开启与否:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema&#39;;</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line">+--------------------+-------+</span><br><span class="line">| performance_schema | ON    |</span><br><span class="line">+--------------------+-------+</span><br></pre></td></tr></table></figure>
<p>ON表示开启成功, OFF表示有错误, 此时应该查看错误日志.<br><code>Performance Schema</code> 本质上是存储引擎的一种实现, 所以执行如下命令会有响应的输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM INFORMATION_SCHEMA.ENGINES WHERE ENGINE&#x3D;&#39;PERFORMANCE_SCHEMA&#39;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">      ENGINE: PERFORMANCE_SCHEMA</span><br><span class="line">     SUPPORT: YES</span><br><span class="line">     COMMENT: Performance Schema</span><br><span class="line">TRANSACTIONS: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  SAVEPOINTS: NO</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW ENGINES\G</span><br><span class="line">...</span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: NO</span><br><span class="line">          XA: NO</span><br><span class="line">  Savepoints: NO</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>performance_schema</code>存储引擎作用于<code>performance_schema</code>库中的表.<br><code>performance_schema</code>库及其中表的结构信息可以从<code>INFORMATION_SCHEMA</code>库中获取. 一下两种方式都能查看<code>performance_schema</code>库中的表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES</span><br><span class="line">       WHERE TABLE_SCHEMA &#x3D; &#39;performance_schema&#39;;</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| TABLE_NAME                                           |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| accounts                                             |</span><br><span class="line">| cond_instances                                       |</span><br><span class="line">...</span><br><span class="line">| events_stages_current                                |</span><br><span class="line">| events_stages_history                                |</span><br><span class="line">| events_stages_history_long                           |</span><br><span class="line">| events_stages_summary_by_account_by_event_name       |</span><br><span class="line">| events_stages_summary_by_host_by_event_name          |</span><br><span class="line">| events_stages_summary_by_thread_by_event_name        |</span><br><span class="line">| events_stages_summary_by_user_by_event_name          |</span><br><span class="line">| events_stages_summary_global_by_event_name           |</span><br><span class="line">| events_statements_current                            |</span><br><span class="line">| events_statements_history                            |</span><br><span class="line">| events_statements_history_long                       |</span><br><span class="line">...</span><br><span class="line">| file_instances                                       |</span><br><span class="line">| file_summary_by_event_name                           |</span><br><span class="line">| file_summary_by_instance                             |</span><br><span class="line">| host_cache                                           |</span><br><span class="line">| hosts                                                |</span><br><span class="line">| memory_summary_by_account_by_event_name              |</span><br><span class="line">| memory_summary_by_host_by_event_name                 |</span><br><span class="line">| memory_summary_by_thread_by_event_name               |</span><br><span class="line">| memory_summary_by_user_by_event_name                 |</span><br><span class="line">| memory_summary_global_by_event_name                  |</span><br><span class="line">| metadata_locks                                       |</span><br><span class="line">| mutex_instances                                      |</span><br><span class="line">| objects_summary_global_by_type                       |</span><br><span class="line">| performance_timers                                   |</span><br><span class="line">| replication_connection_configuration                 |</span><br><span class="line">| replication_connection_status                        |</span><br><span class="line">| replication_applier_configuration                    |</span><br><span class="line">| replication_applier_status                           |</span><br><span class="line">| replication_applier_status_by_coordinator            |</span><br><span class="line">| replication_applier_status_by_worker                 |</span><br><span class="line">| rwlock_instances                                     |</span><br><span class="line">| session_account_connect_attrs                        |</span><br><span class="line">| session_connect_attrs                                |</span><br><span class="line">| setup_actors                                         |</span><br><span class="line">| setup_consumers                                      |</span><br><span class="line">| setup_instruments                                    |</span><br><span class="line">| setup_objects                                        |</span><br><span class="line">| socket_instances                                     |</span><br><span class="line">| socket_summary_by_event_name                         |</span><br><span class="line">| socket_summary_by_instance                           |</span><br><span class="line">| table_handles                                        |</span><br><span class="line">| table_io_waits_summary_by_index_usage                |</span><br><span class="line">| table_io_waits_summary_by_table                      |</span><br><span class="line">| table_lock_waits_summary_by_table                    |</span><br><span class="line">| threads                                              |</span><br><span class="line">| users                                                |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SHOW TABLES FROM performance_schema;</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| Tables_in_performance_schema                         |</span><br><span class="line">+------------------------------------------------------+</span><br><span class="line">| accounts                                             |</span><br><span class="line">| cond_instances                                       |</span><br><span class="line">| events_stages_current                                |</span><br><span class="line">| events_stages_history                                |</span><br><span class="line">| events_stages_history_long                           |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>performance_schema</code>库中的表会随着时间 的推移而越来越多. 因为会有越来越多的instrument生产者事件. 根据采集信息的类别, </p>
<h2 id="performance-schema表的分类"><a href="#performance-schema表的分类" class="headerlink" title="performance_schema表的分类"></a>performance_schema表的分类</h2><p>performance_schema库下的表可以按收集信息类型可以进行如下分组:<br> 当前事件表(Current events), 历史事件和总结表(event histories and summaries), 对象实例表(object instances), and 配置信息表(setup (configuration) information)<br>下面简单展示了几个这些表的部分操作, 详细操作信息可以参考官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-table-descriptions.html" target="_blank" rel="noopener">Section 26.12, “Performance Schema Table Descriptions”.</a></p>
<p>首先, 并非所有生产者和消费者配置项都是开启的, 所以performance schema并非默认搜集所有事件信息. 要想开启所有事件采集和消费的配置并开启计时配置, 执行下面的两行命令即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE performance_schema.setup_instruments</span><br><span class="line">       SET ENABLED &#x3D; &#39;YES&#39;, TIMED &#x3D; &#39;YES&#39;;</span><br><span class="line">Query OK, 560 rows affected (0.04 sec)</span><br><span class="line">mysql&gt; UPDATE performance_schema.setup_consumers</span><br><span class="line">       SET ENABLED &#x3D; &#39;YES&#39;;</span><br><span class="line">Query OK, 10 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>要查看服务器当前正在执行说明可以执行下面的命令, 输出结果每一行代表一个线程最近执行的操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT *</span><br><span class="line">       FROM performance_schema.events_waits_current\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">            THREAD_ID: 0</span><br><span class="line">             EVENT_ID: 5523</span><br><span class="line">         END_EVENT_ID: 5523</span><br><span class="line">           EVENT_NAME: wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex</span><br><span class="line">               SOURCE: thr_lock.c:525</span><br><span class="line">          TIMER_START: 201660494489586</span><br><span class="line">            TIMER_END: 201660494576112</span><br><span class="line">           TIMER_WAIT: 86526</span><br><span class="line">                SPINS: NULL</span><br><span class="line">        OBJECT_SCHEMA: NULL</span><br><span class="line">          OBJECT_NAME: NULL</span><br><span class="line">           INDEX_NAME: NULL</span><br><span class="line">          OBJECT_TYPE: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 142270668</span><br><span class="line">     NESTING_EVENT_ID: NULL</span><br><span class="line">   NESTING_EVENT_TYPE: NULL</span><br><span class="line">            OPERATION: lock</span><br><span class="line">      NUMBER_OF_BYTES: NULL</span><br><span class="line">                FLAGS: 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>上述输出结果的说明:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  该事件表示线程id为0的线程正在等待子系统mysys的互斥锁:THR_LOCK::mutex，等待时间为86526皮秒(1皮秒=一万亿分之一秒).</span></span><br><span class="line"><span class="comment">//  属性说明：</span></span><br><span class="line"><span class="comment">//	id:事件来自哪个线程，事件编号是多少</span></span><br><span class="line"><span class="comment">//	event_name:表示检测到的具体的内容</span></span><br><span class="line"><span class="comment">//	source:表示这个检测代码在哪个源文件中以及行号</span></span><br><span class="line"><span class="comment">//	timer_start:表示该事件的开始时间</span></span><br><span class="line"><span class="comment">//	timer_end:表示该事件的结束时间</span></span><br><span class="line"><span class="comment">//	timer_wait:表示该事件总的花费时间</span></span><br><span class="line"><span class="comment">// 注意：_current表中每个线程只保留一条记录，一旦线程完成工作，该表中不会再记录该线程的事件信息, 如果事件未结束, 那么timer_end和timer_wait会是空.</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E5%BC%80%E5%90%AF%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6%E9%85%8D%E7%BD%AE%E9%A1%B9%E5%B9%B6%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8Dserver%E6%89%A7%E8%A1%8C%E4%BF%A1%E6%81%AF.png" alt="开启等待事件配置项并查看当前server执行信息"></p>
<p>历史表和当前事件表的结构信息类似,只是历史表记录的是服务器最近(recently)执行的操作, 而不是当前(currently)  .</p>
<p> <code>events_waits_history</code>表: 显示每个线程最近的十个事件信息.<br> <code>events_waits_history_long</code>表: 显示最近的1000个事件.<br>For example, to see information for recent events produced by thread 13, do this:<br>若想查看线程13最近执行的事件信息, 可以执行命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT EVENT_ID, EVENT_NAME, TIMER_WAIT</span><br><span class="line">       FROM performance_schema.events_waits_history</span><br><span class="line">       WHERE THREAD_ID &#x3D; 13</span><br><span class="line">       ORDER BY EVENT_ID;</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br><span class="line">| EVENT_ID | EVENT_NAME                              | TIMER_WAIT |</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br><span class="line">|       86 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex  |     686322 |</span><br><span class="line">|       87 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     320535 |</span><br><span class="line">|       88 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     339390 |</span><br><span class="line">|       89 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     377100 |</span><br><span class="line">|       90 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin        |     614673 |</span><br><span class="line">|       91 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_open          |     659925 |</span><br><span class="line">|       92 | wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;THD::LOCK_thd_data |     494001 |</span><br><span class="line">|       93 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     222489 |</span><br><span class="line">|       94 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc  |     214947 |</span><br><span class="line">|       95 | wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm       |     312993 |</span><br><span class="line">+----------+-----------------------------------------+------------+</span><br></pre></td></tr></table></figure>

<p>当历史表存满后, 新来的时间会被插入, 而历史事件会被清除.<br>select thread_id,event_id,event_name,timer_wait from events_waits_history order by thread_id limit 21;</p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/events_waits_history%E8%A1%A8%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C.png" alt="events_waits_history表查询结果"></p>
<p>总结表(Summary tables)存储的是所有事件按时间聚合的信息, 聚合的方式可以是多样的.为了查看哪个instruments事件执行次数最多, 或者等待时长最长,查询<code>events_waits_summary_global_by_event_name</code>表, 并按COUNT_STAR 或 SUM_TIMER_WAIT列进行排序即可.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT EVENT_NAME, COUNT_STAR</span><br><span class="line">       FROM performance_schema.events_waits_summary_global_by_event_name</span><br><span class="line">       ORDER BY COUNT_STAR DESC LIMIT 10;</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line">| EVENT_NAME                                        | COUNT_STAR |</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc            |       6419 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;FRM                              |        452 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin                  |        337 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_open              |        187 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm                 |        147 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;THD::LOCK_thd_data           |        115 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile                         |        102 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_system_variables |         89 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK::mutex            |         89 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_open                    |         88 |</span><br><span class="line">+---------------------------------------------------+------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT EVENT_NAME, SUM_TIMER_WAIT</span><br><span class="line">       FROM performance_schema.events_waits_summary_global_by_event_name</span><br><span class="line">       ORDER BY SUM_TIMER_WAIT DESC LIMIT 10;</span><br><span class="line">+----------------------------------------+----------------+</span><br><span class="line">| EVENT_NAME                             | SUM_TIMER_WAIT |</span><br><span class="line">+----------------------------------------+----------------+</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;MYSQL_LOG             |     1599816582 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;THR_LOCK_malloc |     1530083250 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog_index          |     1385291934 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;FRM                   |     1292823243 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile              |      411193611 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;dfile              |      322401645 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;LOCK_alarm      |      145126935 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;casetest              |      104324715 |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_plugin       |       86027823 |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;pid                   |       72591750 |</span><br><span class="line">+----------------------------------------+----------------+</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%89%A7%E8%A1%8C%E6%AC%A1%E6%95%B0%E6%9C%80%E5%A4%9A%E7%9A%84instruments.png" alt="执行次数最多的instruments"></p>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E7%AD%89%E5%BE%85%E6%97%B6%E9%95%BF%E6%9C%80%E9%95%BF%E7%9A%84instruments.png" alt="等待时长最长的instruments"></p>
<p>instance表记录了哪些类型的对象会被检测。这些对象在被server使用时，在该表中将会产生一条事件记录，这些表提供了事件名称和一些解释信息, 状态信息等. 例如，file_instances表列出了文件I/O操作及其关联文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT *</span><br><span class="line">       FROM performance_schema.file_instances\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql-log&#x2F;60500&#x2F;binlog.000007</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog</span><br><span class="line">OPEN_COUNT: 0</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql&#x2F;60500&#x2F;data&#x2F;mysql&#x2F;tables_priv.MYI</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile</span><br><span class="line">OPEN_COUNT: 1</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line"> FILE_NAME: &#x2F;opt&#x2F;mysql&#x2F;60500&#x2F;data&#x2F;mysql&#x2F;columns_priv.MYI</span><br><span class="line">EVENT_NAME: wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;kfile</span><br><span class="line">OPEN_COUNT: 1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>setup表用来配置和展示监控特征.例如, 表<code>setup_instruments</code> 罗列了哪些instruments事件被采集, 被计时等.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT NAME, ENABLED, TIMED</span><br><span class="line">       FROM performance_schema.setup_instruments;</span><br><span class="line">+---------------------------------------------------+---------+-------+</span><br><span class="line">| NAME                                              | ENABLED | TIMED |</span><br><span class="line">+---------------------------------------------------+---------+-------+</span><br><span class="line">...</span><br><span class="line">| stage&#x2F;sql&#x2F;end                                     | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;executing                               | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;init                                    | NO      | NO    |</span><br><span class="line">| stage&#x2F;sql&#x2F;insert                                  | NO      | NO    |</span><br><span class="line">...</span><br><span class="line">| statement&#x2F;sql&#x2F;load                                | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;grant                               | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;check                               | YES     | YES   |</span><br><span class="line">| statement&#x2F;sql&#x2F;flush                               | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_read_lock        | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_global_system_variables | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_lock_db                 | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_manager                 | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_grant                  | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOGGER::LOCK_logger         | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_sys_init_connect       | YES     | YES   |</span><br><span class="line">| wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;LOCK_sys_init_slave         | YES     | YES   |</span><br><span class="line">...</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog                           | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;binlog_index                     | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;casetest                         | YES     | YES   |</span><br><span class="line">| wait&#x2F;io&#x2F;file&#x2F;sql&#x2F;dbopt                            | YES     | YES   |</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>To control whether events are collected for an instrument, set its ENABLED value to YES or NO. For example:<br>通过修改<code>performance_schema.setup_instruments</code>表的enable列的值, 可以达到配置事件是否被采集.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; UPDATE performance_schema.setup_instruments</span><br><span class="line">       SET ENABLED &#x3D; &#39;NO&#39;</span><br><span class="line">       WHERE NAME &#x3D; &#39;wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_mysql_create_db&#39;;</span><br></pre></td></tr></table></figure>
<p>性能模式通过采集到的事件信息去更新<code>performance schema</code>库下的表, 这个就是”消费者”的操作. <code>setup_consumers</code>列出了可用的消费者及其开启情况.<br><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%9F%A5%E7%9C%8B%E5%8F%AF%E7%94%A8%E6%B6%88%E8%B4%B9%E8%80%85%E5%8F%8A%E5%85%B6%E5%BC%80%E5%90%AF%E6%83%85%E5%86%B5.jpg" alt="查看可用消费者及其开启情况"> </p>
<p>为了控制性能模式是否维护事件信息到消费者, 可以设置上图中的<code>enable</code>为yes. 更多setup表的详细配置信息参见官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-filtering.html" target="_blank" rel="noopener">Section 26.4.2, “Performance Schema Event Filtering”</a></p>
<p>解释:<br>instrument name命名规则参见官网<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-instrument-naming.html" target="_blank" rel="noopener">Section 26.6, “Performance Schema Instrument Naming Conventions”.</a><br>An instrument name consists of a sequence of elements separated by ‘/‘ characters. Example names:<br>一个生产者名称由一串以<code>/</code>分割的字符串元素组成, 如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;log</span><br><span class="line">wait&#x2F;io&#x2F;file&#x2F;mysys&#x2F;charset</span><br><span class="line">wait&#x2F;lock&#x2F;table&#x2F;sql&#x2F;handler</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;mysys&#x2F;COND_alarm</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;sql&#x2F;BINLOG::update_cond</span><br><span class="line">wait&#x2F;synch&#x2F;mutex&#x2F;mysys&#x2F;BITMAP_mutex</span><br><span class="line">wait&#x2F;synch&#x2F;mutex&#x2F;sql&#x2F;LOCK_delete</span><br><span class="line">wait&#x2F;synch&#x2F;rwlock&#x2F;sql&#x2F;Query_cache_query::lock</span><br><span class="line">stage&#x2F;sql&#x2F;closing tables</span><br><span class="line">stage&#x2F;sql&#x2F;Sorting result</span><br><span class="line">statement&#x2F;com&#x2F;Execute</span><br><span class="line">statement&#x2F;com&#x2F;Query</span><br><span class="line">statement&#x2F;sql&#x2F;create_table</span><br><span class="line">statement&#x2F;sql&#x2F;lock_tables</span><br><span class="line">errors</span><br></pre></td></tr></table></figure>
<p>该树形结构的名称从左往右逐步具象化.一个instruments所拥有的元素的个数由其类型决定. 给定元素的意义由其左边所有元素一起决定.<br>例如, myisam出现在如下两个instruments名称中, 但是, 一个与文件io有关, 而第二个则与同步有关.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wait&#x2F;io&#x2F;file&#x2F;myisam&#x2F;log</span><br><span class="line">wait&#x2F;synch&#x2F;cond&#x2F;myisam&#x2F;MI_SORT_INFO::cond</span><br></pre></td></tr></table></figure>

<p>生产者名称(instrument name)是由一个前缀(其结构由Performance Schema而定)和一个后缀(程序自定义的)构成. 前缀的顶层元素表明了生产者的类型. 可以有如下家中形式:<br>idle: 空闲事件. 该生产者没有更深层的元素.<br>error: 错误事件.该生产者没有更深层的元素.<br>memory: 内存事件.<br>stage: 阶段事件.<br>statement: 语句事件.<br>transaction: 事务事件. 该生产者没有更深层的元素.<br>wait: 等待事件.</p>
<h2 id="常用配置项的参数说明-重点"><a href="#常用配置项的参数说明-重点" class="headerlink" title="常用配置项的参数说明(重点)"></a>常用配置项的参数说明<font color="red">(重点)</font></h2><p>1、启动选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_consumer_events_statements_current&#x3D;TRUE</span><br><span class="line">-- 是否在mysql server启动时就开启events_statements_current表的记录功能(该表记录当前的语句事件信息)，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新setup_consumers配置表中的events_statements_current配置项，默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_statements_history&#x3D;TRUE</span><br><span class="line">-- 与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件短历史信息，默认为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_events_stages_history_long&#x3D;FALSE</span><br><span class="line">-- 与performance_schema_consumer_events_statements_current选项类似，但该选项是用于配置是否记录语句事件长历史信息，默认为FALSE</span><br><span class="line"></span><br><span class="line">-- 除了statement(语句)事件之外，还支持：wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个启动项分别进行配置，但这些等待事件默认未启用，如果需要在MySQL Server启动时一同启动，则通常需要写进my.cnf配置文件中</span><br><span class="line">-- performance_schema_consumer_global_instrumentation&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启全局表（如：mutex_instances、rwlock_instances、cond_instances、file_instances、users、hostsaccounts、socket_summary_by_event_name、file_summary_by_instance等大部分的全局对象计数统计和事件汇总统计信息表 ）的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新全局配置项</span><br><span class="line">-- 默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_statements_digest&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启events_statements_summary_by_digest 表的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新digest配置项</span><br><span class="line">-- 默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_consumer_thread_instrumentation&#x3D;TRUE</span><br><span class="line">-- 是否在MySQL Server启动时就开启</span><br><span class="line"></span><br><span class="line">events_xxx_summary_by_yyy_by_event_name表的记录功能，启动之后也可以在setup_consumers表中使用UPDATE语句进行动态更新线程配置项</span><br><span class="line">默认值为TRUE</span><br><span class="line"></span><br><span class="line">performance_schema_instrument[&#x3D;name]</span><br><span class="line">-- 是否在MySQL Server启动时就启用某些采集器，由于instruments配置项多达数千个，所以该配置项支持key-value模式，还支持%号进行通配等，如下:</span><br><span class="line"></span><br><span class="line">-- [&#x3D;name]可以指定为具体的Instruments名称（但是这样如果有多个需要指定的时候，就需要使用该选项多次），也可以使用通配符，可以指定instruments相同的前缀+通配符，也可以使用%代表所有的instruments</span><br><span class="line"></span><br><span class="line">-- 指定开启单个instruments</span><br><span class="line"></span><br><span class="line">performance-schema-instrument&#x3D; &#39;instrument_name&#x3D;value&#39;</span><br><span class="line"></span><br><span class="line">-- 使用通配符指定开启多个instruments</span><br><span class="line"></span><br><span class="line">performance-schema-instrument&#x3D; &#39;wait&#x2F;synch&#x2F;cond&#x2F;%&#x3D;COUNTED&#39;</span><br><span class="line"></span><br><span class="line">--  开关所有的instruments</span><br><span class="line"></span><br><span class="line">-- performance-schema-instrument&#x3D; &#39;%&#x3D;ON&#39;</span><br><span class="line"></span><br><span class="line">-- performance-schema-instrument&#x3D; &#39;%&#x3D;OFF&#39;</span><br><span class="line"></span><br><span class="line">-- 注意，这些启动选项要生效的前提是，需要设置performance_schema&#x3D;ON。另外，这些启动选项虽然无法使用show variables语句查看，但我们可以通过setup_instruments和setup_consumers表查询这些选项指定的值。</span><br></pre></td></tr></table></figure>

<p>2、系统变量</p>
<p>控制performance_schema功能的开关，要使用MySQL的performance_schema，需要在mysqld启动时启用，以启用事件收集功能<br>该参数在5.7.x之前支持performance_schema的版本中默认关闭，5.7.x版本开始默认开启<br>注意：如果mysqld在初始化performance_schema时发现无法分配任何相关的内部缓冲区，则performance_schema将自动禁用，并将performance_schema设置为OFF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#39;%performance_schema%&#39;;</span><br><span class="line">-- 重要的属性解释</span><br><span class="line">performance_schema&#x3D;ON</span><br></pre></td></tr></table></figure>
<p>控制events_statements_summary_by_digest表中的最大行数。如果产生的语句摘要信息超过此最大值，便无法继续存入该表，此时performance_schema会增加状态变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_digests_size&#x3D;10000</span><br></pre></td></tr></table></figure>
<p>控制events_statements_history_long表中的最大行数，该参数控制所有会话在events_statements_history_long表中能够存放的总事件记录数，超过这个限制之后，最早的记录将被覆盖<br>全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10000，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10000 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_events_statements_history_long_size&#x3D;10000</span><br></pre></td></tr></table></figure>
<p>控制events_statements_history表中单个线程（会话）的最大行数，该参数控制单个会话在events_statements_history表中能够存放的事件记录数，超过这个限制之后，单个会话最早的记录将被覆盖<br>全局变量，只读变量，整型值，5.6.3版本引入 * 5.6.x版本中，5.6.5及其之前的版本默认为10，5.6.6及其之后的版本默认值为-1，通常情况下，自动计算的值都是10 * 5.7.x版本中，默认值为-1，通常情况下，自动计算的值都是10<br>除了statement(语句)事件之外，wait(等待)事件、state(阶段)事件、transaction(事务)事件，他们与statement事件一样都有三个参数分别进行存储限制配置，有兴趣的同学自行研究，这里不再赘述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_events_statements_history_size&#x3D;10</span><br></pre></td></tr></table></figure>
<p>用于控制标准化形式的SQL语句文本在存入performance_schema时的限制长度，该变量与max_digest_length变量相关(max_digest_length变量含义请自行查阅相关资料)<br>全局变量，只读变量，默认值1024字节，整型值，取值范围0~1048576</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_max_digest_length&#x3D;1024</span><br></pre></td></tr></table></figure>
<p> 控制存入events_statements_current，events_statements_history和events_statements_history_long语句事件表中的SQL_TEXT列的最大SQL长度字节数。 超出系统变量performance_schema_max_sql_text_length的部分将被丢弃，不会记录，一般情况下不需要调整该参数，除非被截断的部分与其他SQL比起来有很大差异<br> 全局变量，只读变量，整型值，默认值为1024字节，取值范围为0~1048576，5.7.6版本引入<br> 降低系统变量performance_schema_max_sql_text_length值可以减少内存使用，但如果汇总的SQL中，被截断部分有较大差异，会导致没有办法再对这些有较大差异的SQL进行区分。 增加该系统变量值会增加内存使用，但对于汇总SQL来讲可以更精准地区分不同的部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance_schema_max_sql_text_length&#x3D;1024</span><br></pre></td></tr></table></figure>

<h2 id="重要配置表的相关说明"><a href="#重要配置表的相关说明" class="headerlink" title="重要配置表的相关说明"></a>重要配置表的相关说明</h2><p>配置表之间存在相互关联关系，按照配置影响的先后顺序，可添加为</p>
<p>performance_timers表中记录了server中有哪些可用的事件计时器<br>字段解释：<br>    timer_name:表示可用计时器名称，CYCLE是基于CPU周期计数器的定时器<br>    timer_frequency:表示每秒钟对应的计时器单位的数量,CYCLE计时器的换算值与CPU的频率相关、<br>    timer_resolution:计时器精度值，表示在每个计时器被调用时额外增加的值<br>    timer_overhead:表示在使用定时器获取事件时开销的最小周期值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from performance_timers;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/performance_timers%E8%A1%A8.jpg" alt="performance_timers表结构信息"></p>
<p>setup_timers表中记录当前使用的事件计时器信息</p>
<p>字段解释：<br>    name:计时器类型，对应某个事件类别<br>    timer_name:计时器类型名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from setup_timers;</span><br></pre></td></tr></table></figure>

<p>setup_consumers表中列出了consumers可配置列表项<br>字段解释：<br>    NAME：consumers配置名称<br>    ENABLED：consumers是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from setup_consumers;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_consumer.jpg" alt="setup_consumers表结构信息"><br>setup_instruments 表列出了instruments 列表配置项，即代表了哪些事件支持被收集：<br>字段解释：<br>    NAME：instruments名称，instruments名称可能具有多个部分并形成层次结构<br>    ENABLED：instrumetns是否启用，有效值为YES或NO，此列可以使用UPDATE语句修改。如果设置为NO，则这个instruments不会被执行，不会产生任何的事件信息<br>    TIMED：instruments是否收集时间信息，有效值为YES或NO，此列可以使用UPDATE语句修改，如果设置为NO，则这个instruments不会收集时间信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_instruments;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_instruments.jpg" alt="setup_instruments表结构信息"><br>setup_actors表的初始内容是匹配任何用户和主机，因此对于所有前台线程，默认情况下启用监视和历史事件收集功能<br>字段解释：<br>    HOST：与grant语句类似的主机名，一个具体的字符串名字，或使用“％”表示“任何主机”<br>    USER：一个具体的字符串名称，或使用“％”表示“任何用户”<br>    ROLE：当前未使用，MySQL 8.0中才启用角色功能<br>    ENABLED：是否启用与HOST，USER，ROLE匹配的前台线程的监控功能，有效值为：YES或NO<br>    HISTORY：是否启用与HOST， USER，ROLE匹配的前台线程的历史事件记录功能，有效值为：YES或NO</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_actors;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_actors.jpg" alt="setup_actors表结构信息"><br>setup_objects表控制performance_schema是否监视特定对象。默认情况下，此表的最大行数为100行。<br>字段解释：<br>    OBJECT_TYPE：instruments类型，有效值为：“EVENT”（事件调度器事件）、“FUNCTION”（存储函数）、“PROCEDURE”（存储过程）、“TABLE”（基表）、“TRIGGER”（触发器），TABLE对象类型的配置会影响表I/O事件（wait/io/table/sql/handler instrument）和表锁事件（wait/lock/table/sql/handler instrument）的收集<br>    OBJECT_SCHEMA：某个监视类型对象涵盖的数据库名称，一个字符串名称，或“％”(表示“任何数据库”)<br>    OBJECT_NAME：某个监视类型对象涵盖的表名，一个字符串名称，或“％”(表示“任何数据库内的对象”)<br>    ENABLED：是否开启对某个类型对象的监视功能，有效值为：YES或NO。此列可以修改<br>    TIMED：是否开启对某个类型对象的时间收集功能，有效值为：YES或NO，此列可以修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM setup_objects;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/setup_objects.jpg" alt="setup_objects表结构信息"></p>
<p>threads表对于每个server线程生成一行包含线程相关的信息，<br>字段解释：<br>    THREAD_ID：线程的唯一标识符（ID）<br>    NAME：与server中的线程检测代码相关联的名称(注意，这里不是instruments名称)<br>    TYPE：线程类型，有效值为：FOREGROUND、BACKGROUND。分别表示前台线程和后台线程<br>    PROCESSLIST_ID：对应INFORMATION_SCHEMA.PROCESSLIST表中的ID列。<br>    PROCESSLIST_USER：与前台线程相关联的用户名，对于后台线程为NULL。<br>    PROCESSLIST_HOST：与前台线程关联的客户端的主机名，对于后台线程为NULL。<br>    PROCESSLIST_DB：线程的默认数据库，如果没有，则为NULL。<br>    PROCESSLIST_COMMAND：对于前台线程，该值代表着当前客户端正在执行的command类型，如果是sleep则表示当前会话处于空闲状态<br>    PROCESSLIST_TIME：当前线程已处于当前线程状态的持续时间（秒）<br>    PROCESSLIST_STATE：表示线程正在做什么事情。<br>    PROCESSLIST_INFO：线程正在执行的语句，如果没有执行任何语句，则为NULL。<br>    PARENT_THREAD_ID：如果这个线程是一个子线程（由另一个线程生成），那么该字段显示其父线程ID<br>    ROLE：暂未使用<br>    INSTRUMENTED：线程执行的事件是否被检测。有效值：YES、NO<br>    HISTORY：是否记录线程的历史事件。有效值：YES、NO *<br>    THREAD_OS_ID：由操作系统层定义的线程或任务标识符（ID）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from threads;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/threads.jpg" alt="threads表结构信息"><br>注意：在performance_schema库中还包含了很多其他的库和表，能对数据库的性能做完整的监控，具体需要参考官网详细了解。</p>
<h2 id="performance-schema实践操作"><a href="#performance-schema实践操作" class="headerlink" title="performance_schema实践操作"></a>performance_schema实践操作</h2><p>​        基本了解了表的相关信息之后，可以通过这些表进行实际的查询操作来进行实际的分析。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1、哪类的SQL执行最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,COUNT_STAR,FIRST_SEEN,LAST_SEEN <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--2、哪类SQL的平均响应时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--3、哪类SQL排序记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_SORT_ROWS <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--4、哪类SQL扫描记录数最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_EXAMINED <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--5、哪类SQL使用临时表最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_CREATED_TMP_TABLES,SUM_CREATED_TMP_DISK_TABLES <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--6、哪类SQL返回结果集最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> DIGEST_TEXT,SUM_ROWS_SENT <span class="keyword">FROM</span> events_statements_summary_by_digest <span class="keyword">ORDER</span> <span class="keyword">BY</span> COUNT_STAR <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--7、哪个表物理IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> file_name,event_name,SUM_NUMBER_OF_BYTES_READ,SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">FROM</span> file_summary_by_instance <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_NUMBER_OF_BYTES_READ + SUM_NUMBER_OF_BYTES_WRITE <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--8、哪个表逻辑IO最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> object_name,COUNT_READ,COUNT_WRITE,COUNT_FETCH,SUM_TIMER_WAIT <span class="keyword">FROM</span> table_io_waits_summary_by_table <span class="keyword">ORDER</span> <span class="keyword">BY</span> sum_timer_wait <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--9、哪个索引访问最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_NAME,INDEX_NAME,COUNT_FETCH,COUNT_INSERT,COUNT_UPDATE,COUNT_DELETE <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--10、哪个索引从来没有用过？</span></span><br><span class="line"><span class="keyword">SELECT</span> OBJECT_SCHEMA,OBJECT_NAME,INDEX_NAME <span class="keyword">FROM</span> table_io_waits_summary_by_index_usage <span class="keyword">WHERE</span> INDEX_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> COUNT_STAR = <span class="number">0</span> <span class="keyword">AND</span> OBJECT_SCHEMA &lt;&gt; <span class="string">'mysql'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> OBJECT_SCHEMA,OBJECT_NAME;</span><br><span class="line"><span class="comment">--11、哪个等待事件消耗时间最多？</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_NAME,COUNT_STAR,SUM_TIMER_WAIT,AVG_TIMER_WAIT <span class="keyword">FROM</span> events_waits_summary_global_by_event_name <span class="keyword">WHERE</span> event_name != <span class="string">'idle'</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> SUM_TIMER_WAIT <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">--12-1、剖析某条SQL的执行情况，包括statement信息，stege信息，wait信息</span></span><br><span class="line"><span class="keyword">SELECT</span> EVENT_ID,sql_text <span class="keyword">FROM</span> events_statements_history <span class="keyword">WHERE</span> sql_text <span class="keyword">LIKE</span> <span class="string">'%count(*)%'</span>;</span><br><span class="line"><span class="comment">--12-2、查看每个阶段的时间消耗</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,EVENT_NAME,<span class="keyword">SOURCE</span>,TIMER_END - TIMER_START <span class="keyword">FROM</span> events_stages_history_long <span class="keyword">WHERE</span> NESTING_EVENT_ID = <span class="number">1553</span>;</span><br><span class="line"><span class="comment">--12-3、查看每个阶段的锁等待情况</span></span><br><span class="line"><span class="keyword">SELECT</span> event_id,event_name,<span class="keyword">source</span>,timer_wait,object_name,index_name,operation,nesting_event_id <span class="keyword">FROM</span> events_waits_history_longWHERE nesting_event_id = <span class="number">1553</span>;</span><br></pre></td></tr></table></figure>


<p>与性能模式有关的状态变量有如下这些:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &#39;perf%&#39;;</span><br><span class="line">+-----------------------------------------------+-------+</span><br><span class="line">| Variable_name                                 | Value |</span><br><span class="line">+-----------------------------------------------+-------+</span><br><span class="line">| Performance_schema_accounts_lost              | 0     |</span><br><span class="line">| Performance_schema_cond_classes_lost          | 0     |</span><br><span class="line">| Performance_schema_cond_instances_lost        | 0     |</span><br><span class="line">| Performance_schema_digest_lost                | 0     |</span><br><span class="line">| Performance_schema_file_classes_lost          | 0     |</span><br><span class="line">| Performance_schema_file_handles_lost          | 0     |</span><br><span class="line">| Performance_schema_file_instances_lost        | 0     |</span><br><span class="line">| Performance_schema_hosts_lost                 | 0     |</span><br><span class="line">| Performance_schema_locker_lost                | 0     |</span><br><span class="line">| Performance_schema_memory_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_metadata_lock_lost         | 0     |</span><br><span class="line">| Performance_schema_mutex_classes_lost         | 0     |</span><br><span class="line">| Performance_schema_mutex_instances_lost       | 0     |</span><br><span class="line">| Performance_schema_nested_statement_lost      | 0     |</span><br><span class="line">| Performance_schema_program_lost               | 0     |</span><br><span class="line">| Performance_schema_rwlock_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_rwlock_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_session_connect_attrs_lost | 0     |</span><br><span class="line">| Performance_schema_socket_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_socket_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_stage_classes_lost         | 0     |</span><br><span class="line">| Performance_schema_statement_classes_lost     | 0     |</span><br><span class="line">| Performance_schema_table_handles_lost         | 0     |</span><br><span class="line">| Performance_schema_table_instances_lost       | 0     |</span><br><span class="line">| Performance_schema_thread_classes_lost        | 0     |</span><br><span class="line">| Performance_schema_thread_instances_lost      | 0     |</span><br><span class="line">| Performance_schema_users_lost                 | 0     |</span><br><span class="line">+-----------------------------------------------+-------+</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/%E6%80%A7%E8%83%BD%E6%A8%A1%E5%BC%8F%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F.jpg" alt="性能模式状态变量"></p>
<p>例如, 当服务端某生产者采集到一个互斥对象,但是服务器又无法在运行时为采集动作分配内存, 那么Performance_schema_mutex_classes_lost值就会+1.<br>这种情况下, 互斥对象依旧正常以同步方式正常运行(即服务器正常运行), 但是该对象的性能表现数据就不会被采集到. </p>
<p>加入有如下场景:<br>服务端起始变量设置为performance_schema_max_mutex_classes=200, 并且已经加载了150个互斥对象,此时有两个plugin a和b分别持有40和20个互斥对象采集器.<br>当服务器加载了plugin a后再加载plugin b时就会有10个乎此对象采集器无法加载.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &quot;perf%mutex_classes_lost&quot;;</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| Variable_name                         | Value |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">| Performance_schema_mutex_classes_lost | 10    |</span><br><span class="line">+---------------------------------------+-------+</span><br><span class="line">1 row in set (0.10 sec)</span><br></pre></td></tr></table></figure>
<p>注意, 采集动作对plugin b仍然部分有效, 只是有10个Performance_schema_mutex_classes_lost .<br>当服务器无法创建互斥对象采集器时, 将不会有数据写入setup_instruments.<br>Performance_schema_mutex_classes_lost 增量步长为 1.</p>
<p>以上所有模式对所有采集器都适用, 而非仅仅mutex.</p>
<h1 id="show-processlist-查看连接的线程个数"><a href="#show-processlist-查看连接的线程个数" class="headerlink" title="show processlist (查看连接的线程个数)"></a>show processlist (查看连接的线程个数)</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show [full] processlist;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/show_processlist.png" alt="show_processlist"><br>指令的输出列<a href="https://dev.mysql.com/doc/refman/5.7/en/show-processlist.html" target="_blank" rel="noopener">官网解释译文</a>:</p>
<ol>
<li>id: 连接标识符. 与 INFORMATION_SCHEMA.PROCESSLIST表的ID列一致.</li>
<li>user: 执行查询的用户名. 如果其值为system user, 则说明发对应查询非客户端发起的.</li>
<li>Host: 客户端主机端口信息</li>
<li>db: 当前查询所用的库. 如果职位NULL, 表示没有指定库.</li>
<li>Command: 客户端线程指令的类型. 如果当前连接为空闲状态则该列返回值为sleep.</li>
<li>Time: 该线程已处于当前状态的持续时间. 单位为秒</li>
<li>State: 当前线程所执行的内容: 可以是操作, 事件, 状态.[详见](https://dev.mysql.com/doc/refman/5.7/en/thread-information.html)如果某县城处于同一状态很多秒, 就可能有问题需要排查.</li>
<li>线程正(最近)执行的语句信息. NULL表示空闲,未执行任何语句.</li>
</ol>

    </div>



<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


  
</div>




    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Brooks.H.Joshua
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E7%AF%87/" title="MySQL_Advanced_Optimization_01_性能监控篇">https://52zhongneng.cn/2020/10/29/MySQL-Advanced-Optimization-01-性能监控篇/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i>MySQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/10/28/Kafka/" rel="prev" title="Kafka">
      <i class="fa fa-chevron-left"></i> Kafka
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/11/02/MySQL-Advanced-Optimization-02-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E5%92%8C%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/" rel="next" title="MySQL-Advanced-Optimization-02-执行计划和索引优化">
      MySQL-Advanced-Optimization-02-执行计划和索引优化 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
 


 <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#show-profile-查询剖析"><span class="nav-number">1.</span> <span class="nav-text">show profile (查询剖析)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#performance-schema-高级查询剖析"><span class="nav-number">2.</span> <span class="nav-text">performance schema (高级查询剖析)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-schema表的分类"><span class="nav-number">2.2.</span> <span class="nav-text">performance_schema表的分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用配置项的参数说明-重点"><span class="nav-number">2.3.</span> <span class="nav-text">常用配置项的参数说明(重点)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重要配置表的相关说明"><span class="nav-number">2.4.</span> <span class="nav-text">重要配置表的相关说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-schema实践操作"><span class="nav-number">2.5.</span> <span class="nav-text">performance_schema实践操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#show-processlist-查看连接的线程个数"><span class="nav-number">3.</span> <span class="nav-text">show processlist (查看连接的线程个数)</span></a></li></ol></div>
      </div>
      <!--/noindex-->



      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Brooks.H.Joshua"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Brooks.H.Joshua</p>
  <div class="site-description" itemprop="description">Less Is More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">106</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/blog" title="https:&#x2F;&#x2F;spring.io&#x2F;blog" rel="noopener" target="_blank">Spring官博</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.itboyhub.com/" title="http:&#x2F;&#x2F;www.itboyhub.com&#x2F;" rel="noopener" target="_blank">JavaBoy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" title="https:&#x2F;&#x2F;www.cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html" rel="noopener" target="_blank">DSV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://visualgo.net/zh" title="https:&#x2F;&#x2F;visualgo.net&#x2F;zh" rel="noopener" target="_blank">DV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apache.org/index.html#projects-list" title="http:&#x2F;&#x2F;www.apache.org&#x2F;index.html#projects-list" rel="noopener" target="_blank">Apache</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">StackOverflow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://metacademy.org/" title="https:&#x2F;&#x2F;metacademy.org&#x2F;" rel="noopener" target="_blank">Metacademy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">WebNav</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.36zhen.com/t?id=3448" title="http:&#x2F;&#x2F;www.36zhen.com&#x2F;t?id&#x3D;3448" rel="noopener" target="_blank">前端书籍资料</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">G前端开发基础</a>
        </li>
    </ul>
  </div>

     
	<!--网易云音乐-->
	  <div id="music163player">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1002994&auto=1&height=66"></iframe>
	  </div>
      </div>

    </div>
  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Brooks.H.Joshua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">16:37</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

</html>
