<!DOCTYPE html>
<html lang="en">
<meta name="referrer" content="no-referrer"/>
<head>

<!-- 爆炸效果 -->
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
<script type="text/javascript" src="/js/firework.js"></script>


  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <link rel="manifest" href="/images/manifest.json">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"52zhongneng.cn","root":"/","scheme":"Muse","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quic">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro框架简介">
<meta property="og:url" content="https://52zhongneng.cn/2020/04/13/Shiro/index.html">
<meta property="og:site_name" content="Eloise&#39;s Paradise">
<meta property="og:description" content="Apache Shiro™ is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quic">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/55e32ad05f22413cbb9ac5cec10b8cd9.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/6ad6905521b24fe282aaec2ba443f335.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/b1684ded9803482f9e42254eb4ae4a0b.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/ecbee684162f47439b6b29b117f237e2.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/4140b595fbeb48e0abdbf9af28758b89.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/91d32c2ad805481fb7d2b6c29bf1b360.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/9d70d87cf6a947eda0ce56aa8bd554b7.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/6229380e8e5e41bc9174cc3b8099520e.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/b56783849d044aabb22257756a717db7.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/1f25b2871cba4a86b9b1f1f25733fdc5.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/f9c2b008d765462b9ea76bbcd8934ac6.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/cc6bcd2803554ad2872ecc4cd939789d.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/44b9ea6c90454afdae4226e6198ed376.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/f1ecaa75bd024c748ae1b6539ea666f7.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/2b74f104b8c64060a85b5c63b780d03a.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/5811bbfd7215419ab3ccf5de2999bba6.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/0a55b5e449cc4b75b160d2729baeb689.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/277b5d8912254250b646f1bb08d4e7d9.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/ccd9cd6b09c44ce5a6366fa23c2f6b4d.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/3f38b79dcb414bd487031e0b7a8482d2.png">
<meta property="og:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/9c3a7d5b69974482b768bff23baa236c.png">
<meta property="article:published_time" content="2020-04-13T09:17:18.000Z">
<meta property="article:modified_time" content="2022-07-12T03:03:02.429Z">
<meta property="article:author" content="Brooks.H.Joshua">
<meta property="article:tag" content="Shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/55e32ad05f22413cbb9ac5cec10b8cd9.png">

<link rel="canonical" href="https://52zhongneng.cn/2020/04/13/Shiro/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Shiro框架简介 | Eloise's Paradise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div id="id-header-inner"  class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Eloise's Paradise</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">34</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">79</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>
	<!-- 改变css样式 -->
<script type="text/javascript">
var url = document.location.pathname;
var folderName = url.substr(1, url.length - 2)
console.log(folderName);

var listPostUrl = [
    "/" + folderName + "/" + "post-banner.png",
    "/" + folderName + "/" + "post-banner.jpg",
];

var nSuccessCount = 0;
var nResponceCount = 0;
function OnHttpResponse(bSuccess, strUrl) {
    console.log("OnHttpResponse: " + bSuccess + ", " + strUrl);
    nResponceCount++;
    if(nSuccessCount > 0){
        return;
    }
    if(bSuccess) {
        nSuccessCount++;
        document.getElementById("id-header-inner").style.backgroundImage = "url(" + strUrl + ")";
    }
    if(nResponceCount >= listPostUrl.length && nSuccessCount <= 0){
        // 使用默认图
        document.getElementById("id-header-inner").style.backgroundImage = "url(/images/background.jpg)";
    }
}

function changeBanner(strPostUrl, nIndex){
    console.log("try to load" + strPostUrl);
    var xmlhttp;
    if (window.XMLHttpRequest)
    {
        //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
        xmlhttp=new XMLHttpRequest();
    }
    else
    {
        // IE6, IE5 浏览器执行代码
        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState==4 && xmlhttp.status==200)
        {
            OnHttpResponse(true, strPostUrl);
        } else {
            OnHttpResponse(false, strPostUrl);
        }
    }
    xmlhttp.open("HEAD",strPostUrl,true);
    xmlhttp.send();
}

listPostUrl.forEach(changeBanner);
</script>



    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://52zhongneng.cn/2020/04/13/Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Brooks.H.Joshua">
      <meta itemprop="description" content="Less Is More">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eloise's Paradise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shiro框架简介
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-13 17:17:18" itemprop="dateCreated datePublished" datetime="2020-04-13T17:17:18+08:00">2020-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-12 11:03:02" itemprop="dateModified" datetime="2022-07-12T11:03:02+08:00">2022-07-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index">
                    <span itemprop="name">安全框架</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>40k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>36 mins.</span>
            </span>


           
          
          <div class="out-img-topic">
          <img src=/image/post_cover_image_shiro.png class="img-topic">
          </div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>Apache Shiro™</strong> is a powerful and easy-to-use Java security framework that performs <font color="red">authentication, authorization, cryptography, and session management</font>. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.</p>
<a id="more"></a>



<h1 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1><h3 id="一、现存问题"><a href="#一、现存问题" class="headerlink" title="一、现存问题"></a>一、现存问题</h3><h4 id="1-1-现存问题"><a href="#1-1-现存问题" class="headerlink" title="1.1 现存问题"></a>1.1 现存问题</h4><p>认证（登录）：认证操作流程都差不多，但是每次都需要手动的基于业务代码去实现，很麻烦！</p>
<p>授权：如果权限控制粒度比较粗，可以自身去实现，但是如果控制粒度比较细，操作麻烦！</p>
<p>分布式会话管理：单体项目时，需要依赖Web容器的Session实现会话，搭建了集群或者是分布式项目，手动去基于Redis或者其他拥有公共存储能力的中间件实现分布式会话管理。</p>
<p>单点登录：在一处服务认证，所有其他服务都信任。（了解）</p>
<h4 id="1-2-Shiro框架介绍"><a href="#1-2-Shiro框架介绍" class="headerlink" title="1.2 Shiro框架介绍"></a>1.2 Shiro框架介绍</h4><p>Shiro是基于Java语言编写的，Shiro最核心的功能就是认证和授权。</p>
<p>Shiro官方：<a href="http://shiro.apache.org" target="_blank" rel="noopener">http://shiro.apache.org</a></p>
<p>Shiro的核心架构图</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/55e32ad05f22413cbb9ac5cec10b8cd9.png" alt="image.png"></p>
<h3 id="二、Shiro的基本使用"><a href="#二、Shiro的基本使用" class="headerlink" title="二、Shiro的基本使用"></a>二、Shiro的基本使用</h3><h4 id="2-1-SimpleAccountRealm"><a href="#2-1-SimpleAccountRealm" class="headerlink" title="2.1 SimpleAccountRealm"></a>2.1 SimpleAccountRealm</h4><p>认证流程：</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/6ad6905521b24fe282aaec2ba443f335.png" alt="image.png"></p>
<p>授权流程：</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/b1684ded9803482f9e42254eb4ae4a0b.png" alt="image.png"></p>
<p>具体操作代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">authen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//认证的发起者(subject)，   SecurityManager，   Realm</span></span><br><span class="line">    <span class="comment">//1. 准备Realm（基于内存存储用户信息）</span></span><br><span class="line">    SimpleAccountRealm realm = <span class="keyword">new</span> SimpleAccountRealm();</span><br><span class="line">    realm.addAccount(<span class="string">"admin"</span>, <span class="string">"admin"</span>, <span class="string">"超级管理员"</span>, <span class="string">"商家"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 准备SecurityManager</span></span><br><span class="line">    DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultSecurityManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. SecurityManager和Realm建立连接</span></span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. subject和SecurityManager建立联系</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 声明subject</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 发起认证</span></span><br><span class="line">    subject.login(<span class="keyword">new</span> UsernamePasswordToken(<span class="string">"admin"</span>, <span class="string">"admin"</span>));</span><br><span class="line">    <span class="comment">// 如果认证时，用户名错误，抛出：org.apache.shiro.authc.UnknownAccountException异常</span></span><br><span class="line">    <span class="comment">// 如果认证时，密码错误，抛出：org.apache.shiro.authc.IncorrectCredentialsException:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//7. 判断是否认证成功</span></span><br><span class="line">    System.out.println(subject.isAuthenticated());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8. 退出登录后再判断</span></span><br><span class="line">    <span class="comment">//        subject.logout();</span></span><br><span class="line">    <span class="comment">//        System.out.println("logout方法执行后，认证的状态：" + subject.isAuthenticated());</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//9. 授权是在认证成功之后的操作！！！</span></span><br><span class="line">    <span class="comment">// SimpleAccountRealm只支持角色的授权</span></span><br><span class="line">    System.out.println(<span class="string">"是否拥有超级管理员角色："</span> + subject.hasRole(<span class="string">"超级管理员"</span>));</span><br><span class="line">    subject.checkRole(<span class="string">"商家"</span>);</span><br><span class="line">    <span class="comment">// check方法校验角色时，如果没有指定角色，会抛出异常：org.apache.shiro.authz.UnauthorizedException: Subject does not have role [角色信息]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-IniRealm"><a href="#2-2-IniRealm" class="headerlink" title="2.2 IniRealm"></a>2.2 IniRealm</h4><p>基于文件存储用户名，密码，角色等信息</p>
<p>准备一个.ini文件，存储用户信息，并且IniRealm支持权限校验</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">username</span>=password,role1,role2</span><br><span class="line"><span class="attr">admin</span>=admin,超级管理员,运营</span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="attr">role1</span>=perm1,perm2</span><br><span class="line">超级管理员=user:add,user:update,user:delete</span><br></pre></td></tr></table></figure>

<p>具体实现业务的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">authen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//1. 构建IniRealm</span></span><br><span class="line">    IniRealm realm = <span class="keyword">new</span> IniRealm(<span class="string">"classpath:shiro.ini"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 构建SecurityManager绑定Realm</span></span><br><span class="line">    DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultSecurityManager();</span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 基于SecurityUtils绑定SecurityManager并声明subject</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 认证操作</span></span><br><span class="line">    subject.login(<span class="keyword">new</span> UsernamePasswordToken(<span class="string">"admin"</span>,<span class="string">"admin"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 角色校验</span></span><br><span class="line">    <span class="comment">// 超级管理员</span></span><br><span class="line">    System.out.println(subject.hasRole(<span class="string">"超级管理员"</span>));</span><br><span class="line">    subject.checkRole(<span class="string">"运营"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 权限校验</span></span><br><span class="line">    System.out.println(subject.isPermitted(<span class="string">"user:update"</span>));</span><br><span class="line">    <span class="comment">// 如果没有响应的权限，就抛出异常：UnauthorizedException: Subject does not have permission [user:select]</span></span><br><span class="line">    subject.checkPermission(<span class="string">"user:delete"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-JdbcRealm"><a href="#2-3-JdbcRealm" class="headerlink" title="2.3 JdbcRealm"></a>2.3 JdbcRealm</h4><p>实现权限校验时，库表设计方案</p>
<p>用户认证、授权时推荐的表结构设计，经典五张表！</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/ecbee684162f47439b6b29b117f237e2.png" alt="image.png"></p>
<p>具体实现业务代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">authen</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//1. 构建IniRealm</span></span><br><span class="line">    JdbcRealm realm = <span class="keyword">new</span> JdbcRealm();</span><br><span class="line"></span><br><span class="line">    DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">    dataSource.setUrl(<span class="string">"jdbc:mysql:///shiro"</span>);</span><br><span class="line">    dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">    dataSource.setPassword(<span class="string">"root"</span>);</span><br><span class="line">    realm.setDataSource(dataSource);</span><br><span class="line"></span><br><span class="line">    realm.setPermissionsLookupEnabled(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 构建SecurityManager绑定Realm</span></span><br><span class="line">    DefaultSecurityManager securityManager = <span class="keyword">new</span> DefaultSecurityManager();</span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 基于SecurityUtils绑定SecurityManager并声明subject</span></span><br><span class="line">    SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 认证操作</span></span><br><span class="line">    subject.login(<span class="keyword">new</span> UsernamePasswordToken(<span class="string">"admin"</span>,<span class="string">"admin"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 授权操作(角色)</span></span><br><span class="line">    System.out.println(subject.hasRole(<span class="string">"超级管1理员"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 授权操作(权限)</span></span><br><span class="line">    System.out.println(subject.isPermitted(<span class="string">"user:add"</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SQL构建代码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`roles_permissions`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`roles_permissions`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`permission`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_name`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">4</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of roles_permissions</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`roles_permissions`</span> <span class="keyword">VALUES</span> (<span class="string">'1'</span>, <span class="string">'user:add'</span>, <span class="string">'超级管理员'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`roles_permissions`</span> <span class="keyword">VALUES</span> (<span class="string">'2'</span>, <span class="string">'user:update'</span>, <span class="string">'超级管理员'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`roles_permissions`</span> <span class="keyword">VALUES</span> (<span class="string">'3'</span>, <span class="string">'user:select'</span>, <span class="string">'运营'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for `users`</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`users`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of users</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`users`</span> <span class="keyword">VALUES</span> (<span class="string">'1'</span>, <span class="string">'admin'</span>, <span class="string">'admin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for `user_roles`</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`user_roles`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`user_roles`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`role_name`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">3</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user_roles</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_roles`</span> <span class="keyword">VALUES</span> (<span class="string">'1'</span>, <span class="string">'超级管理员'</span>, <span class="string">'admin'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`user_roles`</span> <span class="keyword">VALUES</span> (<span class="string">'2'</span>, <span class="string">'运营'</span>, <span class="string">'admin'</span>);</span><br></pre></td></tr></table></figure>

<h4 id="2-4-CustomRealm（自定义Realm）"><a href="#2-4-CustomRealm（自定义Realm）" class="headerlink" title="2.4 CustomRealm（自定义Realm）"></a>2.4 CustomRealm（自定义Realm）</h4><p>仿照JdbcRealm实现一个自定义的Realm对象</p>
<ul>
<li>声明POJO类，继承AuthorizingRealm<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    ……………………</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重写doGetAuthenticationInfo方法（认证）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证方法，只需要完成用户名校验即可，密码校验由Shiro内部完成</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token  用户传入的用户名和密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">//1. 基于Token获取用户名</span></span><br><span class="line">    String username = (String) token.getPrincipal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 判断用户名（非空）</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(username))&#123;</span><br><span class="line">        <span class="comment">// 返回null，会默认抛出一个异常，org.apache.shiro.authc.UnknownAccountException</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 如果用户名不为null，基于用户名查询用户信息</span></span><br><span class="line">    User user = <span class="keyword">this</span>.findUserByUsername(username);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 判断user对象是否为null</span></span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 声明AuthenticationInfo对象，并填充用户信息</span></span><br><span class="line">    SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(user,user.getPassword(),<span class="string">"CustomRealm!!"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 返回info</span></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟数据库操作</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">findUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username))&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"admin"</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重写doGetAuthenticationInfo方法（密码加密加盐）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    HashedCredentialsMatcher matcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">    matcher.setHashAlgorithmName(<span class="string">"MD5"</span>);</span><br><span class="line">    matcher.setHashIterations(<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">this</span>.setCredentialsMatcher(matcher);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证方法，只需要完成用户名校验即可，密码校验由Shiro内部完成</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token  用户传入的用户名和密码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    <span class="comment">//1. 基于Token获取用户名</span></span><br><span class="line">    String username = (String) token.getPrincipal();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//2. 判断用户名（非空）</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isEmpty(username))&#123;</span><br><span class="line">        <span class="comment">// 返回null，会默认抛出一个异常，org.apache.shiro.authc.UnknownAccountException</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//3. 如果用户名不为null，基于用户名查询用户信息</span></span><br><span class="line">    User user = <span class="keyword">this</span>.findUserByUsername(username);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//4. 判断user对象是否为null</span></span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//5. 声明AuthenticationInfo对象，并填充用户信息</span></span><br><span class="line">    SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(user,user.getPassword(),<span class="string">"CustomRealm!!"</span>);</span><br><span class="line">    <span class="comment">// 设置盐！</span></span><br><span class="line">    info.setCredentialsSalt(ByteSource.Util.bytes(user.getSalt()));</span><br><span class="line">    <span class="comment">//6. 返回info</span></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟数据库操作</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">findUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"admin"</span>.equals(username))&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"1ebc4dcaf1e21b814ece65f27531f1a9"</span>);</span><br><span class="line">        user.setSalt(<span class="string">"weruiothergjkdfnbgjkdfngjkdf"</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>重写doGetAuthorizationInfo方法（授权）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 授权方法，授权是在认证之后的操作</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1. 获取认证用户的信息</span></span><br><span class="line">    User user = (User) principals.getPrimaryPrincipal();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 基于用户信息获取当前用户拥有的角色。</span></span><br><span class="line">    Set&lt;String&gt; roleSet = <span class="keyword">this</span>.findRolesByUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 基于用户拥有的角色查询权限信息</span></span><br><span class="line">    Set&lt;String&gt; permSet = <span class="keyword">this</span>.findPermsByRoleSet(roleSet);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 声明AuthorizationInfo对象作为返回值，传入角色信息和权限信息</span></span><br><span class="line">    SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">    info.setRoles(roleSet);</span><br><span class="line">    info.setStringPermissions(permSet);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 返回</span></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">findPermsByRoleSet</span><span class="params">(Set&lt;String&gt; roleSet)</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    set.add(<span class="string">"user:add"</span>);</span><br><span class="line">    set.add(<span class="string">"user:update"</span>);</span><br><span class="line">    <span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">findRolesByUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    set.add(<span class="string">"超级管理员"</span>);</span><br><span class="line">    set.add(<span class="string">"运营"</span>);</span><br><span class="line">    <span class="keyword">return</span> set;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="三、Shiro的Web流程"><a href="#三、Shiro的Web流程" class="headerlink" title="三、Shiro的Web流程"></a>三、Shiro的Web流程</h3><p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/4140b595fbeb48e0abdbf9af28758b89.png" alt="image.png"></p>
<h3 id="四、Shiro整合Web（SpringMVC，SpringBoot）"><a href="#四、Shiro整合Web（SpringMVC，SpringBoot）" class="headerlink" title="四、Shiro整合Web（SpringMVC，SpringBoot）"></a>四、Shiro整合Web（SpringMVC，SpringBoot）</h3><h4 id="4-1-SSM方式"><a href="#4-1-SSM方式" class="headerlink" title="4.1 SSM方式"></a>4.1 SSM方式</h4><ul>
<li><p>准备SSM的配置（掌握跳过）</p>
</li>
<li><p>准备经典五张表，完成测试</p>
</li>
<li><p>准备Shiro的配置</p>
<ul>
<li><p>准备核心过滤器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    配置Shiro整合web的过滤器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--        默认情况下，请求到达这个过滤器，会去Spring容器中名字为filter-name的实例去处理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>shiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>准备shiroFilter实例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"shiroFilter"</span> <span class="attr">class</span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span></span><br><span class="line">	.....</span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>注入SecurityManager，登录页面路径，过滤器链</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--    构建realm--&gt;</span><br><span class="line">&lt;bean id=<span class="string">"realm"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.mashibing.realm.ShiroRealm"</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--    构建securityManager--&gt;</span><br><span class="line">&lt;bean id=<span class="string">"securityManager"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.apache.shiro.web.mgt.DefaultWebSecurityManager"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"realm"</span> ref=<span class="string">"realm"</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--    构建ShiroFilter实例--&gt;</span><br><span class="line">&lt;bean id=<span class="string">"shiroFilter"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.apache.shiro.spring.web.ShiroFilterFactoryBean"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"securityManager"</span> ref=<span class="string">"securityManager"</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">"loginUrl"</span> value=<span class="string">"/login.html"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"filterChainDefinitionMap"</span>&gt;</span><br><span class="line">        &lt;map&gt;</span><br><span class="line">            &lt;entry key=<span class="string">"/login.html"</span> value=<span class="string">"anon"</span> /&gt;</span><br><span class="line">            &lt;entry key=<span class="string">"/user/**"</span> value=<span class="string">"anon"</span> /&gt;</span><br><span class="line">            &lt;entry key=<span class="string">"/**"</span> value=<span class="string">"authc"</span> /&gt;</span><br><span class="line">        &lt;/map&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>将ShiroRealm的模拟数据库操作，修改为与数据库交互</p>
</li>
<li><p>编写登录功能，并测试效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(String username,String password)</span></span>&#123;</span><br><span class="line">    <span class="comment">// 执行Shiro的认证操作</span></span><br><span class="line">    <span class="comment">//1. 直接基于SecurityUtils获取subject主体,不需要手动的将SecurityManager和SecurityUtils手动整合，Spring已经奥丁</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 发起认证</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        subject.login(<span class="keyword">new</span> UsernamePasswordToken(username,password));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SUCCESS"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownAccountException exception)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"username fail!!!"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IncorrectCredentialsException exception)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"password fail!!!"</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"donot know...!!!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="4-2-SpringBoot方式"><a href="#4-2-SpringBoot方式" class="headerlink" title="4.2 SpringBoot方式"></a>4.2 SpringBoot方式</h4><ul>
<li>搭建SpringBoot工程（准备工作）</li>
<li>配置Shiro整合SpringBoot内容<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">(ShiroRealm realm)</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(realm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultShiroFilterChainDefinition <span class="title">shiroFilterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultShiroFilterChainDefinition shiroFilterChainDefinition = <span class="keyword">new</span> DefaultShiroFilterChainDefinition();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/login.html"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/user/**"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>,<span class="string">"authc"</span>);</span><br><span class="line"></span><br><span class="line">        shiroFilterChainDefinition.addPathDefinitions(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterChainDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="五、Shiro的授权方式"><a href="#五、Shiro的授权方式" class="headerlink" title="五、Shiro的授权方式"></a>五、Shiro的授权方式</h3><h4 id="5-1-过滤器链"><a href="#5-1-过滤器链" class="headerlink" title="5.1 过滤器链"></a>5.1 过滤器链</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DefaultFilter &#123;</span><br><span class="line">	<span class="comment">// ....</span></span><br><span class="line">    perms(PermissionsAuthorizationFilter<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">    <span class="title">roles</span>(<span class="title">RolesAuthorizationFilter</span>.<span class="title">class</span>),</span></span><br><span class="line"><span class="class">	// ....</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filterChainDefinitionMap.put(<span class="string">"/item/select"</span>,<span class="string">"roles[超级管理员,运营]"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/item/delete"</span>,<span class="string">"perms[item:delete,item:insert]"</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/91d32c2ad805481fb7d2b6c29bf1b360.png" alt="image.png"></p>
<h4 id="5-2-自定义过滤器"><a href="#5-2-自定义过滤器" class="headerlink" title="5.2 自定义过滤器"></a>5.2 自定义过滤器</h4><ul>
<li>仿照RolesAuthorizationFilter实现自定义过滤器<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在要求的多个角色中，有一个满足要求，就放行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zjw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RolesOrAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title">AuthorizationFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 获取主体subject</span></span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        <span class="comment">// 将传入的角色转成数组操作</span></span><br><span class="line">        String[] rolesArray = (String[]) mappedValue;</span><br><span class="line">        <span class="comment">// 健壮性校验</span></span><br><span class="line">        <span class="keyword">if</span> (rolesArray == <span class="keyword">null</span> || rolesArray.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开始校验</span></span><br><span class="line">        <span class="keyword">for</span> (String role : rolesArray) &#123;</span><br><span class="line">            <span class="keyword">if</span>(subject.hasRole(role))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>将自定义过滤器配置给Shiro<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">(ShiroRealm realm)</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManager.setRealm(realm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultShiroFilterChainDefinition <span class="title">shiroFilterChainDefinition</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultShiroFilterChainDefinition shiroFilterChainDefinition = <span class="keyword">new</span> DefaultShiroFilterChainDefinition();</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/login.html"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/user/**"</span>,<span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/item/select"</span>,<span class="string">"rolesOr[超级管理员,运营]"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/item/delete"</span>,<span class="string">"perms[item:delete,item:insert]"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>,<span class="string">"authc"</span>);</span><br><span class="line"></span><br><span class="line">        shiroFilterChainDefinition.addPathDefinitions(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterChainDefinition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123; @environment['shiro.loginUrl'] ?: '/login.jsp' &#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String loginUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123; @environment['shiro.successUrl'] ?: '/' &#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String successUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"#&#123; @environment['shiro.unauthorizedUrl'] ?: null &#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String unauthorizedUrl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager,ShiroFilterChainDefinition shiroFilterChainDefinition)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 构建ShiroFilterFactoryBean工厂</span></span><br><span class="line">        ShiroFilterFactoryBean filterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//2. 设置了大量的路径</span></span><br><span class="line">        filterFactoryBean.setLoginUrl(loginUrl);</span><br><span class="line">        filterFactoryBean.setSuccessUrl(successUrl);</span><br><span class="line">        filterFactoryBean.setUnauthorizedUrl(unauthorizedUrl);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//3. 设置安全管理器</span></span><br><span class="line">        filterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//4. 设置过滤器链</span></span><br><span class="line">        filterFactoryBean.setFilterChainDefinitionMap(shiroFilterChainDefinition.getFilterChainMap());</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//5. 设置自定义过滤器 ， 这里一定要手动的new出来这个自定义过滤器，如果使用Spring管理自定义过滤器，会造成无法获取到Subject</span></span><br><span class="line">        filterFactoryBean.getFilters().put(<span class="string">"rolesOr"</span>,<span class="keyword">new</span> RolesOrAuthorizationFilter());</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//6. 返回工厂</span></span><br><span class="line">        <span class="keyword">return</span> filterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>测试功能<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改当前用户的角色授权过滤器</span></span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/item/select"</span>,<span class="string">"rolesOr[超级管理员,运营]"</span>);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="5-3-注解"><a href="#5-3-注解" class="headerlink" title="5.3 注解"></a>5.3 注解</h4><ul>
<li><p>注解进行授权时，是基于对Controller类进行代理，在前置增强中对请求进行权限校验</p>
</li>
<li><p>因为咱们使用SpringBoot的测试方式，直接在Controller方法上添加注解即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/update"</span>)</span><br><span class="line"><span class="meta">@RequiresRoles</span>(value = &#123;<span class="string">"超级管理员"</span>,<span class="string">"运营"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"item Update!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/insert"</span>)</span><br><span class="line"><span class="meta">@RequiresRoles</span>(value = &#123;<span class="string">"超级管理员"</span>,<span class="string">"运营"</span>&#125;,logical = Logical.OR)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"item Update!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @RequiresPermissions(value = "",logical = Logical.AND)</span></span><br></pre></td></tr></table></figure></li>
<li><p>在SpringBoot中注解默认就生效，是因为自动装配中，已经配置好了对注解的支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"shiro.annotations.enabled"</span>, matchIfMissing = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroAnnotationProcessorAutoConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractShiroAnnotationProcessorConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn</span>(<span class="string">"lifecycleBeanPostProcessor"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.defaultAdvisorAutoProxyCreator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authorizationAttributeSourceAdvisor(securityManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>注解的形式无法将错误页面的信息定位到401.html，因为配置的这种路径，只针对过滤器链有效，注解无效。为了实现友好提示的效果，可以配置异常处理器，@RestControllerAdvice，@ControllerAdvice</p>
</li>
</ul>
<h4 id="5-4-标签（前端，不玩，JSP、Freemarker、Thymeleaf）"><a href="#5-4-标签（前端，不玩，JSP、Freemarker、Thymeleaf）" class="headerlink" title="5.4 标签（前端，不玩，JSP、Freemarker、Thymeleaf）"></a>5.4 标签（前端，不玩，JSP、Freemarker、Thymeleaf）</h4><h4 id="5-5-记住我"><a href="#5-5-记住我" class="headerlink" title="5.5 记住我"></a>5.5 记住我</h4><ul>
<li><p>记住我在开启后，可以针对一些安全级别相对更低的页面采用user过滤器拦截，只要登录过，不需要重新登录就可以访问</p>
</li>
<li><p>准备工作：</p>
<ul>
<li><p>准备两个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/rememberMe"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">rememberMe</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"rememberMe!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/authentication"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">authentication</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"authentication!!!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置不同的过滤器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filterChainDefinitionMap.put(<span class="string">"/item/rememberMe"</span>,<span class="string">"user"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/item/authentication"</span>,<span class="string">"authc"</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在页面追加记住我按钮，并且在登录是，添加rememberMe效果</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/user/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span>  <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span>  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> /&gt;</span>  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    记住我：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">name</span>=<span class="string">"rememberMe"</span> <span class="attr">value</span>=<span class="string">"on"</span> /&gt;</span>  <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ================================== --&gt;</span></span><br><span class="line">UsernamePasswordToken token = new UsernamePasswordToken(username, password);</span><br><span class="line">token.setRememberMe(rememberMe != null &amp;&amp; "on".equals(rememberMe));</span><br><span class="line">subject.login(token);</span><br></pre></td></tr></table></figure></li>
<li><p>测试效果</p>
</li>
<li><p>问题1：认证后，后台报错，原因是记住我，需要以浏览器的cookie和后台的user对象绑定，user对象需要序列化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;  ……&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>问题2：认证后，重新打开浏览器，还可以访问角色授权、权限授权的地址。没有在Realm的授权方法中先判断用户是否认证，导致可以直接方案，因为cookie绑定的是认证成功后，返回的第一个参数，而第一个参数和授权方法中参数能获得到的用户信息是一个内容。直接在授权方法中先做认证判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//0. 判断是否认证</span></span><br><span class="line">    Subject subject = SecurityUtils.getSubject();</span><br><span class="line">    <span class="keyword">if</span>(subject == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!subject.isAuthenticated()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	………………</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>测试效果：需要认证的接口地址，无法在关闭浏览器后重新访问，必须要重新认证。</p>
</li>
<li><p>测试效果：需要记住我的接口地址，可以在浏览器重新打开后正常访问。</p>
</li>
</ul>
<h3 id="六、Shiro的分布式Session的处理"><a href="#六、Shiro的分布式Session的处理" class="headerlink" title="六、Shiro的分布式Session的处理"></a>六、Shiro的分布式Session的处理</h3><h4 id="6-1-Shiro的Session管理"><a href="#6-1-Shiro的Session管理" class="headerlink" title="6.1 Shiro的Session管理"></a>6.1 Shiro的Session管理</h4><p>Shiro在认证成功后，可以不依赖Web容器的Session，也可以依赖！</p>
<p>在SpringBoot自动装配之后，Shiro默认将HttpSession作为存储用户认证成功信息的位置。</p>
<p>但是SpringBoot也提供了一个基于JVM内存存储用户认证信息的位置。</p>
<p>修改Shiro默认使用的SessionDAO，修改为默认构建好的MemorySessionDAO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建管理SessionDAO的SessionManager</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">(SessionDAO sessionDAO)</span> </span>&#123;</span><br><span class="line">    DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">    sessionManager.setSessionDAO(sessionDAO);</span><br><span class="line">    <span class="keyword">return</span> sessionManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">(ShiroRealm realm,SessionManager sessionManager)</span></span>&#123;</span><br><span class="line">    DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line">	<span class="comment">// 将使用MemorySessionDAO的SessionManager注入到SecurityManager</span></span><br><span class="line">    securityManager.setSessionManager(sessionManager);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-2-Shiro解决分布式Session"><a href="#6-2-Shiro解决分布式Session" class="headerlink" title="6.2 Shiro解决分布式Session"></a>6.2 Shiro解决分布式Session</h4><p>在服务搭建集群后，或者是服务是分布式架构的，导致单台服务的认证无法让其他服务也得知到信息：</p>
<ul>
<li>基于Nginx做ip_hash策略，但是也只是针对单台服务搭建集群有效果</li>
<li>基于Shiro提供的SessionDAO解决，让SessionDAO去与公共的Redis进行交互，存储用户信息</li>
</ul>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/9d70d87cf6a947eda0ce56aa8bd554b7.png" alt="image.png"></p>
<h4 id="6-3-实现Shiro的分布式Session处理"><a href="#6-3-实现Shiro的分布式Session处理" class="headerlink" title="6.3 实现Shiro的分布式Session处理"></a>6.3 实现Shiro的分布式Session处理</h4><ul>
<li><p>项目连接Redis</p>
<ul>
<li><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>编写配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">49.233</span><span class="number">.115</span><span class="number">.171</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxxxx</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>声明SessionDAO的实现类，并重写核心方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSessionDAO</span> <span class="keyword">extends</span> <span class="title">AbstractSessionDAO</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储到Redis时，sessionId作为key，Session作为Value</span></span><br><span class="line">    <span class="comment">// sessionId就是一个字符串</span></span><br><span class="line">    <span class="comment">// Session可以和sessionId绑定到一起，绑定之后，可以基于Session拿到sessionId</span></span><br><span class="line">    <span class="comment">// 需要给Key设置一个统一的前缀，这样才可以方便通过keys命令查看到所有关联的信息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String SHIOR_SESSION = <span class="string">"session:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">doCreate</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Redis---doCreate"</span>);</span><br><span class="line">        <span class="comment">//1. 基于Session生成一个sessionId（唯一标识）</span></span><br><span class="line">        Serializable sessionId = generateSessionId(session);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 将Session和sessionId绑定到一起（可以基于Session拿到sessionId）</span></span><br><span class="line">        assignSessionId(session, sessionId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 将 前缀:sessionId 作为key，session作为value存储</span></span><br><span class="line">        redisTemplate.opsForValue().set(SHIOR_SESSION + sessionId,session,<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 返回sessionId</span></span><br><span class="line">        <span class="keyword">return</span> sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> 	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Session <span class="title">doReadSession</span><span class="params">(Serializable sessionId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1. 基于sessionId获取Session （与Redis交互）</span></span><br><span class="line">        <span class="keyword">if</span> (sessionId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Session session = (Session) redisTemplate.opsForValue().get(SHIOR_SESSION + sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">            redisTemplate.expire(SHIOR_SESSION + sessionId,<span class="number">30</span>,TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Session session)</span> <span class="keyword">throws</span> UnknownSessionException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Redis---update"</span>);</span><br><span class="line">        <span class="comment">//1. 修改Redis中session</span></span><br><span class="line">        <span class="keyword">if</span>(session == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        redisTemplate.opsForValue().set(SHIOR_SESSION + session.getId(),session,<span class="number">30</span>, TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除Redis中的Session</span></span><br><span class="line">        <span class="keyword">if</span>(session == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        redisTemplate.delete(SHIOR_SESSION + session.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;Session&gt; <span class="title">getActiveSessions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set keys = redisTemplate.keys(SHIOR_SESSION + <span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">        Set&lt;Session&gt; sessionSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="comment">// 尝试修改为管道操作，pipeline（Redis的知识）</span></span><br><span class="line">        <span class="keyword">for</span> (Object key : keys) &#123;</span><br><span class="line">            Session session = (Session) redisTemplate.opsForValue().get(key);</span><br><span class="line">            sessionSet.add(session);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sessionSet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>将RedisSessionDAO交给SessionManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">(RedisSessionDAO sessionDAO)</span> </span>&#123;</span><br><span class="line">    DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">    sessionManager.setSessionDAO(sessionDAO);</span><br><span class="line">    <span class="keyword">return</span> sessionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>将SessionManager注入到SecurityManager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public DefaultWebSecurityManager securityManager(ShiroRealm realm,SessionManager sessionManager)&#123;</span><br><span class="line">    DefaultWebSecurityManager securityManager &#x3D; new DefaultWebSecurityManager();</span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line">    securityManager.setSessionManager(sessionManager);</span><br><span class="line">    return securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="6-4-RedisSessionDAO问题"><a href="#6-4-RedisSessionDAO问题" class="headerlink" title="6.4 RedisSessionDAO问题"></a>6.4 RedisSessionDAO问题</h4><p>将传统的基于Web容器或者ConcurrentHashMap切换为Redis之后，发现每次请求需要访问多次Redis服务，这个访问的频次会出现很长时间的IO等待，对每次请求的性能减低了，并且对Redis的压力也提高了。</p>
<ul>
<li><p>基于装饰者模式重新声明SessionManager中提供的retrieveSession方法，让每次请求先去request域中查询session信息，request域中没有，再去Redis中查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRedisWebSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Session <span class="title">retrieveSession</span><span class="params">(SessionKey sessionKey)</span> <span class="keyword">throws</span> UnknownSessionException </span>&#123;</span><br><span class="line">        <span class="comment">// 通过sessionKey获取sessionId</span></span><br><span class="line">        Serializable sessionId = getSessionId(sessionKey);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将sessionKey转为WebSessionKey</span></span><br><span class="line">        <span class="keyword">if</span>(sessionKey <span class="keyword">instanceof</span> WebSessionKey)&#123;</span><br><span class="line">            WebSessionKey webSessionKey = (WebSessionKey) sessionKey;</span><br><span class="line">            <span class="comment">// 获取到request域</span></span><br><span class="line">            ServletRequest request = webSessionKey.getServletRequest();</span><br><span class="line">            <span class="comment">// 通过request尝试获取session信息</span></span><br><span class="line">            Session session = (Session) request.getAttribute(sessionId + <span class="string">""</span>);</span><br><span class="line">            <span class="keyword">if</span>(session != <span class="keyword">null</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">"从request域中获取session信息"</span>);</span><br><span class="line">                <span class="keyword">return</span> session;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                session = retrieveSessionFromDataSource(sessionId);</span><br><span class="line">                <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//session ID was provided, meaning one is expected to be found, but we couldn't find one:</span></span><br><span class="line">                    String msg = <span class="string">"Could not find session with ID ["</span> + sessionId + <span class="string">"]"</span>;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> UnknownSessionException(msg);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"Redis---doReadSession"</span>);</span><br><span class="line">                request.setAttribute(sessionId + <span class="string">""</span>,session);</span><br><span class="line">                <span class="keyword">return</span> session;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置DefaultRedisWebSessionManager到SecurityManager中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">(RedisSessionDAO sessionDAO)</span> </span>&#123;</span><br><span class="line">    DefaultRedisWebSessionManager sessionManager = <span class="keyword">new</span> DefaultRedisWebSessionManager();</span><br><span class="line">    sessionManager.setSessionDAO(sessionDAO);</span><br><span class="line">    <span class="keyword">return</span> sessionManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="七、Shiro的授权缓存"><a href="#七、Shiro的授权缓存" class="headerlink" title="七、Shiro的授权缓存"></a>七、Shiro的授权缓存</h3><p>如果后台接口存在授权操作，那么每次请求都需要去数据库查询对应的角色信息和权限信息，对数据库来说，这样的查询压力太大了。</p>
<p>在Shiro中，发现每次在执行自定义Realm的授权方法查询数据库之前，会有一个执行Cache的操作。</p>
<p>先从Cache中基于一个固定的key去查询角色以及权限的信息。</p>
<p>只需要提供好响应的CacheManager实例，还要实现一个与Redis交互的Cache对象，将Cache对象设置到CacheManager实例中。</p>
<p>将上述设置好的CacheManager设置到SecurityManager对象中</p>
<h4 id="7-1-实现RedisCache"><a href="#7-1-实现RedisCache" class="headerlink" title="7.1 实现RedisCache"></a>7.1 实现RedisCache</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Cache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String CACHE_PREFIX = <span class="string">"cache:"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取授权缓存信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CacheException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K k)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        V v = (V) redisTemplate.opsForValue().get(CACHE_PREFIX + k);</span><br><span class="line">        <span class="keyword">if</span>(v != <span class="keyword">null</span>)&#123;</span><br><span class="line">            redisTemplate.expire(CACHE_PREFIX + k,<span class="number">15</span>, TimeUnit.MINUTES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存放缓存信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> v</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CacheException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K k, V v)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        redisTemplate.opsForValue().set(CACHE_PREFIX + k,v,<span class="number">15</span>,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空当前缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CacheException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(K k)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        V v = (V) redisTemplate.opsForValue().get(CACHE_PREFIX + k);</span><br><span class="line">        <span class="keyword">if</span>(v != <span class="keyword">null</span>)&#123;</span><br><span class="line">            redisTemplate.delete(CACHE_PREFIX + k);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清空全部的授权缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> CacheException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        Set keys = redisTemplate.keys(CACHE_PREFIX + <span class="string">"*"</span>);</span><br><span class="line">        redisTemplate.delete(keys);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查看有多个权限缓存信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set keys = redisTemplate.keys(CACHE_PREFIX + <span class="string">"*"</span>);</span><br><span class="line">        <span class="keyword">return</span> keys.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取全部缓存信息的key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keys</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set keys = redisTemplate.keys(CACHE_PREFIX + <span class="string">"*"</span>);</span><br><span class="line">        <span class="keyword">return</span> keys;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取全部缓存信息的value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set values = <span class="keyword">new</span> HashSet();</span><br><span class="line">        Set keys = redisTemplate.keys(CACHE_PREFIX + <span class="string">"*"</span>);</span><br><span class="line">        <span class="keyword">for</span> (Object key : keys) &#123;</span><br><span class="line">            Object value = redisTemplate.opsForValue().get(key);</span><br><span class="line">            values.add(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> values;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-实现CacheManager并测试"><a href="#7-2-实现CacheManager并测试" class="headerlink" title="7.2 实现CacheManager并测试"></a>7.2 实现CacheManager并测试</h4><p>实现CachaManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;K, V&gt; <span class="function">Cache&lt;K, V&gt; <span class="title">getCache</span><span class="params">(String s)</span> <span class="keyword">throws</span> CacheException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisCache;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将RedisCacheManager配置到SecurityManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">securityManager</span><span class="params">(ShiroRealm realm, SessionManager sessionManager, RedisCacheManager redisCacheManager)</span></span>&#123;</span><br><span class="line">    DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">    securityManager.setRealm(realm);</span><br><span class="line">    securityManager.setSessionManager(sessionManager);</span><br><span class="line">    <span class="comment">// 设置CacheManager，提供与Redis交互的Cache对象</span></span><br><span class="line">    securityManager.setCacheManager(redisCacheManager);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="八、Shiro整合CAS框架实现单点登录"><a href="#八、Shiro整合CAS框架实现单点登录" class="headerlink" title="八、Shiro整合CAS框架实现单点登录"></a>八、Shiro整合CAS框架实现单点登录</h3><h4 id="8-1-单点登录"><a href="#8-1-单点登录" class="headerlink" title="8.1 单点登录"></a>8.1 单点登录</h4><p>单点登录（Single Sign On），简称为 SSO，是比较流行的企业业务整合的解决方案之一。SSO的定义是在多个<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8/3994271" target="_blank" rel="noopener">应用</a>系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p>
<p>一般这种单点登录的实现方案，分为两种</p>
<p>中心化方式：<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/6229380e8e5e41bc9174cc3b8099520e.png" alt=" "></p>
<p><strong>去中心化方式：</strong><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/b56783849d044aabb22257756a717db7.png" alt="image.png"></p>
<p>去中心化方式：不存在单点故障，并且在访问时，可以减少网络IO所占用的时间，并且针对认证服务器没有请求压力。去中心化的方式，采用JWT实现。</p>
<p>中心化方式：存在单点故障，单台服务的访问压力较大，每次请求认证身份都需要访问认证服务器，导致压力相对比较大，效率也比较低。</p>
<p>咱们即将搞定的Shiro+CAS的方式，就是基于中心化实现的。</p>
<h4 id="8-2-CAS介绍-amp-搭建"><a href="#8-2-CAS介绍-amp-搭建" class="headerlink" title="8.2 CAS介绍&amp;搭建"></a>8.2 CAS介绍&amp;搭建</h4><h5 id="8-2-1-CAS介绍"><a href="#8-2-1-CAS介绍" class="headerlink" title="8.2.1 CAS介绍"></a>8.2.1 CAS介绍</h5><p>CAS是一个开源项目，CAS是应用于企业级别的单点登录的服务，CAS分为CAS Server，CAS Client</p>
<p>CAS Server是需要一个单独部署的Web工程</p>
<p>CAS Client是一个项目中的具体业务服务，并且在需要认证或授权时，找到CAS Server即可</p>
<p>整体CAS的认证和授权流程就是中心化的方式</p>
<h5 id="8-2-2-CAS搭建"><a href="#8-2-2-CAS搭建" class="headerlink" title="8.2.2 CAS搭建"></a>8.2.2 CAS搭建</h5><p>在知道CAS是什么内容后，第一步就是将CAS Server单独部署并运行起来</p>
<p>CAS Server的5.x版本更改为使用gradle构建，平时更多的是使用Maven，采用4.x版本、</p>
<p>采用CAS的4.x版本使用……</p>
<p>下载CAS：<a href="https://github.com/apereo/cas/archive/refs/tags/v4.1.10.zip" target="_blank" rel="noopener">https://github.com/apereo/cas/archive/refs/tags/v4.1.10.zip</a></p>
<p>使用IDEA打开CAS Server，并修改一些配置信息，将CAS Server进行打包，扔到Tomcat服务中运行</p>
<ul>
<li>采用IDEA打开CAS Server，并加载<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/1f25b2871cba4a86b9b1f1f25733fdc5.png" alt="image.png"></li>
<li>CAS Server默认只支持HTTPS，需要让CAS Server支持HTTP<ul>
<li>Apereo-10000002.json<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/f9c2b008d765462b9ea76bbcd8934ac6.png" alt="image.png"></li>
<li>HTTPSandIMAPS-10000001.json<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/cc6bcd2803554ad2872ecc4cd939789d.png" alt="image.png"></li>
<li>ticketGrantingTicketCookieGenerator.xml<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/44b9ea6c90454afdae4226e6198ed376.png" alt="image.png"></li>
<li>warnCookieGenerator.xml<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/f1ecaa75bd024c748ae1b6539ea666f7.png" alt="image.png"></li>
<li>deployerConfigContext.xml<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/2b74f104b8c64060a85b5c63b780d03a.png" alt="image.png"></li>
</ul>
</li>
<li>将项目进行打包，采用项目中的Maven插件，war的形式打包<ul>
<li>打包前，先将CAS Server进行compile，避免启动项目时，出现类路径下的配置文件无法找到</li>
<li>再执行plugins中提供的war:war执行打包</li>
</ul>
</li>
<li>将war包扔到Tomcat的webapps里，并运行即可</li>
<li>访问CAS Server首页，并且完成认证<ul>
<li>默认用户名&amp;密码<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/5811bbfd7215419ab3ccf5de2999bba6.png" alt="image.png"></li>
<li>访问首页测试<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/0a55b5e449cc4b75b160d2729baeb689.png" alt="image.png">)<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/277b5d8912254250b646f1bb08d4e7d9.png" alt="image.png"></li>
</ul>
</li>
</ul>
<h5 id="8-2-3-CAS连接数据库认证"><a href="#8-2-3-CAS连接数据库认证" class="headerlink" title="8.2.3 CAS连接数据库认证"></a>8.2.3 CAS连接数据库认证</h5><p>注释掉之前采用配置文件内认证的方式，修改为与数据库交互实现</p>
<ul>
<li>导入依赖<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--    mysql驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    druid连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    jdbc的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jasig.cas<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cas-server-support-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写配置<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--    数据源--&gt;</span><br><span class="line">&lt;bean id=<span class="string">"dataSource"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"driverClassName"</span> value=<span class="string">"com.mysql.jdbc.Driver"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"url"</span> value=<span class="string">"jdbc:mysql:///shiro-web"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"username"</span> value=<span class="string">"root"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"password"</span> value=<span class="string">"root"</span> /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;!--配置primaryAuthenticationHandler，QueryDatabaseAuthenticationHandler--&gt;</span><br><span class="line">&lt;bean id=<span class="string">"primaryAuthenticationHandler"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler"</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">"dataSource"</span> ref=<span class="string">"dataSource"</span> /&gt;</span><br><span class="line">    &lt;property name=<span class="string">"sql"</span> value=<span class="string">"select password from tb_user where username = ?"</span> /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></li>
<li>需要将webapp项目进行compile，然后再执行war:war</li>
<li>最终经过测试，得知，CAS Server在认证成功后，会给客户端返回一些TGC并写入浏览器的Cookie中，每次客户端携带者正确的TGC来访问时，就会与CAS Server端存储 的TGT进行配对，只要正确，证明认证成功，直接跳转到登录成功页面，否则跳转到登录页面</li>
</ul>
<h5 id="8-2-4-CAS实现对密码的加密-amp-加盐"><a href="#8-2-4-CAS实现对密码的加密-amp-加盐" class="headerlink" title="8.2.4 CAS实现对密码的加密&amp;加盐"></a>8.2.4 CAS实现对密码的加密&amp;加盐</h5><p>在实现CAS与数据库交互时，采用了QueryDatabaseAuthenticationHandler类实现。</p>
<p>同时这个类提供了一个属性passwordEncoder，可以基于passwordEncoder实现对密码进行加密校验。</p>
<p>但是基于咱们的业务，需要对密码进行加密和加盐的操作。</p>
<p>QueryDatabaseAuthenticationHandler无法实现业务需求。</p>
<p>需要参考QueryDatabaseAuthenticationHandler认证处理器去实现可以满足自身业务的认证处理器</p>
<p>需要实现属于自己的认证处理器：</p>
<ul>
<li>需要编写一个MD5HashQueryDatabaseAuthenticationHandler，去继承AbstractJdbcUsernamePasswordAuthenticationHandler<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author zjw</span><br><span class="line"> * @since 3.0</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class MD5HashQueryDatabaseAuthenticationHandler extends AbstractJdbcUsernamePasswordAuthenticationHandler &#123;</span><br><span class="line">    &#x2F;&#x2F; .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>声明saltSql，需要注入查询盐的SQL语句，在做密码校验时，需要先将用户输入的密码进行加密和加盐，然后再做比较<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to Apereo under one or more contributor license</span></span><br><span class="line"><span class="comment"> * agreements. See the NOTICE file distributed with this work</span></span><br><span class="line"><span class="comment"> * for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * Apereo licenses this file to you under the Apache License,</span></span><br><span class="line"><span class="comment"> * Version 2.0 (the "License"); you may not use this file</span></span><br><span class="line"><span class="comment"> * except in compliance with the License.  You may obtain a</span></span><br><span class="line"><span class="comment"> * copy of the License at the following location:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing,</span></span><br><span class="line"><span class="comment"> * software distributed under the License is distributed on an</span></span><br><span class="line"><span class="comment"> * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY</span></span><br><span class="line"><span class="comment"> * KIND, either express or implied.  See the License for the</span></span><br><span class="line"><span class="comment"> * specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment"> * under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">package</span> org.jasig.cas.adaptors.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.Md5Hash;</span><br><span class="line"><span class="keyword">import</span> org.jasig.cas.authentication.HandlerResult;</span><br><span class="line"><span class="keyword">import</span> org.jasig.cas.authentication.PreventedException;</span><br><span class="line"><span class="keyword">import</span> org.jasig.cas.authentication.UsernamePasswordCredential;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.DataAccessException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.dao.IncorrectResultSizeDataAccessException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.security.auth.login.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> javax.security.auth.login.FailedLoginException;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zjw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 3.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MD5HashQueryDatabaseAuthenticationHandler</span> <span class="keyword">extends</span> <span class="title">AbstractJdbcUsernamePasswordAuthenticationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String sql;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String saltSql;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer hashIterations = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> HandlerResult <span class="title">authenticateUsernamePasswordInternal</span><span class="params">(<span class="keyword">final</span> UsernamePasswordCredential credential)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> GeneralSecurityException, PreventedException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取用户输入的用户名</span></span><br><span class="line">        <span class="keyword">final</span> String username = credential.getUsername();</span><br><span class="line">        <span class="comment">// 获取用户输入的密码</span></span><br><span class="line">        <span class="keyword">final</span> String encryptedPassword = <span class="keyword">this</span>.getPasswordEncoder().encode(credential.getPassword());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 基于用户名查询数据库的密码</span></span><br><span class="line">            <span class="keyword">final</span> String dbPassword = getJdbcTemplate().queryForObject(<span class="keyword">this</span>.sql, String<span class="class">.<span class="keyword">class</span>, <span class="title">username</span>)</span>;</span><br><span class="line">            <span class="comment">// 基于用户名查询当前用户的salt</span></span><br><span class="line">            <span class="keyword">final</span> String salt = getJdbcTemplate().queryForObject(<span class="keyword">this</span>.saltSql, String<span class="class">.<span class="keyword">class</span>, <span class="title">username</span>)</span>;</span><br><span class="line">            <span class="comment">// 将用户输入的密码进行加密和加盐操作~</span></span><br><span class="line">            <span class="keyword">final</span> String password = <span class="keyword">new</span> Md5Hash(encryptedPassword, salt, hashIterations).toString();</span><br><span class="line">            <span class="comment">// 比较密码</span></span><br><span class="line">            <span class="keyword">if</span> (!dbPassword.equals(password)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(<span class="string">"Password does not match value on record."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IncorrectResultSizeDataAccessException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.getActualSize() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AccountNotFoundException(username + <span class="string">" not found with SQL query"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(<span class="string">"Multiple records found for "</span> + username);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> DataAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PreventedException(<span class="string">"SQL exception while executing query for "</span> + username, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createHandlerResult(credential, <span class="keyword">this</span>.principalFactory.createPrincipal(username), <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sql The sql to set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSql</span><span class="params">(<span class="keyword">final</span> String sql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sql = sql;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> saltSql The sql to set  -  select salt.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSaltSql</span><span class="params">(<span class="keyword">final</span> String saltSql)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.saltSql = saltSql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>回到webapp项目中，采用MD5HashQueryDatabaseAuthenticationHandler作为认证处理器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置primaryAuthenticationHandler，QueryDatabaseAuthenticationHandler--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.adaptors.jdbc.MD5HashQueryDatabaseAuthenticationHandler"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sql"</span> <span class="attr">value</span>=<span class="string">"select password from tb_user where username = ?"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"saltSql"</span> <span class="attr">value</span>=<span class="string">"select salt from tb_user where username = ?"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在第一次重新打包并发布时，出现了ClassNotFountException，需要将JDBC项目进行install操作，然后才可以对webapp重新war:war，然后才可以生效，避免出现ClassNotFountException</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/ccd9cd6b09c44ce5a6366fa23c2f6b4d.png" alt="image.png"></p>
<h4 id="8-3-Shiro-pac4j-CAS"><a href="#8-3-Shiro-pac4j-CAS" class="headerlink" title="8.3 Shiro + pac4j + CAS"></a>8.3 Shiro + pac4j + CAS</h4><h5 id="8-3-1-认证流程"><a href="#8-3-1-认证流程" class="headerlink" title="8.3.1 认证流程"></a>8.3.1 认证流程</h5><p>本质上和ShiroWeb的流程没有变化，只不过内部使用的一些Realm和过滤器交由pac4j提供</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/3f38b79dcb414bd487031e0b7a8482d2.png" alt="image.png"></p>
<h5 id="8-3-2-构建项目并设置配置信息"><a href="#8-3-2-构建项目并设置配置信息" class="headerlink" title="8.3.2 构建项目并设置配置信息"></a>8.3.2 构建项目并设置配置信息</h5><ul>
<li><p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.buji<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>buji-pac4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.pac4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pac4j-cas<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>配置Realm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Component</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasRealm</span> <span class="keyword">extends</span> <span class="title">Pac4jRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 授权操作，需要自己编写，并且也可以基于RedisSessionDAO实现缓存……</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> principals</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// do something , find DB or Cache</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ```java</span><br><span class="line">* 编写SecurityManager</span><br><span class="line">  ```java</span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> SubjectFactory <span class="title">subjectFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> Pac4jSubjectFactory();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">(CasRealm casRealm,SubjectFactory subjectFactory)</span></span>&#123;</span><br><span class="line">          DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">          securityManager.setRealm(casRealm);</span><br><span class="line">          securityManager.setSubjectFactory(subjectFactory);</span><br><span class="line">          <span class="keyword">return</span> securityManager;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>配置过滤器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  @Configuration</span><br><span class="line">  public class ShiroConfig &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">  &#x2F;**</span><br><span class="line">   * 配置核心过滤器</span><br><span class="line">   * @return</span><br><span class="line">   *&#x2F;</span><br><span class="line">  @Bean</span><br><span class="line">  public FilterRegistrationBean filterRegistrationBean()&#123;</span><br><span class="line">      FilterRegistrationBean filterRegistration &#x3D;new FilterRegistrationBean();</span><br><span class="line">      filterRegistration.setFilter(new DelegatingFilterProxy(&quot;shiroFilter&quot;));</span><br><span class="line">      filterRegistration.addUrlPatterns(&quot;&#x2F;*&quot;);</span><br><span class="line">      return filterRegistration;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>}</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* 配置ShiroFiler（ShiroConfig）</span><br><span class="line">  ```java</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * shiroFilter核心配置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilter</span><span class="params">(SecurityManager securityManager)</span></span>&#123;</span><br><span class="line">      ShiroFilterFactoryBean factoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">      factoryBean.setSecurityManager(securityManager);</span><br><span class="line">      putFilterChain(factoryBean);</span><br><span class="line">      <span class="keyword">return</span> factoryBean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putFilterChain</span><span class="params">(ShiroFilterFactoryBean factoryBean)</span> </span>&#123;</span><br><span class="line">      Map&lt;String,String&gt; filterChain = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">      <span class="comment">// 后面在声明好pac4j提供的过滤器后，需要重新设置！</span></span><br><span class="line">      filterChain.put(<span class="string">"/**"</span>,<span class="string">"anon"</span>);</span><br><span class="line">      factoryBean.setFilterChainDefinitionMap(filterChain);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>设置pac4j对CAS的设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pac4jConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cas.server.url:http://localhost:8080/cas&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String casServerUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cas.project.url:http://localhost:81&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String casProjectUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cas.clientName:test&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String clientName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心Config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> casClient</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Config <span class="title">config</span><span class="params">(CasClient casClient)</span></span>&#123;</span><br><span class="line">        Config config = <span class="keyword">new</span> Config(casClient);</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * casClient，主要设置回调</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> casConfiguration</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CasClient <span class="title">casClient</span><span class="params">(CasConfiguration casConfiguration)</span></span>&#123;</span><br><span class="line">        CasClient casClient = <span class="keyword">new</span> CasClient(casConfiguration);</span><br><span class="line">        <span class="comment">// 设置CAS访问后的回调地址</span></span><br><span class="line">        casClient.setCallbackUrl(casProjectUrl + <span class="string">"/callback?client_name="</span> + clientName);</span><br><span class="line">        casClient.setName(clientName);</span><br><span class="line">        <span class="keyword">return</span> casClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CAS服务地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CasConfiguration <span class="title">casConfiguration</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CasConfiguration casConfiguration = <span class="keyword">new</span> CasConfiguration();</span><br><span class="line">        <span class="comment">// 设置CAS登录页面</span></span><br><span class="line">        casConfiguration.setLoginUrl(casServerUrl + <span class="string">"/login"</span>);</span><br><span class="line">        <span class="comment">// 设置CAS协议</span></span><br><span class="line">        casConfiguration.setProtocol(CasProtocol.CAS20);</span><br><span class="line">        casConfiguration.setPrefixUrl(casServerUrl + <span class="string">"/"</span>);</span><br><span class="line">        casConfiguration.setAcceptAnyProxy(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> casConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>ShiroFilter二次配置（ShiroConfig）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * shiroFilter核心配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilter</span><span class="params">(SecurityManager securityManager, Config config)</span></span>&#123;</span><br><span class="line">    ShiroFilterFactoryBean factoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">    factoryBean.setSecurityManager(securityManager);</span><br><span class="line">    putFilterChain(factoryBean);</span><br><span class="line">    <span class="comment">// 后面在声明好pac4j提供的过滤器后</span></span><br><span class="line">    Map&lt;String, Filter&gt; filters = factoryBean.getFilters();</span><br><span class="line">    <span class="comment">//1. 准备SecurityFilter</span></span><br><span class="line">    SecurityFilter securityFilter = <span class="keyword">new</span> SecurityFilter();</span><br><span class="line">    securityFilter.setConfig(config);</span><br><span class="line">    securityFilter.setClients(clientName);</span><br><span class="line">    filters.put(<span class="string">"security"</span>,securityFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 设置回调的拦截器</span></span><br><span class="line">    CallbackFilter callbackFilter = <span class="keyword">new</span> CallbackFilter();</span><br><span class="line">    callbackFilter.setConfig(config);</span><br><span class="line">    callbackFilter.setDefaultUrl(casProjectUrl);</span><br><span class="line">    filters.put(<span class="string">"callback"</span>,callbackFilter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 退出登录</span></span><br><span class="line">    LogoutFilter logoutFilter = <span class="keyword">new</span> LogoutFilter();</span><br><span class="line">    logoutFilter.setConfig(config);</span><br><span class="line">    logoutFilter.setCentralLogout(<span class="keyword">true</span>);</span><br><span class="line">    logoutFilter.setLocalLogout(<span class="keyword">true</span>);</span><br><span class="line">    logoutFilter.setDefaultUrl(casProjectUrl + <span class="string">"/callback?client_name="</span> + clientName);</span><br><span class="line">    filters.put(<span class="string">"logout"</span>,logoutFilter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> factoryBean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putFilterChain</span><span class="params">(ShiroFilterFactoryBean factoryBean)</span> </span>&#123;</span><br><span class="line">    Map&lt;String,String&gt; filterChain = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 后面在声明好pac4j提供的过滤器后，需要重新设置！</span></span><br><span class="line"></span><br><span class="line">    filterChain.put(<span class="string">"/test"</span>,<span class="string">"security"</span>);</span><br><span class="line">    filterChain.put(<span class="string">"/logout"</span>,<span class="string">"logout"</span>);</span><br><span class="line">    filterChain.put(<span class="string">"/callback"</span>,<span class="string">"callback"</span>);</span><br><span class="line">    filterChain.put(<span class="string">"/**"</span>,<span class="string">"security"</span>);</span><br><span class="line">    factoryBean.setFilterChainDefinitionMap(filterChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="8-3-3-测试功能"><a href="#8-3-3-测试功能" class="headerlink" title="8.3.3 测试功能"></a>8.3.3 测试功能</h5><p>编写了一个Controller，并且要求当前/test地址，必须认证后才可以访问。</p>
<ul>
<li>访问/test资源后，直接跳转到了CAS登录页面</li>
<li>在CAS登录页面输入用户名和密码认证成功后，跳转到/test地址</li>
<li>再次访问/logout地址，发现退出登录成功后，留在了CAS的退出登录成功页面</li>
</ul>
<p>希望退出登录后，跳转到登录页面，并且避免出现401问题</p>
<p>需要配置两处位置：</p>
<ul>
<li>CASServer需要支持退出登录后的重定向<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1648209494089/9c3a7d5b69974482b768bff23baa236c.png" alt="image.png"></li>
<li>修改CasClient对象，页面在退出登录后，会出现401<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasClient</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">pac4j</span>.<span class="title">cas</span>.<span class="title">client</span>.<span class="title">CasClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CasClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CasClient</span><span class="params">(CasConfiguration configuration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(configuration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectAction <span class="title">getRedirectAction</span><span class="params">(<span class="keyword">final</span> WebContext context)</span> </span>&#123;</span><br><span class="line">        init();</span><br><span class="line">        AjaxRequestResolver ajaxRequestResolver = getAjaxRequestResolver();</span><br><span class="line">        RedirectActionBuilder redirectActionBuilder = getRedirectActionBuilder();</span><br><span class="line">        <span class="comment">// it's an AJAX request -&gt; appropriate action</span></span><br><span class="line">        <span class="keyword">if</span> (ajaxRequestResolver.isAjax(context)) &#123;</span><br><span class="line">            logger.info(<span class="string">"AJAX request detected -&gt; returning the appropriate action"</span>);</span><br><span class="line">            RedirectAction action = redirectActionBuilder.redirect(context);</span><br><span class="line">            cleanRequestedUrl(context);</span><br><span class="line">            <span class="keyword">return</span> ajaxRequestResolver.buildAjaxResponse(action.getLocation(), context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// authentication has already been tried -&gt; unauthorized</span></span><br><span class="line">        <span class="keyword">final</span> String attemptedAuth = (String) context.getSessionStore().get(context, getName() + ATTEMPTED_AUTHENTICATION_SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (CommonHelper.isNotBlank(attemptedAuth)) &#123;</span><br><span class="line">            cleanAttemptedAuthentication(context);</span><br><span class="line">            cleanRequestedUrl(context);</span><br><span class="line">            <span class="comment">// 跑抛出异常，页面401,只修改这个位置！！</span></span><br><span class="line">            <span class="comment">// throw HttpAction.unauthorized(context);</span></span><br><span class="line">            <span class="keyword">return</span> redirectActionBuilder.redirect(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redirectActionBuilder.redirect(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanRequestedUrl</span><span class="params">(<span class="keyword">final</span> WebContext context)</span> </span>&#123;</span><br><span class="line">        SessionStore&lt;WebContext&gt; sessionStore = context.getSessionStore();</span><br><span class="line">        <span class="keyword">if</span> (sessionStore.get(context, Pac4jConstants.REQUESTED_URL) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sessionStore.set(context, Pac4jConstants.REQUESTED_URL, <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanAttemptedAuthentication</span><span class="params">(<span class="keyword">final</span> WebContext context)</span> </span>&#123;</span><br><span class="line">        SessionStore&lt;WebContext&gt; sessionStore = context.getSessionStore();</span><br><span class="line">        <span class="keyword">if</span> (sessionStore.get(context, getName() + ATTEMPTED_AUTHENTICATION_SUFFIX) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sessionStore.set(context, getName() + ATTEMPTED_AUTHENTICATION_SUFFIX, <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>修改Pac4jConfig，将之前使用的默认CasClient更改为修改的这个！</li>
</ul>
<p>Reference: </p>
<p><a href="https://cloud.tencent.com/developer/article/1062698" target="_blank" rel="noopener">腾讯文档:Shiro</a></p>

    </div>



<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>


  
</div>




    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Brooks.H.Joshua
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://52zhongneng.cn/2020/04/13/Shiro/" title="Shiro框架简介">https://52zhongneng.cn/2020/04/13/Shiro/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Shiro/" rel="tag"><i class="fa fa-tag"></i>Shiro</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/13/Spring-security/" rel="prev" title="Spring Security OAuth2.0认证授权">
      <i class="fa fa-chevron-left"></i> Spring Security OAuth2.0认证授权
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/15/BugsCollection/" rel="next" title="BugsCollection">
      BugsCollection <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
 


 <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro"><span class="nav-number">1.</span> <span class="nav-text">Shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、现存问题"><span class="nav-number">1.0.1.</span> <span class="nav-text">一、现存问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-现存问题"><span class="nav-number">1.0.1.1.</span> <span class="nav-text">1.1 现存问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-Shiro框架介绍"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">1.2 Shiro框架介绍</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二、Shiro的基本使用"><span class="nav-number">1.0.2.</span> <span class="nav-text">二、Shiro的基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-SimpleAccountRealm"><span class="nav-number">1.0.2.1.</span> <span class="nav-text">2.1 SimpleAccountRealm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-IniRealm"><span class="nav-number">1.0.2.2.</span> <span class="nav-text">2.2 IniRealm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-JdbcRealm"><span class="nav-number">1.0.2.3.</span> <span class="nav-text">2.3 JdbcRealm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-CustomRealm（自定义Realm）"><span class="nav-number">1.0.2.4.</span> <span class="nav-text">2.4 CustomRealm（自定义Realm）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、Shiro的Web流程"><span class="nav-number">1.0.3.</span> <span class="nav-text">三、Shiro的Web流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、Shiro整合Web（SpringMVC，SpringBoot）"><span class="nav-number">1.0.4.</span> <span class="nav-text">四、Shiro整合Web（SpringMVC，SpringBoot）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-SSM方式"><span class="nav-number">1.0.4.1.</span> <span class="nav-text">4.1 SSM方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-SpringBoot方式"><span class="nav-number">1.0.4.2.</span> <span class="nav-text">4.2 SpringBoot方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#五、Shiro的授权方式"><span class="nav-number">1.0.5.</span> <span class="nav-text">五、Shiro的授权方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-过滤器链"><span class="nav-number">1.0.5.1.</span> <span class="nav-text">5.1 过滤器链</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-自定义过滤器"><span class="nav-number">1.0.5.2.</span> <span class="nav-text">5.2 自定义过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-注解"><span class="nav-number">1.0.5.3.</span> <span class="nav-text">5.3 注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-标签（前端，不玩，JSP、Freemarker、Thymeleaf）"><span class="nav-number">1.0.5.4.</span> <span class="nav-text">5.4 标签（前端，不玩，JSP、Freemarker、Thymeleaf）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-记住我"><span class="nav-number">1.0.5.5.</span> <span class="nav-text">5.5 记住我</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#六、Shiro的分布式Session的处理"><span class="nav-number">1.0.6.</span> <span class="nav-text">六、Shiro的分布式Session的处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-Shiro的Session管理"><span class="nav-number">1.0.6.1.</span> <span class="nav-text">6.1 Shiro的Session管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-Shiro解决分布式Session"><span class="nav-number">1.0.6.2.</span> <span class="nav-text">6.2 Shiro解决分布式Session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-实现Shiro的分布式Session处理"><span class="nav-number">1.0.6.3.</span> <span class="nav-text">6.3 实现Shiro的分布式Session处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-RedisSessionDAO问题"><span class="nav-number">1.0.6.4.</span> <span class="nav-text">6.4 RedisSessionDAO问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#七、Shiro的授权缓存"><span class="nav-number">1.0.7.</span> <span class="nav-text">七、Shiro的授权缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-实现RedisCache"><span class="nav-number">1.0.7.1.</span> <span class="nav-text">7.1 实现RedisCache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-实现CacheManager并测试"><span class="nav-number">1.0.7.2.</span> <span class="nav-text">7.2 实现CacheManager并测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#八、Shiro整合CAS框架实现单点登录"><span class="nav-number">1.0.8.</span> <span class="nav-text">八、Shiro整合CAS框架实现单点登录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-单点登录"><span class="nav-number">1.0.8.1.</span> <span class="nav-text">8.1 单点登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-CAS介绍-amp-搭建"><span class="nav-number">1.0.8.2.</span> <span class="nav-text">8.2 CAS介绍&amp;搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-1-CAS介绍"><span class="nav-number">1.0.8.2.1.</span> <span class="nav-text">8.2.1 CAS介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-2-CAS搭建"><span class="nav-number">1.0.8.2.2.</span> <span class="nav-text">8.2.2 CAS搭建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-3-CAS连接数据库认证"><span class="nav-number">1.0.8.2.3.</span> <span class="nav-text">8.2.3 CAS连接数据库认证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-4-CAS实现对密码的加密-amp-加盐"><span class="nav-number">1.0.8.2.4.</span> <span class="nav-text">8.2.4 CAS实现对密码的加密&amp;加盐</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-Shiro-pac4j-CAS"><span class="nav-number">1.0.8.3.</span> <span class="nav-text">8.3 Shiro + pac4j + CAS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-1-认证流程"><span class="nav-number">1.0.8.3.1.</span> <span class="nav-text">8.3.1 认证流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-2-构建项目并设置配置信息"><span class="nav-number">1.0.8.3.2.</span> <span class="nav-text">8.3.2 构建项目并设置配置信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-3-测试功能"><span class="nav-number">1.0.8.3.3.</span> <span class="nav-text">8.3.3 测试功能</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->



      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Brooks.H.Joshua"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Brooks.H.Joshua</p>
  <div class="site-description" itemprop="description">Less Is More</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://spring.io/blog" title="https:&#x2F;&#x2F;spring.io&#x2F;blog" rel="noopener" target="_blank">Spring官博</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">LeetCode</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.itboyhub.com/" title="http:&#x2F;&#x2F;www.itboyhub.com&#x2F;" rel="noopener" target="_blank">JavaBoy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" title="https:&#x2F;&#x2F;www.cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html" rel="noopener" target="_blank">DSV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://visualgo.net/zh" title="https:&#x2F;&#x2F;visualgo.net&#x2F;zh" rel="noopener" target="_blank">DV</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.apache.org/index.html#projects-list" title="http:&#x2F;&#x2F;www.apache.org&#x2F;index.html#projects-list" rel="noopener" target="_blank">Apache</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" rel="noopener" target="_blank">StackOverflow</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://metacademy.org/" title="https:&#x2F;&#x2F;metacademy.org&#x2F;" rel="noopener" target="_blank">Metacademy</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.alloyteam.com/nav/" title="http:&#x2F;&#x2F;www.alloyteam.com&#x2F;nav&#x2F;" rel="noopener" target="_blank">WebNav</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.36zhen.com/t?id=3448" title="http:&#x2F;&#x2F;www.36zhen.com&#x2F;t?id&#x3D;3448" rel="noopener" target="_blank">前端书籍资料</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://ife.baidu.com/" title="http:&#x2F;&#x2F;ife.baidu.com&#x2F;" rel="noopener" target="_blank">百度前端</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://wf.uisdc.com/cn/" title="http:&#x2F;&#x2F;wf.uisdc.com&#x2F;cn&#x2F;" rel="noopener" target="_blank">G前端开发基础</a>
        </li>
    </ul>
  </div>

     
	<!--网易云音乐-->
	  <div id="music163player">
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=1002994&auto=1&height=66"></iframe>
	  </div>
      </div>

    </div>
  </aside>

  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Brooks.H.Joshua</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">16:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.7.1
  </div>


        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>

</html>
